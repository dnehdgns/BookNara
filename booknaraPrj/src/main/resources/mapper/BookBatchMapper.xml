<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.booknara.booknaraPrj.bookAPI.mapper.BookBatchMapper">

    <insert id="insertBookIsbnTemp" parameterType="java.util.List">
        INSERT INTO BOOK_ISBN_TEMP
        (
        ISBN13,
        BOOK_TITLE,
        PUBLISHER,
        INFONARU_FETCHED_AT,
        STATUS_CD
        )
        VALUES
        <foreach collection="list" item="bookIsbnTemp" separator=",">
            (
            #{bookIsbnTemp.isbn13},
            #{bookIsbnTemp.bookTitle},
            #{bookIsbnTemp.publisher},
            #{bookIsbnTemp.infonaruFetchedAt},
            #{bookIsbnTemp.statusCd}
            )
        </foreach>
        ON DUPLICATE KEY UPDATE
        BOOK_TITLE          = COALESCE(VALUES(BOOK_TITLE), BOOK_TITLE),
        PUBLISHER           = COALESCE(VALUES(PUBLISHER), PUBLISHER),
        INFONARU_FETCHED_AT = VALUES(INFONARU_FETCHED_AT)
    </insert>


    <select id="selectTempIsbnForNaver" resultType="string">
        SELECT ISBN13
        FROM BOOK_ISBN_TEMP
        WHERE STATUS_CD = 0
        AND NAVER_RES_STATUS IN (0, 3)
        ORDER BY
        CASE WHEN NAVER_FETCHED_AT IS NULL THEN 0 ELSE 1 END,
        COALESCE(NAVER_FETCHED_AT, INFONARU_FETCHED_AT) ASC
        LIMIT #{limit}
    </select>

    <update id="updateTempNaverMeta">
        UPDATE BOOK_ISBN_TEMP
        SET
        NAVER_FETCHED_AT = #{naverFetchedAt},
        NAVER_RES_STATUS = #{naverResStatus}
        WHERE ISBN13 = #{isbn13}
    </update>

    <update id="updateTempFromNaver" parameterType="com.booknara.booknaraPrj.bookAPI.domain.BookIsbnTempDTO">
        UPDATE BOOK_ISBN_TEMP
        SET
        AUTHORS     = COALESCE(#{authors}, AUTHORS),
        DESCRIPTION = COALESCE(#{description}, DESCRIPTION),
        NAVER_IMAGE = COALESCE(#{naverImage}, NAVER_IMAGE)
        WHERE ISBN13 = #{isbn13}
    </update>


    <select id="selectTempIsbnForAladin" resultType="string">
        SELECT ISBN13
        FROM BOOK_ISBN_TEMP
        WHERE STATUS_CD = 0
        AND ALADIN_RES_STATUS IN (0, 3)
        ORDER BY
        CASE WHEN ALADIN_FETCHED_AT IS NULL THEN 0 ELSE 1 END,
        COALESCE(ALADIN_FETCHED_AT, NAVER_FETCHED_AT, INFONARU_FETCHED_AT) ASC
        LIMIT #{limit}
    </select>

    <update id="updateTempAladinMeta">
        UPDATE BOOK_ISBN_TEMP
        SET
        ALADIN_FETCHED_AT = #{aladinFetchedAt},
        ALADIN_RES_STATUS = #{aladinResStatus}
        WHERE ISBN13 = #{isbn13}
    </update>

    <update id="updateTempFromAladin" parameterType="com.booknara.booknaraPrj.bookAPI.domain.BookIsbnTempDTO">
        UPDATE BOOK_ISBN_TEMP
        SET
        PUBDATE          = COALESCE(#{pubdate}, PUBDATE),
        GENRE_ID         = COALESCE(NULLIF(#{genreId}, 0), GENRE_ID),
        ALADIN_IMAGE_BIG = COALESCE(#{aladinImageBig}, ALADIN_IMAGE_BIG),
        DESCRIPTION      = COALESCE(#{description}, DESCRIPTION)
        WHERE ISBN13 = #{isbn13}
    </update>


    <update id="updateTempDataHash">
        UPDATE BOOK_ISBN_TEMP
        SET DATA_HASH = #{dataHash}
        WHERE ISBN13 = #{isbn13}
    </update>

    <update id="markTempReady">
        UPDATE BOOK_ISBN_TEMP
        SET STATUS_CD = 1
        WHERE ISBN13 = #{isbn13}
        AND STATUS_CD = 0
    </update>

    <update id="markTempMerged">
        UPDATE BOOK_ISBN_TEMP
        SET STATUS_CD = 2
        WHERE ISBN13 = #{isbn13}
        AND STATUS_CD = 1
    </update>

    <select id="selectTempByIsbn13" resultType="com.booknara.booknaraPrj.bookAPI.domain.BookIsbnTempDTO">
        SELECT
        ISBN13              AS isbn13,
        BOOK_TITLE          AS bookTitle,
        AUTHORS             AS authors,
        PUBLISHER           AS publisher,
        GENRE_ID            AS genreId,
        DESCRIPTION         AS description,
        PUBDATE             AS pubdate,
        NAVER_IMAGE         AS naverImage,
        ALADIN_IMAGE_BIG    AS aladinImageBig,
        DATA_HASH           AS dataHash,
        INFONARU_FETCHED_AT AS infonaruFetchedAt,
        NAVER_FETCHED_AT    AS naverFetchedAt,
        ALADIN_FETCHED_AT   AS aladinFetchedAt,
        NAVER_RES_STATUS    AS naverResStatus,
        ALADIN_RES_STATUS   AS aladinResStatus,
        STATUS_CD           AS statusCd
        FROM BOOK_ISBN_TEMP
        WHERE ISBN13 = #{isbn13}
    </select>

    <select id="selectTempIsbnForMerge" resultType="string">
        SELECT ISBN13
        FROM BOOK_ISBN_TEMP
        WHERE STATUS_CD = 1
        AND GENRE_ID &gt; 0
        AND ALADIN_IMAGE_BIG IS NOT NULL
        AND LENGTH(TRIM(ALADIN_IMAGE_BIG)) &gt; 0
        ORDER BY COALESCE(ALADIN_FETCHED_AT, NAVER_FETCHED_AT, INFONARU_FETCHED_AT) ASC
        LIMIT #{limit}
    </select>

    <update id="rollbackTempReadyToPending">
        UPDATE BOOK_ISBN_TEMP
        SET STATUS_CD = 0
        WHERE ISBN13 = #{isbn13}
        AND STATUS_CD = 1
    </update>


    <insert id="upsertBookIsbnFromTemp">
        <![CDATA[
        INSERT INTO BOOK_ISBN
        (
            ISBN13, BOOK_TITLE, AUTHORS, DESCRIPTION, PUBLISHER,
            PUBDATE, NAVER_IMAGE, ALADIN_IMAGE_BIG, EBOOK_YN, EPUB,
            GENRE_ID, DATA_HASH
        )
        SELECT
            T.ISBN13, T.BOOK_TITLE, T.AUTHORS, T.DESCRIPTION, T.PUBLISHER,
            T.PUBDATE, T.NAVER_IMAGE, T.ALADIN_IMAGE_BIG, 'N', NULL,
            T.GENRE_ID, T.DATA_HASH
        FROM BOOK_ISBN_TEMP T
        WHERE T.ISBN13 = #{isbn13}
          AND T.STATUS_CD = 1
          AND T.GENRE_ID > 0
          AND T.ALADIN_IMAGE_BIG IS NOT NULL
          AND LENGTH(TRIM(T.ALADIN_IMAGE_BIG)) > 0
        ON DUPLICATE KEY UPDATE
            BOOK_TITLE       = IF(BOOK_ISBN.DATA_HASH <> VALUES(DATA_HASH), VALUES(BOOK_TITLE),       BOOK_ISBN.BOOK_TITLE),
            AUTHORS          = IF(BOOK_ISBN.DATA_HASH <> VALUES(DATA_HASH), VALUES(AUTHORS),          BOOK_ISBN.AUTHORS),
            DESCRIPTION      = IF(BOOK_ISBN.DATA_HASH <> VALUES(DATA_HASH), VALUES(DESCRIPTION),      BOOK_ISBN.DESCRIPTION),
            PUBLISHER        = IF(BOOK_ISBN.DATA_HASH <> VALUES(DATA_HASH), VALUES(PUBLISHER),        BOOK_ISBN.PUBLISHER),
            PUBDATE          = IF(BOOK_ISBN.DATA_HASH <> VALUES(DATA_HASH), VALUES(PUBDATE),          BOOK_ISBN.PUBDATE),
            NAVER_IMAGE      = IF(BOOK_ISBN.DATA_HASH <> VALUES(DATA_HASH), VALUES(NAVER_IMAGE),      BOOK_ISBN.NAVER_IMAGE),
            ALADIN_IMAGE_BIG = IF(BOOK_ISBN.DATA_HASH <> VALUES(DATA_HASH), VALUES(ALADIN_IMAGE_BIG), BOOK_ISBN.ALADIN_IMAGE_BIG),
            GENRE_ID         = IF(BOOK_ISBN.DATA_HASH <> VALUES(DATA_HASH), VALUES(GENRE_ID),         BOOK_ISBN.GENRE_ID),
            DATA_HASH        = IF(BOOK_ISBN.DATA_HASH <> VALUES(DATA_HASH), VALUES(DATA_HASH),        BOOK_ISBN.DATA_HASH),
            UPDATED_AT       = IF(BOOK_ISBN.DATA_HASH <> VALUES(DATA_HASH), CURRENT_TIMESTAMP,        BOOK_ISBN.UPDATED_AT);
        ]]>
    </insert>

</mapper>