<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.booknara.booknaraPrj.report.mapper.ReportMapper">

    <!-- ✅ (신고 대상(feed) 유효성 확인: 존재 + 리뷰 + 미삭제 -->
    <select id="existsActiveReviewFeed" resultType="int">
        SELECT CASE WHEN EXISTS (
            SELECT 1
            FROM FEEDS
            WHERE FEED_ID = #{feedId}
              AND FEED_CATEGORY = 'REVIEW'
              AND IS_DELETED = 'N'
        ) THEN 1 ELSE 0 END
    </select>

    <!-- ✅ 이미 신고했는지 -->
    <select id="existsReport" resultType="int">
        SELECT CASE WHEN EXISTS (
            SELECT 1
            FROM REPORT
            WHERE USER_ID = #{userId}
              AND FEED_ID = #{feedId}
              AND REPORT_TYPE = 'FEED'
        ) THEN 1 ELSE 0 END
    </select>

    <!-- ✅ 신고 등록 -->
    <insert id="insertReport">
        INSERT INTO REPORT (
            REPORT_ID,
            USER_ID,
            FEED_ID,
            REPORT_TYPE,
            REPORT_CONTENT,
            REPORTED_AT,
            REPORT_STATE
        ) VALUES (
                     #{reportId},
                     #{userId},
                     #{feedId},
                     'FEED',
                     #{reportContent},
                     NOW(),
                     'PENDING'
                 )
    </insert>

    <!-- ✅ 신고 대상(feed)의 소유자 userId 조회 -->
    <select id="selectFeedOwnerUserId" resultType="string">
        SELECT USER_ID
        FROM FEEDS
        WHERE FEED_ID = #{feedId}
          AND FEED_CATEGORY = 'REVIEW'
            LIMIT 1
    </select>


</mapper>
