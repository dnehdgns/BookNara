<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.booknara.booknaraPrj.bookcirculation.command.mapper.BookCommandMapper">

    <select id="selectUserBlockedYn" resultType="string">
        SELECT CASE WHEN USER_STATE IN (3,4) THEN 'Y' ELSE 'N' END
        FROM USERS
        WHERE USER_ID = #{userId}
    </select>

    <select id="selectUserOverdueYn" resultType="string">
        SELECT CASE WHEN EXISTS (
            SELECT 1
            FROM LENDS
            WHERE USER_ID = #{userId}
              AND RETURN_DONE_AT IS NULL
              AND OVER_DUE = 'Y'
        ) THEN 'Y' ELSE 'N' END
    </select>

    <select id="existsActiveLendByUserAndIsbn" resultType="int">
        SELECT CASE WHEN EXISTS (
            SELECT 1
            FROM LENDS
            WHERE USER_ID = #{userId}
              AND ISBN13 = #{isbn13}
              AND RETURN_DONE_AT IS NULL
        ) THEN 1 ELSE 0 END
    </select>

    <select id="selectAvailableBookIdForUpdate" resultType="long">
        SELECT B.BOOK_ID
        FROM BOOKS B
        WHERE B.ISBN13 = #{isbn13}
          AND B.BOOK_STATE = 'N'
          AND NOT EXISTS (
            SELECT 1
            FROM LENDS L
            WHERE L.BOOK_ID = B.BOOK_ID
              AND L.RETURN_DONE_AT IS NULL
        )
        ORDER BY B.BOOK_ID ASC
            LIMIT 1
        FOR UPDATE
    </select>


    <!--도서 대여-->
    <insert id="insertLend">
        INSERT INTO LENDS (
            LEND_ID,
            BOOK_ID,
            USER_ID,
            ISBN13,
            OVER_DUE,
            LEND_DATE,
            RETURN_DUE_DATE,
            EXTEND_CNT,
            DELIVERY_STATUS,
            CREATED_AT
        ) VALUES (
                     #{lendId},
                     #{bookId},
                     #{userId},
                     #{isbn13},
                     'N',
                     NOW(),
                     (NOW() + INTERVAL 14 DAY),
                     0,
                     'NONE',
                     NOW()
                 )
    </insert>

    <update id="extendIfAllowed">
        UPDATE LENDS
        SET
            RETURN_DUE_DATE = (RETURN_DUE_DATE + INTERVAL 7 DAY),
            EXTEND_CNT      = 1,
            UPDATED_AT      = NOW()
        WHERE LEND_ID = #{lendId}
          AND USER_ID = #{userId}
          AND RETURN_DONE_AT IS NULL
          AND EXTEND_CNT = 0
          AND RETURN_DUE_DATE &lt;= (NOW() + INTERVAL 7 DAY)
    </update>

    <select id="countActiveReservations" resultType="int">
        SELECT COUNT(*)
        FROM RESERVATIONS
        WHERE ISBN13 = #{isbn13}
          AND ACTIVE_FLAG = 1
    </select>

    <insert id="insertReservation">
        INSERT INTO RESERVATIONS (
            RSV_ID,
            USER_ID,
            ISBN13,
            RSV_DATE,
            RSV_STATUS,
            CREATED_AT
        ) VALUES (
                     #{rsvId},
                     #{userId},
                     #{isbn13},
                     NOW(),
                     'ACTIVE',
                     NOW()
                 )
    </insert>

    <update id="cancelReservation">
        UPDATE RESERVATIONS
        SET
            RSV_STATUS   = 'CANCELLED',
            CANCELLED_AT = NOW(),
            UPDATED_AT   = NOW()
        WHERE RSV_ID = #{rsvId}
          AND USER_ID = #{userId}
          AND RSV_STATUS IN ('ACTIVE','HOLD')
    </update>

    <update id="markReturnBox">
        UPDATE LENDS
        SET
            BOX_ID        = #{boxId},
            RETURN_BOX_AT = NOW(),
            UPDATED_AT    = NOW()
        WHERE LEND_ID = #{lendId}
          AND USER_ID = #{userId}
          AND RETURN_DONE_AT IS NULL
    </update>

    <update id="confirmReturn">
        UPDATE LENDS
        SET
            RETURN_DONE_AT = NOW(),
            OVER_DUE       = 'N',
            UPDATED_AT     = NOW()
        WHERE LEND_ID = #{lendId}
          AND USER_ID = #{userId}
          AND RETURN_DONE_AT IS NULL
    </update>

    <select id="selectMaxLendCount" resultType="int">
        SELECT MAX_LEND_COUNT
        FROM SETTINGS
        ORDER BY SETTINGS_ID DESC
            LIMIT 1
    </select>

    <select id="countMyActiveLends" resultType="int">
        SELECT COUNT(*)
        FROM LENDS
        WHERE USER_ID = #{userId}
          AND RETURN_DONE_AT IS NULL
    </select>



</mapper>