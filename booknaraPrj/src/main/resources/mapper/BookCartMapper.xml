<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.booknara.booknaraPrj.bookcart.mapper.BookCartMapper">

    <insert id="insert">
        INSERT IGNORE INTO BOOKS_CART (
            USER_ID,
            ISBN13
        )
        VALUES (
        #{userId},
        #{isbn13}
        )
    </insert>

    <delete id="delete">
        DELETE FROM BOOKS_CART
        WHERE USER_ID = #{userId}
          AND CART_ID = #{cartId}
    </delete>

    <delete id="deleteByIsbn">
        DELETE FROM BOOKS_CART
        WHERE USER_ID = #{userId}
          AND ISBN13 = #{isbn13}
    </delete>

    <delete id="deleteAll">
        DELETE FROM BOOKS_CART
        WHERE USER_ID = #{userId}
    </delete>

    <select id="selectList" resultType="com.booknara.booknaraPrj.bookcart.dto.BookCartDTO">
        SELECT
            C.CART_ID           AS cartId,
            BI.ISBN13           AS isbn13,
            BI.BOOK_TITLE       AS bookTitle,
            BI.AUTHORS          AS authors,
            BI.ALADIN_IMAGE_BIG AS aladinImageBig,
            BI.NAVER_IMAGE      AS naverImage,
            BI.EBOOK_YN         AS ebookYn
        FROM BOOKS_CART C
                 JOIN BOOK_ISBN BI ON BI.ISBN13 = C.ISBN13
        WHERE C.USER_ID = #{userId}
        ORDER BY C.CREATED_AT DESC
    </select>

    <select id="countMyCart" resultType="int">
        SELECT COUNT(*)
        FROM BOOKS_CART C
                 JOIN BOOK_ISBN BI ON BI.ISBN13 = C.ISBN13
        WHERE C.USER_ID = #{userId}
    </select>

    <select id="countMyActiveLends" resultType="int">
        SELECT COUNT(*)
        FROM LENDS
        WHERE USER_ID = #{userId}
          AND RETURN_DONE_AT IS NULL
    </select>

    <select id="selectMaxLendCount" resultType="int">
        SELECT MAX_LEND_COUNT
        FROM SETTINGS
        ORDER BY SETTINGS_ID DESC
            LIMIT 1
    </select>

    <select id="isLendableByIsbn" resultType="boolean">
        SELECT
            CASE
                WHEN
                    (
                        SELECT COUNT(*)
                        FROM BOOKS B
                        WHERE B.ISBN13 = #{isbn13}
                          AND B.BOOK_STATE = 'N'
                    )
                        >
                    (
                        SELECT COUNT(*)
                        FROM LENDS L
                                 JOIN BOOKS B2 ON B2.BOOK_ID = L.BOOK_ID
                        WHERE B2.ISBN13 = #{isbn13}
                          AND L.RETURN_DONE_AT IS NULL
                    )
                    THEN TRUE
                ELSE FALSE
                END
    </select>

    <select id="existsByIsbn" resultType="int">
        SELECT COUNT(*)
        FROM BOOKS_CART
        WHERE USER_ID = #{userId}
          AND ISBN13  = #{isbn13}
    </select>

    <select id="selectMyDefaultAddress"
            parameterType="string"
            resultType="com.booknara.booknaraPrj.bookcart.dto.UserAddressDTO">
        SELECT
            ZIPCODE     AS zipcode,
            ADDR        AS addr,
            DETAIL_ADDR AS detailAddr
        FROM USERS
        WHERE USER_ID = #{userId}
    </select>

    <update id="updateMyDefaultAddress"
            parameterType="com.booknara.booknaraPrj.bookcart.dto.UserAddressDTO">
        UPDATE USERS
        SET
            ZIPCODE     = #{zipcode},
            ADDR        = #{addr},
            DETAIL_ADDR = #{detailAddr},
            UPDATED_AT  = NOW()
        WHERE USER_ID = #{userId}
    </update>

    <insert id="insertDelivery">
        INSERT INTO DELIVERY_H (
            LEND_ID,
            CREATED_AT
        ) VALUES (
                     #{lendId},
                     NOW()
                 )
    </insert>



</mapper>