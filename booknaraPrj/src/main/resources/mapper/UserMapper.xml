<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.booknara.booknaraPrj.login_signup.mapper.UserMapper">

<resultMap id="UserResultMap" type="com.booknara.booknaraPrj.login_signup.User">
    <id property="userId" column="USER_ID"/>

    <result property="userNm" column="USER_NM"/>
    <result property="profileNm" column="PROFILE_NM"/>
    <result property="profileImg" column="PROFILE_IMG"/>
    <result property="useImg" column="USE_IMG"/>

    <result property="password" column="PASSWORD"/>
    <result property="gender" column="GENDER"/>
    <result property="birthday" column="BIRTHDAY"/>

    <result property="addr" column="ADDR"/>
    <result property="detailAddr" column="DETAIL_ADDR"/>
    <result property="zipcode" column="ZIPCODE"/>

    <result property="extraInfoDone" column="EXTRA_INFO_DONE"/>

    <result property="phoneNo" column="PHONE_NO"/>
    <result property="email" column="EMAIL"/>
    <result property="smsYn" column="SMS_YN"/>

    <result property="userRole" column="USER_ROLE"/>
    <result property="userState" column="USER_STATE"/>

    <result property="createdAt" column="CREATED_AT"/>
    <result property="updatedAt" column="UPDATED_AT"/>
    <result property="lastLoginAt" column="LAST_LOGIN_AT"/>
</resultMap>

<!--회원가입insert-->
<insert id="insertUser" parameterType="com.booknara.booknaraPrj.login_signup.User">
INSERT INTO USERS (
USER_ID, USER_NM, PROFILE_NM, PASSWORD,
GENDER, BIRTHDAY,
ADDR, DETAIL_ADDR, ZIPCODE,
PHONE_NO, EMAIL, SMS_YN,
USER_ROLE, USER_STATE, USE_IMG
) VALUES (
#{userId}, #{userNm}, #{profileNm}, #{password},
#{gender}, #{birthday},
#{addr}, #{detailAddr}, #{zipcode},
#{phoneNo}, #{email}, #{smsYn},
#{userRole}, #{userState}, #{useImg}
)
</insert>

<!--로그인용 조회-->
<select id="findByUserId" resultMap="UserResultMap">
SELECT *
FROM USERS
WHERE USER_ID = #{userId}
</select>

<!--아이디,닉네임 중복체크-->
<select id="countByUserId" resultType="int">
SELECT COUNT(*)
FROM USERS
WHERE USER_ID = #{userId}
</select>

<select id="countByProfileNm" resultType="int">
SELECT COUNT(*)
FROM USERS
WHERE PROFILE_NM = #{profileNm}
</select>

    <select id="findByEmail"
            parameterType="String"
            resultMap="UserResultMap">
        SELECT *
        FROM users
        WHERE email = #{email}
    </select>

    <select id="countByEmail" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM USERS
        WHERE EMAIL = #{email}
    </select>


    <!--소셜로그인-->
    <select id="existsByUserId"
            parameterType="String"
            resultType="boolean">
        SELECT COUNT(*) > 0
        FROM USERS
        WHERE USER_ID = #{userId}
    </select>

    <select id="existsByProfileNm"
            parameterType="String"
            resultType="boolean">
        SELECT COUNT(*) > 0
        FROM users
        WHERE profile_nm = #{nickname}
    </select>

    <update id="updateExtraInfoDone">
        UPDATE users
        SET EXTRA_INFO_DONE = 'Y'
        WHERE USER_ID = #{userId}
    </update>

    <update id="updateAddress">
        UPDATE users
        SET
        ZIPCODE = #{zipcode},
        ADDR = #{addr},
        DETAIL_ADDR = #{detailAddr}
        WHERE USER_ID = #{userId}
    </update>


    <select id="findLocalUserIdByNameAndEmail" resultType="string">
        SELECT USER_ID
        FROM USERS
        WHERE USER_NM = #{name}
        AND EMAIL = #{email}
        AND PASSWORD NOT LIKE '{noop}%'
        LIMIT 1
    </select>

    <!-- ✅ 비밀번호 찾기 1단계: 로컬 계정 존재 여부 확인 -->
    <select id="countByUserIdAndEmail" resultType="int">
        SELECT COUNT(*)
        FROM USERS
        WHERE USER_ID = #{userId}
        AND EMAIL = #{email}
    </select>

    <!-- ✅ 비밀번호 업데이트 -->
    <update id="updatePassword">
        UPDATE USERS
        SET PASSWORD = #{password}
        WHERE USER_ID = #{userId}
    </update>

    <!--비밀번호 업데이트-->
    <select id="findPasswordByUserId" resultType="string">
        SELECT PASSWORD
        FROM USERS
        WHERE USER_ID = #{userId}
    </select>
</mapper>