<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.booknara.booknaraPrj.recommend.mapper.RecommendMapper">


    <!--성별,연령-->
    <select id="selectAgeGenderTopBooks" resultType="map">
        WITH user_segment AS (
        SELECT
        u.USER_ID,
        u.GENDER,
        TIMESTAMPDIFF(YEAR, u.BIRTHDAY, CURDATE()) AS AGE,
        CASE
        WHEN TIMESTAMPDIFF(YEAR, u.BIRTHDAY, CURDATE()) BETWEEN 10 AND 19 THEN 10
        WHEN TIMESTAMPDIFF(YEAR, u.BIRTHDAY, CURDATE()) BETWEEN 20 AND 29 THEN 20
        WHEN TIMESTAMPDIFF(YEAR, u.BIRTHDAY, CURDATE()) BETWEEN 30 AND 39 THEN 30
        WHEN TIMESTAMPDIFF(YEAR, u.BIRTHDAY, CURDATE()) BETWEEN 40 AND 49 THEN 40
        WHEN TIMESTAMPDIFF(YEAR, u.BIRTHDAY, CURDATE()) BETWEEN 50 AND 59 THEN 50
        WHEN TIMESTAMPDIFF(YEAR, u.BIRTHDAY, CURDATE()) BETWEEN 60 AND 69 THEN 60
        ELSE NULL
        END AS AGE_GROUP
        FROM USERS u
        ),
        lend_stat AS (
        SELECT
        us.AGE_GROUP,
        us.GENDER,
        l.ISBN13,
        COUNT(*) AS LEND_CNT
        FROM LENDS l
        JOIN user_segment us ON us.USER_ID = l.USER_ID
        WHERE us.AGE_GROUP IS NOT NULL
        GROUP BY us.AGE_GROUP, us.GENDER, l.ISBN13
        ),
        ranked AS (
        SELECT
        ls.*,
        ROW_NUMBER() OVER (
        PARTITION BY ls.AGE_GROUP, ls.GENDER
        ORDER BY ls.LEND_CNT DESC, ls.ISBN13
        ) AS RN
        FROM lend_stat ls
        )
        SELECT
        r.AGE_GROUP,
        r.GENDER,
        b.ISBN13,
        b.BOOK_TITLE
        FROM ranked r
        JOIN BOOK_ISBN b ON b.ISBN13 = r.ISBN13
        WHERE r.RN <![CDATA[<=]]> 6
        ORDER BY r.AGE_GROUP, r.GENDER, r.LEND_CNT DESC
    </select>

    <!--대여순-->
    <select id="selectTopRentalBooks"
            resultType="com.booknara.booknaraPrj.recommend.dto.RentalTopDto">

        SELECT
        b.ISBN13        AS isbn13,
        b.BOOK_TITLE    AS bookTitle,
        b.AUTHORS       AS authors,
        b.PUBLISHER     AS publisher,
        COALESCE(b.NAVER_IMAGE, b.ALADIN_IMAGE_BIG) AS bookImg,
        COUNT(*)        AS rentCnt
        FROM LENDS l
        JOIN BOOK_ISBN b
        ON l.ISBN13 = b.ISBN13
        GROUP BY
        b.ISBN13,
        b.BOOK_TITLE,
        b.AUTHORS,
        b.PUBLISHER,
        b.NAVER_IMAGE,
        b.ALADIN_IMAGE_BIG
        ORDER BY rentCnt DESC
        LIMIT 6

    </select>

    <select id="selectMonthlyBestSeller"
            resultType="com.booknara.booknaraPrj.recommend.dto.RentalTopDto">

        SELECT
        b.ISBN13        AS isbn13,
        b.BOOK_TITLE    AS bookTitle,
        b.AUTHORS       AS authors,
        b.PUBLISHER     AS publisher,
        COALESCE(b.NAVER_IMAGE, b.ALADIN_IMAGE_BIG) AS bookImg,
        COUNT(*)        AS rentCnt
        FROM LENDS l
        JOIN BOOK_ISBN b
        ON l.ISBN13 = b.ISBN13
        WHERE l.LEND_DATE >= DATE_SUB(NOW(), INTERVAL 1 MONTH)
        GROUP BY
        b.ISBN13,
        b.BOOK_TITLE,
        b.AUTHORS,
        b.PUBLISHER,
        b.NAVER_IMAGE,
        b.ALADIN_IMAGE_BIG
        ORDER BY rentCnt DESC
        LIMIT 6

    </select>


</mapper>
