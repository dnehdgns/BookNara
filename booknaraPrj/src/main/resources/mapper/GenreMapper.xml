<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.booknara.booknaraPrj.bookSearch.mapper.GenreMapper">

    <select id="selectParentGenresAuto" resultType="com.booknara.booknaraPrj.bookSearch.dto.GenreDTO">
        SELECT
            P.GENRE_ID AS genreId,
            CASE
                WHEN P.GENRE_NM LIKE '\\_%' ESCAPE '\\'
                    THEN SUBSTRING(P.GENRE_NM, 2)
                ELSE P.GENRE_NM
                END        AS genreNm,
            NULL       AS parentId,
            '국내도서' AS mall
        FROM (
                 SELECT B.GENRE_ID, COUNT(*) AS CNT
                 FROM BOOK_ISBN B
                 GROUP BY B.GENRE_ID
             ) X
                 JOIN GENRE C ON C.GENRE_ID = X.GENRE_ID
                 JOIN GENRE P ON P.GENRE_ID = C.PARENT_ID
        WHERE C.MALL = '국내도서'
          AND C.PARENT_ID IS NOT NULL
        GROUP BY P.GENRE_ID, P.GENRE_NM
        HAVING SUM(X.CNT) >= #{min}
        ORDER BY SUM(X.CNT) DESC
            LIMIT #{top}
    </select>


    <select id="selectChildGenresAuto"
            resultType="com.booknara.booknaraPrj.bookSearch.dto.GenreDTO">
        SELECT
            C.GENRE_ID AS genreId,
            CASE
                WHEN C.GENRE_NM LIKE '\\_%' ESCAPE '\\'
                    THEN SUBSTRING(C.GENRE_NM, 2)
                ELSE C.GENRE_NM
                END        AS genreNm,
            C.PARENT_ID AS parentId,
            C.MALL      AS mall
        FROM GENRE C
        WHERE C.MALL = '국내도서'
          AND C.PARENT_ID = #{parentId}
          AND EXISTS (
            SELECT 1
            FROM BOOK_ISBN B
            WHERE B.GENRE_ID = C.GENRE_ID
        )
        ORDER BY C.GENRE_ID
    </select>


    <select id="selectForeignParentGenresAuto"
            resultType="com.booknara.booknaraPrj.bookSearch.dto.GenreDTO">
        SELECT
            P.GENRE_ID AS genreId,
            CASE
                WHEN P.GENRE_NM LIKE '\\_%' ESCAPE '\\'
                    THEN SUBSTRING(P.GENRE_NM, 2)
                ELSE P.GENRE_NM
                END        AS genreNm,
            NULL       AS parentId,
            '외국도서' AS mall
        FROM BOOK_ISBN B
                 JOIN GENRE C ON C.GENRE_ID = B.GENRE_ID
                 JOIN GENRE P ON P.GENRE_ID = COALESCE(C.PARENT_ID, C.GENRE_ID)
        WHERE C.MALL = '외국도서'
        GROUP BY P.GENRE_ID, P.GENRE_NM
        HAVING COUNT(*) &gt;= #{min}
        ORDER BY COUNT(*) DESC
            LIMIT #{top}
    </select>

</mapper>