<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.booknara.booknaraPrj.bookSearch.mapper.GenreMapper">


    <select id="selectParentGenresAuto" resultType="com.booknara.booknaraPrj.bookSearch.dto.GenreDTO">
        SELECT
            p.GENRE_ID AS genreId,
            CASE
                WHEN p.GENRE_NM LIKE '\\_%' ESCAPE '\\'
                    THEN SUBSTRING(p.GENRE_NM, 2)
                ELSE p.GENRE_NM
                END AS genreNm,
            NULL AS parentId,
            '국내도서' AS mall
        FROM (
                 SELECT b.GENRE_ID, COUNT(*) AS CNT
                 FROM BOOK_ISBN b
                 GROUP BY b.GENRE_ID
             ) x
                 JOIN GENRE c ON c.GENRE_ID = x.GENRE_ID
                 JOIN GENRE p ON p.GENRE_ID = c.PARENT_ID
        WHERE c.MALL = '국내도서'
          AND c.PARENT_ID IS NOT NULL
        GROUP BY p.GENRE_ID, p.GENRE_NM
        HAVING SUM(x.CNT) >= #{min}
        ORDER BY SUM(x.CNT) DESC
            LIMIT #{top};
    </select>



    <select id="selectChildGenresAuto"
            resultType="com.booknara.booknaraPrj.bookSearch.dto.GenreDTO">
        SELECT
            c.GENRE_ID AS genreId,
            CASE
                WHEN c.GENRE_NM LIKE '\\_%' ESCAPE '\\'
                    THEN SUBSTRING(c.GENRE_NM, 2)
                ELSE c.GENRE_NM
                END AS genreNm,
            c.PARENT_ID AS parentId,
            c.MALL AS mall
        FROM GENRE c
        WHERE c.MALL = '국내도서'
          AND c.PARENT_ID = #{parentId}
          AND EXISTS (
            SELECT 1
            FROM BOOK_ISBN b
            WHERE b.GENRE_ID = c.GENRE_ID
        )
        ORDER BY c.GENRE_ID
    </select>


    <select id="selectForeignParentGenresAuto"
            resultType="com.booknara.booknaraPrj.bookSearch.dto.GenreDTO">
        SELECT
            p.GENRE_ID AS genreId,
            CASE
                WHEN p.GENRE_NM LIKE '\\_%' ESCAPE '\\' THEN SUBSTRING(p.GENRE_NM, 2)
                ELSE p.GENRE_NM
                END AS genreNm,
            NULL AS parentId,
            '외국도서' AS mall
        FROM BOOK_ISBN b
                 JOIN GENRE c
                      ON c.GENRE_ID = b.GENRE_ID
                 JOIN GENRE p
                      ON p.GENRE_ID = COALESCE(c.PARENT_ID, c.GENRE_ID)
        WHERE c.MALL = '외국도서'
        GROUP BY p.GENRE_ID, p.GENRE_NM
        HAVING COUNT(*) &gt;= #{min}
        ORDER BY COUNT(*) DESC
            LIMIT #{top}
    </select>
</mapper>
