<th:block th:fragment="content" xmlns:th="http://www.thymeleaf.org">

  <!-- 다음 주소 API -->
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

  <!-- 내정보 JS (수정/저장/장르 통합 제어) -->
  <script src="/js/myinfo.js" defer></script>

  <!-- ================= 회원 정보 ================= -->
  <section class="info-section">

    <div class="section-header">
      <h3>회원 정보</h3>
      <div class="btn-group">
        <button type="button" class="btn btn-outline" id="pwChangeBtn">비밀번호 변경</button>
        <button type="button" class="btn btn-primary" id="editBtn">수정</button>
      </div>
    </div>

    <form class="info-form"
          th:action="@{/mypage/myinfo/update}"
          method="post">

    <input type="hidden" name="userId" th:value="${myInfo.userId}"/>

      <div class="form-row">
        <label>성명</label>
        <input type="text" th:value="${myInfo.userNm}" disabled/>
      </div>

      <div class="form-row">
        <label>아이디</label>
        <input type="text" th:value="${myInfo.userId}" disabled/>
      </div>

      <div class="form-row">
        <label>프로필명</label>

        <input type="text"
               id="profileNm"
               name="profileNm"
               th:value="${myInfo.profileNm}"
               class="editable"
               disabled/>

        <input type="hidden"
               id="originalProfileNm"
               th:value="${myInfo.profileNm}">

        <span id="profileNmMsg" class="input-msg"></span>
      </div>


      <div class="form-row">
        <label>생년월일</label>
        <input type="date" th:value="${myInfo.birthday}" disabled/>
      </div>

      <div class="form-row">
        <label>성별</label>
        <input type="text" th:value="${myInfo.gender}" disabled/>
      </div>

      <div class="form-row">
        <label>주소</label>
        <div class="address-row">
          <input type="text"
                 name="zipcode"
                 th:value="${myInfo.zipcode}"
                 class="editable"
                 disabled
                 placeholder="우편번호"/>

          <input type="text"
                 name="addr"
                 th:value="${myInfo.addr}"
                 class="editable"
                 disabled
                 placeholder="주소"/>

          <button type="button"
                  class="btn btn-outline small"
                  id="addressBtn"
                  onclick="execDaumPostcode()"
                  disabled>
            주소변경
          </button>
        </div>
      </div>

      <div class="form-row">
        <label>상세주소</label>
        <input type="text"
               name="detailAddr"
               th:value="${myInfo.detailAddr}"
               class="editable"
               disabled
               placeholder="상세주소"/>
      </div>

      <div class="form-row">
        <label>선호하는 장르 <br>
                (최대 3개) </label>


      <div class="genre-grid">

        <div class="genre-card disabled"
             data-genre-id="1"
             data-editable="false"
             th:classappend="${#lists.contains(userGenres, 1)} ? ' active' : ''">
          소설
        </div>

        <div class="genre-card disabled"
             data-genre-id="55889"
             data-editable="false"
             th:classappend="${#lists.contains(userGenres, 55889)} ? ' active' : ''">
          에세이
        </div>

        <div class="genre-card disabled"
             data-genre-id="336"
             data-editable="false"
             th:classappend="${#lists.contains(userGenres, 336)} ? ' active' : ''">
          자기계발
        </div>

        <div class="genre-card disabled"
             data-genre-id="656"
             data-editable="false"
             th:classappend="${#lists.contains(userGenres, 656)} ? ' active' : ''">
          인문
        </div>

        <div class="genre-card disabled"
             data-genre-id="74"
             data-editable="false"
             th:classappend="${#lists.contains(userGenres, 74)} ? ' active' : ''">
          사회·역사
        </div>

        <div class="genre-card disabled"
             data-genre-id="170"
             data-editable="false"
             th:classappend="${#lists.contains(userGenres, 170)} ? ' active' : ''">
          경제·경영
        </div>

        <div class="genre-card disabled"
             data-genre-id="987"
             data-editable="false"
             th:classappend="${#lists.contains(userGenres, 987)} ? ' active' : ''">
          과학
        </div>

        <div class="genre-card disabled"
             data-genre-id="517"
             data-editable="false"
             th:classappend="${#lists.contains(userGenres, 517)} ? ' active' : ''">
          예술·취미
        </div>

        <div class="genre-card disabled"
             data-genre-id="1108"
             data-editable="false"
             th:classappend="${#lists.contains(userGenres, 1108)} ? ' active' : ''">
          아동·청소년
        </div>

      </div>
      </div>
      <!-- ✅ 저장 버튼 (회원정보 + 장르 공용, 하나만 존재) -->
      <div class="form-row right">
        <button type="submit"
                class="btn btn-primary"
                id="saveBtn"
                style="display:none;">
          저장
        </button>
      </div>

    </form>
  </section>


    <!-- ================= 비밀번호 변경 모달 ================= -->
    <div class="pw-modal-overlay" id="pwModal">
        <div class="pw-modal">

            <h3 class="pw-modal-title">비밀번호 변경</h3>

            <!-- 현재 비밀번호 -->
            <div class="pw-row">
                <label class="pw-input-wrap">현재 비밀번호</label>
                <div class="pw-input-group">
                    <input type="password" id="currentPw" placeholder="현재 비밀번호 입력">
                    <button type="button" class="btn btn-outline small" id="verifyPwBtn">
                        확인
                    </button>
                </div>
                <p class="pw-msg" id="currentPwMsg"></p>
            </div>

            <!-- 새 비밀번호 -->
            <div class="pw-row">
                <label class="pw-input-wrap">새 비밀번호</label>
                <input type="password"
                       id="newPw"
                       disabled
                       placeholder="영문·숫자·특수문자 포함 8~16자">
                <p class="pw-msg" id="newPwMsg"></p>
            </div>

            <!-- 새 비밀번호 확인 -->
            <div class="pw-row">
                <label class="pw-input-wrap">새 비밀번호 확인</label>
                <input type="password"
                       id="newPwConfirm"
                       disabled>
                <p class="pw-msg" id="newPwConfirmMsg"></p>
            </div>

            <!-- 버튼 -->
            <div class="pw-modal-actions">
                <button type="button" class="btn btn-outline" id="pwCancelBtn">취소</button>
                <button type="button" class="btn btn-primary" id="pwSubmitBtn" disabled>
                    변경하기
                </button>
            </div>

        </div>
    </div>

  </section>


<!--
<script th:src="@{/js/signup-extra.js}"></script>
-->

    <!-- ================= Bootpay ================= -->
<script src="https://js.bootpay.co.kr/bootpay-4.2.0.min.js"></script>

<!-- ================= 로그인 사용자 정보 (안전하게) ================= -->
  <script th:inline="javascript">
    const loginUser = {
      id: [[${loginUser != null ? loginUser.userId : ''}]],
    username: [[${loginUser != null ? loginUser.username : ''}]]
    };
  </script>


<!-- ================= 로그인 체크 + 결제 버튼 연결 ================= -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (!loginUser.id || loginUser.id.trim() === "") {
        alert("로그인이 필요합니다.");
        location.href = "/login";
        return;
      }

      const payBtn = document.getElementById("payBtn");
      if (payBtn) {
        payBtn.style.display = "inline-block";
        payBtn.addEventListener("click", requestPayment);
      }
    });

    function requestPayment() {
      const username =
              (loginUser.username && loginUser.username.trim() !== "")
                      ? loginUser.username
                      : loginUser.id;

      Bootpay.requestPayment({
        application_id: "696053425fd7d0429f0ad118",
        price: 3000,
        order_name: "도서 배송비",
        order_id: "ORDER_" + Date.now(),
        user: {
          id: loginUser.id,
          username: username
        }
      })
              .then(function (response) {
                // ✅ 결제 완료 시점
                alert("결제 완료");

                const receiptId =
                        response?.receipt_id ||
                        response?.receipt_data?.receipt_id ||
                        null;

                // ✅ 서버에 결제 완료 저장 요청
                fetch("/payment/complete", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify({
                    userId: loginUser.id,
                    receiptId: receiptId
                  })
                });
              })
              .catch(function (e) {
                console.error("Bootpay error:", e);
                alert("결제 중 오류가 발생했습니다.");
              });
    }
  </script>

</th:block>