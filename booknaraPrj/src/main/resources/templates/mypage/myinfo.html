<th:block th:fragment="content" xmlns:th="http://www.thymeleaf.org">

<!-- 다음 주소 API -->
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

  <!-- myinfo js -->
  <script src="/js/myinfo.js" defer></script>


  <!-- ===== 우측 콘텐츠 영역 ===== -->
  <main class="content">

    <!-- ===== 회원 정보 ===== -->
    <section class="info-section">
      <div class="section-header">
        <h3>회원 정보</h3>
        <div class="btn-group">
          <button type="button" class="btn btn-outline">비밀번호 변경</button>
          <button type="button" class="btn btn-primary" id="editBtn">수정</button>
        </div>
      </div>

      <!-- ✅ (Spring Security 사용 중이면 CSRF 필요할 수 있음) -->
      <form class="info-form" th:action="@{/mypage/myinfo/update}" method="post">
        <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"> -->

        <input type="hidden" name="userId" th:value="${myInfo.userId}" />

        <div class="form-row">
          <label>성명</label>
          <input type="text" th:value="${myInfo.userNm}" disabled />
        </div>

        <div class="form-row">
          <label>아이디</label>
          <input type="text" th:value="${myInfo.userId}" disabled />
        </div>

        <div class="form-row">
          <label>프로필명</label>
          <input type="text" name="profileNm"
                 th:value="${myInfo.profileNm}"
                 disabled class="editable" />
        </div>

        <div class="form-row">
          <label>생년월일</label>
          <input type="date" th:value="${myInfo.birthday}" disabled />
        </div>

        <div class="form-row">
          <label>성별</label>
          <input type="text" th:value="${myInfo.gender}" disabled />
        </div>

        <div class="form-row">
          <label>주소</label>
          <div class="address-row">
            <input type="text" name="addr"
                   th:value="${myInfo.addr}"
                   disabled class="editable" />
            <button type="button"
                    class="btn btn-outline small"
                    id="addressBtn"
                    onclick="execDaumPostcode()"
                    disabled>
              주소변경
            </button>
          </div>
        </div>

        <div class="form-row right">
          <button type="submit" class="btn btn-primary"
                  id="saveBtn" style="display:none;">
            저장
          </button>
        </div>
      </form>
    </section>
<button id="payBtn" style="display:none;" type="button">
  결제하기
</button>

  </main>
</div>




<!-- ================= Bootpay ================= -->
<script src="https://js.bootpay.co.kr/bootpay-4.2.0.min.js"></script>

<!-- ================= 로그인 사용자 정보 (안전하게) ================= -->
  <script th:inline="javascript">
    const loginUser = {
      id: [[${loginUser != null ? loginUser.userId : ''}]],
    username: [[${loginUser != null ? loginUser.username : ''}]]
    };
  </script>


<!-- ================= 로그인 체크 + 결제 버튼 연결 ================= -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (!loginUser.id || loginUser.id.trim() === "") {
        alert("로그인이 필요합니다.");
        location.href = "/login";
        return;
      }

      const payBtn = document.getElementById("payBtn");
      if (payBtn) {
        payBtn.style.display = "inline-block";
        payBtn.addEventListener("click", requestPayment);
      }
    });

    function requestPayment() {
      const username =
              (loginUser.username && loginUser.username.trim() !== "")
                      ? loginUser.username
                      : loginUser.id;

      Bootpay.requestPayment({
        application_id: "696053425fd7d0429f0ad118",
        price: 3000,
        order_name: "도서 배송비",
        order_id: "ORDER_" + Date.now(),
        user: {
          id: loginUser.id,
          username: username
        }
      })
              .then(function (response) {
                // ✅ 결제 완료 시점
                alert("결제 완료");

                const receiptId =
                        response?.receipt_id ||
                        response?.receipt_data?.receipt_id ||
                        null;

                // ✅ 서버에 결제 완료 저장 요청
                fetch("/payment/complete", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify({
                    userId: loginUser.id,
                    receiptId: receiptId
                  })
                });
              })
              .catch(function (e) {
                console.error("Bootpay error:", e);
                alert("결제 중 오류가 발생했습니다.");
              });
    }
  </script>

</th:block>