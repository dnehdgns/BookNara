<th:block th:fragment="content" xmlns:th="http://www.thymeleaf.org">

<div class="mypage-container">

    <!-- ìƒë‹¨ íƒ­ -->
    <div class="mypage-tabs">
        <a th:href="@{/my/booklist}" class="mypage-tab"
           th:classappend="${activeTab=='rent'} ? ' active' : ''">ëŒ€ì—¬</a>
        <a th:href="@{/my/reserve}" class="mypage-tab"
           th:classappend="${activeTab=='reserve'} ? ' active' : ''">ì˜ˆì•½</a>
        <a th:href="@{/my/bookmark}" class="mypage-tab"
           th:classappend="${activeTab=='bookmark'} ? ' active' : ''">ë¶ë§ˆí¬</a>
    </div>

    <!-- í˜„ì¬ ëŒ€ì—¬ì¤‘ -->
    <div class="section">
        <div class="section-title">
            ëŒ€ì—¬ì¤‘ :
            <span th:text="${#lists.size(currentLends)}">0</span>
        </div>

        <div th:if="${#lists.isEmpty(currentLends)}">
            í˜„ì¬ ëŒ€ì—¬ ì¤‘ì¸ ë„ì„œê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>

        <div class="book-list" th:if="${!#lists.isEmpty(currentLends)}">
            <div class="book-card" th:each="book : ${currentLends}">
                <img class="book-img rent-img"
                     th:src="${book.coverImg}"
                     th:data-lend-id="${book.lendId}"
                     th:data-title="${book.bookTitle}"
                     th:data-authors="${book.authors}"
                     th:data-rent-date="${#temporals.format(book.lendDate,'yyyy-MM-dd')}"
                     th:data-return-date="${#temporals.format(book.returnDueDate,'yyyy-MM-dd')}"
                     th:data-overdue="${book.overDue}"
                     th:data-img="${book.coverImg}">



                <div class="book-title" th:text="${book.bookTitle}"></div>

                <div class="book-meta">
                    ë°˜ë‚©ì˜ˆì •ì¼ :
                    <span th:text="${#temporals.format(book.returnDueDate,'yyyy-MM-dd')}"></span>
                </div>

                <div class="book-btns">
                    <button type="button"
                            th:data-lend-id="${book.lendId}"
                            onclick="returnBook(this)">
                        ë°˜ë‚©
                    </button>
                    <button type="button"
                            th:if="${book.extendCnt == null || book.extendCnt == 0}"
                            th:data-lend-id="${book.lendId}"
                            onclick="extendBook(this)">
                        ì—°ì¥
                    </button>

                    <!-- (ì„ íƒ) ì´ë¯¸ ì—°ì¥í•œ ì±…ì´ë©´ í…ìŠ¤íŠ¸ë§Œ ë³´ì—¬ì£¼ê¸° -->
                    <span class="book-meta"
                          th:if="${book.extendCnt != null && book.extendCnt > 0}">
    ì—°ì¥ ì™„ë£Œ
</span>

                </div>
            </div>
        </div>
    </div>

    <!-- ëŒ€ì—¬ ê¸°ë¡ -->
    <div class="section">
        <div class="section-title">ëŒ€ì—¬ ê¸°ë¡</div>

        <div th:if="${historyGroups == null or #maps.isEmpty(historyGroups)}">
            ëŒ€ì—¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>

        <div th:each="entry : ${historyGroups}">
            <div class="date-title"
                 th:text="${#temporals.format(entry.key,'yyyy-MM-dd')}"></div>

            <div class="book-list">
                <div class="book-card" th:each="book : ${entry.value}">
                    <img class="book-img" th:src="${book.coverImg}">
                    <div class="book-title" th:text="${book.bookTitle}"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ===== ëŒ€ì—¬ ìƒì„¸ ëª¨ë‹¬ ===== -->
<div id="rentModal" class="modal hidden">
    <div class="modal-content">
        <span class="modal-close" onclick="closeRentModal()">Ã—</span>

        <div class="modal-body">
            <img id="modalImg">

            <div class="modal-info">
                <h3 id="modalTitle"></h3>
                <p id="modalAuthor"></p>

                <p>ëŒ€ì—¬ì¼ : <span id="modalRentDate"></span></p>
                <p>ë°˜ë‚©ì˜ˆì •ì¼ : <span id="modalReturnDate"></span></p>

                <!-- ğŸ”¥ ëŒ€ì—¬ ê¸°ê°„ ì§„í–‰ë°” -->
                <div class="rent-progress">
                    <div class="rent-bar" id="rentBar"></div>
                </div>
                <p class="overdue-text hidden" id="overdueText">âš  ì—°ì²´ëœ ë„ì„œì…ë‹ˆë‹¤</p>

                <div class="modal-btns">
                    <button class="btn-orange" id="extendBtn" onclick="modalExtend()">ì—°ì¥</button>
                    <button class="btn-blue" id="returnBtn" onclick="modalReturn()">ë°˜ë‚©</button>
                </div>
            </div>

        </div>
    </div>
</div>



<script>
    function returnBook(btn) {
        const lendId = btn.dataset.lendId;
        if (!confirm("ë°˜ë‚©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch("/my/lend/return", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "lendId=" + lendId
        }).then(res => {
            if (res.ok) location.reload();
            else alert("ë°˜ë‚© ì‹¤íŒ¨");
        });
    }

    function extendBook(btn) {
        const lendId = btn.dataset.lendId;
        if (!confirm("7ì¼ ì—°ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch("/my/lend/extend", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "lendId=" + lendId
        }).then(res => {
            if (res.ok) location.reload();
            else alert("ì—°ì¥ ì‹¤íŒ¨ (ì´ë¯¸ ì—°ì¥í–ˆì„ ìˆ˜ ìˆìŒ)");
        });
    }
</script>
<script>
    let modalLendId = null;

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".rent-img").forEach(img => {
            img.addEventListener("click", () => openRentModal(img));
        });
    });

    function openRentModal(img) {
        modalLendId = img.dataset.lendId;

        const rentDate = new Date(img.dataset.rentDate);
        const returnDate = new Date(img.dataset.returnDate);
        const today = new Date();
        const overDue = img.dataset.overdue === 'Y';

        document.getElementById("modalImg").src = img.dataset.img;
        document.getElementById("modalTitle").innerText = img.dataset.title;
        document.getElementById("modalAuthor").innerText = img.dataset.authors || '';
        document.getElementById("modalRentDate").innerText = img.dataset.rentDate;
        document.getElementById("modalReturnDate").innerText = img.dataset.returnDate;

        /* ===== ì§„í–‰ë¥  ===== */
        const total = returnDate - rentDate;
        const passed = Math.min(Math.max(today - rentDate, 0), total);
        const percent = Math.round((passed / total) * 100);

        const bar = document.getElementById("rentBar");
        bar.style.width = percent + "%";

        const extendBtn = document.getElementById("extendBtn");
        const overdueText = document.getElementById("overdueText");

        if (overDue) {
            bar.classList.add("overdue");
            extendBtn.disabled = true;
            overdueText.classList.remove("hidden");
        } else {
            bar.classList.remove("overdue");
            extendBtn.disabled = false;
            overdueText.classList.add("hidden");
        }

        document.getElementById("rentModal").classList.remove("hidden");
    }

    function closeRentModal() {
        document.getElementById("rentModal").classList.add("hidden");
    }

    function modalReturn() {
        returnBook({ dataset: { lendId: modalLendId } });
    }

    function modalExtend() {
        extendBook({ dataset: { lendId: modalLendId } });
    }
</script>


</th:block>>