<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>도서 검색</title>

    <style>
        body { margin:0; font-family: Arial, sans-serif; background:#fafafa; }
        .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; display:flex; gap:16px; }

        /* 좌측 카테고리 */
        .left {
            width: 240px;
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            padding: 12px;
            height: fit-content;
        }
        .left h3 { margin: 0 0 10px; font-size: 16px; }

        /* 카테고리 리스트 */
        .cat-box { margin-top: 10px; }
        .cat-title { font-size: 13px; font-weight: 700; margin: 10px 0 6px; color:#111; }
        .cat-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px; }
        .cat-item {
            padding: 8px 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            background:#fafafa;
            cursor:pointer;
            font-size: 13px;
            color:#333;
            line-height: 1.2;
            user-select:none;
        }
        .cat-item:hover { background:#f0f0f0; }
        .cat-item.active {
            background:#111;
            color:#fff;
            border-color:#111;
        }
        /* 외국도서 가상 카테고리 강조(선택) */
        .cat-item.foreign { border-style: dashed; }

        .cat-actions { display:flex; gap:8px; margin-top: 10px; }
        .cat-actions button{
            flex:1;
            padding:8px 10px;
            border-radius:8px;
            border:1px solid #ddd;
            background:#fff;
            cursor:pointer;
            font-size: 12px;
        }
        .cat-actions button.primary{
            background:#111;
            color:#fff;
            border-color:#111;
        }

        /* 중앙 컨텐츠 */
        .center { flex:1; }

        /* 상단 검색/필터 바 */
        .toolbar {
            background:#fff;
            border:1px solid #e5e5e5;
            border-radius:10px;
            padding:12px;
            display:flex;
            gap:10px;
            align-items:center;
            flex-wrap: wrap;
        }
        .toolbar input[type="text"] {
            flex:1;
            min-width: 220px;
            padding:10px 12px;
            border:1px solid #ddd;
            border-radius: 8px;
            outline: none;
        }
        .toolbar select, .toolbar button {
            padding:10px 12px;
            border:1px solid #ddd;
            border-radius: 8px;
            background:#fff;
            cursor:pointer;
        }
        .toolbar button { background:#111; color:#fff; border-color:#111; }

        /* 결과 헤더 */
        .result-head {
            margin: 14px 0 10px;
            display:flex;
            justify-content: space-between;
            align-items:center;
            color:#333;
        }
        .result-head .meta { font-size: 13px; color:#666; }
        .result-head .meta b { color:#111; }

        /* 카드 그리드 */
        .grid {
            display:grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 14px;
        }
        @media (max-width: 1200px) { .grid { grid-template-columns: repeat(4, 1fr);} }
        @media (max-width: 992px)  { .grid { grid-template-columns: repeat(3, 1fr);} }
        @media (max-width: 768px)  { .wrap { flex-direction: column; } .left { width:auto; } .grid { grid-template-columns: repeat(2, 1fr);} }
        @media (max-width: 480px)  { .grid { grid-template-columns: 1fr;} }

        .card {
            background:#fff;
            border:1px solid #e5e5e5;
            border-radius: 12px;
            overflow:hidden;
            cursor:pointer;
            position: relative;
            transition: transform .12s ease;
            min-height: 320px;
        }
        .card:hover { transform: translateY(-2px); }
        .thumb {
            width:100%;
            height: 200px;
            background:#f3f3f3;
            display:flex;
            align-items:center;
            justify-content:center;
            overflow:hidden;
            position: relative;
        }
        .thumb img { width:100%; height:100%; object-fit: cover; display:block; }

        .info { padding: 10px 10px 12px; }
        .title { font-size: 13px; font-weight: 700; color:#111; line-height: 1.3; height: 34px; overflow:hidden; }
        .sub { font-size: 12px; color:#666; margin-top: 6px; height: 30px; overflow:hidden; line-height:1.25; }
        .badge {
            display:inline-block;
            margin-top: 8px;
            font-size: 11px;
            padding: 4px 7px;
            border-radius: 999px;
            border: 1px solid #ddd;
            color:#444;
        }

        /* 호버 설명 */
        .hover-desc {
            position:absolute;
            inset: 0;
            background: rgba(0,0,0,0.78);
            color:#fff;
            padding: 12px;
            opacity: 0;
            transition: opacity .15s ease;
            display:flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        .card:hover .hover-desc { opacity: 1; }
        .hover-desc .desc {
            font-size: 12px;
            line-height: 1.35;
            max-height: 110px;
            overflow:hidden;
            display:-webkit-box;
            -webkit-line-clamp: 6;
            -webkit-box-orient: vertical;
        }

        /* 페이지네이션 */
        .pager {
            margin: 18px 0 8px;
            display:flex;
            justify-content:center;
            gap:6px;
            flex-wrap: wrap;
        }
        .pager button {
            min-width: 36px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            background:#fff;
            border-radius: 8px;
            cursor:pointer;
        }
        .pager button.active {
            background:#111;
            color:#fff;
            border-color:#111;
        }
        .pager button:disabled {
            opacity: .5;
            cursor:not-allowed;
        }

        .loading {
            margin: 18px 0;
            text-align:center;
            color:#666;
            font-size: 14px;
        }
    </style>
</head>

<body>
<div class="wrap">

    <!-- 좌측 카테고리 -->
    <aside class="left">
        <h3>카테고리</h3>

        <div class="cat-actions">
            <button id="btnAll" class="primary">전체</button>
        </div>

        <div class="cat-box">
            <div class="cat-title">대분류</div>
            <ul id="parentGenreList" class="cat-list"></ul>
        </div>

        <div class="cat-box">
            <div class="cat-title">소분류</div>
            <ul id="childGenreList" class="cat-list">
                <li style="font-size:12px; color:#777; padding:6px 2px;">대분류를 선택하세요</li>
            </ul>
        </div>
    </aside>

    <main class="center">

        <!-- 검색/필터 바 -->
        <div class="toolbar">
            <input id="keyword" type="text" placeholder="검색어를 입력하세요 (제목/저자/출판사)" />

            <select id="field">
                <option value="ALL">전체</option>
                <option value="TITLE">제목</option>
                <option value="AUTHOR">저자</option>
                <option value="PUBLISHER">출판사</option>
            </select>

            <select id="sort">
                <option value="NEW">최신순</option>
                <option value="RATING">평점순(뼈대)</option>
                <option value="REVIEW">리뷰순(뼈대)</option>
            </select>

            <select id="ebookYn">
                <option value="ALL">전체</option>
                <option value="N">종이책</option>
                <option value="Y">전자책</option>
            </select>

            <select id="size">
                <option value="20" selected>20개</option>
                <option value="40">40개</option>
                <option value="60">60개</option>
            </select>

            <button id="btnSearch">검색</button>
        </div>

        <!-- 결과 정보 -->
        <div class="result-head">
            <div class="meta">
                총 <b id="total">0</b>건 · <span id="pageInfo">page 1</span>
            </div>
            <div class="meta" id="currentGenre"></div>
        </div>

        <div id="loading" class="loading" style="display:none;">불러오는 중...</div>

        <!-- 카드 그리드 -->
        <section id="grid" class="grid"></section>

        <!-- 페이지네이션 -->
        <nav id="pager" class="pager"></nav>

    </main>
</div>

<script>
    // ====== API 엔드포인트 ======
    const API_URL = "/book/search/list"; // 컨트롤러에 맞춤
    const GENRE_API = "/book/genres";

    // ====== 상태 ======
    const state = {
        page: 1,
        size: 20,
        keyword: null,
        field: "ALL",
        sort: "NEW",
        ebookYn: "ALL",
        genreId: null,
        parentGenreId: null,
        mall: "ALL"
    };

    // ====== DOM ======
    const $keyword = document.getElementById("keyword");
    const $field   = document.getElementById("field");
    const $sort    = document.getElementById("sort");
    const $ebookYn = document.getElementById("ebookYn");
    const $size    = document.getElementById("size");
    const $btn     = document.getElementById("btnSearch");

    const $grid    = document.getElementById("grid");
    const $pager   = document.getElementById("pager");
    const $total   = document.getElementById("total");
    const $pageInfo= document.getElementById("pageInfo");
    const $loading = document.getElementById("loading");

    const $parentList = document.getElementById("parentGenreList");
    const $childList  = document.getElementById("childGenreList");
    const $currentGenre = document.getElementById("currentGenre");

    const $btnAll = document.getElementById("btnAll");

    // ====== 유틸 ======
    function esc(s) {
        if (s == null) return "";
        return String(s)
            .replaceAll("&","&amp;")
            .replaceAll("<","&lt;")
            .replaceAll(">","&gt;")
            .replaceAll('"',"&quot;")
            .replaceAll("'","&#39;");
    }

    function buildQuery() {
        const p = new URLSearchParams();

        p.set("page", String(state.page));
        p.set("size", String(state.size));

        if (state.keyword) p.set("keyword", state.keyword);
        if (state.field) p.set("field", state.field);
        if (state.sort) p.set("sort", state.sort);
        if (state.ebookYn) p.set("ebookYn", state.ebookYn);

        if (state.genreId !== null && state.genreId !== undefined) {
            p.set("genreId", String(state.genreId));
        }
        if (state.parentGenreId !== null && state.parentGenreId !== undefined) {
            p.set("parentGenreId", String(state.parentGenreId));
        }

        if (state.mall !== null && state.mall !== undefined && state.mall !== "") {
            p.set("mall", state.mall);
        }

        return p.toString();
    }



    // ====== 카테고리 공통 ======
    function clearActive(listEl) {
        listEl.querySelectorAll(".cat-item.active").forEach(el => el.classList.remove("active"));
    }

    function setCurrentGenreText() {
        const parentActive = $parentList.querySelector(".cat-item.active");
        const childActive  = $childList.querySelector(".cat-item.active");

        if (childActive) {
            $currentGenre.textContent = `선택: ${childActive.textContent}`;
        } else if (parentActive) {
            $currentGenre.textContent = `선택: ${parentActive.textContent}`;
        } else {
            $currentGenre.textContent = "";
        }
    }

    function renderForeignRowAtBottomIfMissing(list) {
        const hasForeign = (list || []).some(x => (x && x.genreNm) === "외국도서");
        if (hasForeign) return list;

        const copy = Array.isArray(list) ? [...list] : [];
        copy.push({ genreId: null, genreNm: "외국도서" });
        return copy;
    }

    // ✅ 외국도서 대분류(top 19 + 기타)를 "소분류 영역"에 뿌리는 함수
    async function loadForeignParentsAsChildren() {
        $childList.innerHTML = `<li style="font-size:12px;color:#777;padding:6px 2px;">불러오는 중...</li>`;

        const res = await fetch(`${GENRE_API}/foreign/parents?top=19`, {
            headers: { "Accept": "application/json" }
        });
        if (!res.ok) throw new Error("Foreign parents HTTP " + res.status);

        const list = await res.json();

        if (!list || list.length === 0) {
            $childList.innerHTML = `<li style="font-size:12px;color:#777;padding:6px 2px;">외국도서 카테고리가 없습니다</li>`;
            return;
        }

        $childList.innerHTML = "";

        list.forEach(g => {
            const li = document.createElement("li");
            li.className = "cat-item";
            li.textContent = g.genreNm;

            li.addEventListener("click", () => {
                clearActive($childList);
                li.classList.add("active");

                state.mall = "외국도서";

                const raw = g.genreId;
                if (raw === null || raw === undefined || raw === "") {
                    state.parentGenreId = null;
                } else {
                    state.parentGenreId = parseInt(raw, 10); // 0 / -1 모두 OK
                }

                state.genreId = null;
                state.page = 1;

                setCurrentGenreText();

                load();
            });


            $childList.appendChild(li);
        });
    }


    async function loadParentGenres() {
        const res = await fetch(`${GENRE_API}/parents`, { headers: { "Accept": "application/json" }});
        if (!res.ok) throw new Error("Parent genre HTTP " + res.status);
        let list = await res.json();

        list = renderForeignRowAtBottomIfMissing(list);

        $parentList.innerHTML = "";

        list.forEach(g => {
            const li = document.createElement("li");
            li.className = "cat-item";
            li.textContent = g.genreNm;

            if (g.genreNm === "외국도서") {
                li.classList.add("foreign");
                li.dataset.genreId = "";
            } else {
                li.dataset.genreId = g.genreId;
            }

            // ✅ 외국도서 클릭 시: 외국도서 대분류를 소분류 영역에 로드
            li.addEventListener("click", async () => {
                clearActive($parentList);
                li.classList.add("active");

                state.page = 1;
                clearActive($childList);

                if (g.genreNm === "외국도서") {
                    state.mall = "외국도서";
                    state.parentGenreId = null;
                    state.genreId = null;

                    await loadForeignParentsAsChildren(); // ✅ 핵심
                } else {
                    state.mall = "All";
                    state.parentGenreId = parseInt(g.genreId, 10);
                    state.genreId = null;

                    await loadChildGenres(state.parentGenreId);
                }

                setCurrentGenreText();
                load();
            });

            $parentList.appendChild(li);
        });
    }

    async function loadChildGenres(parentGenreId) {
        $childList.innerHTML = `<li style="font-size:12px; color:#777; padding:6px 2px;">불러오는 중...</li>`;

        const res = await fetch(
            `${GENRE_API}/children?parentId=${encodeURIComponent(parentGenreId)}`,
            { headers: { "Accept": "application/json" } }
        );

        if (!res.ok) throw new Error("Child genre HTTP " + res.status);
        const list = await res.json();

        if (!list || list.length === 0) {
            $childList.innerHTML = `<li style="font-size:12px; color:#777; padding:6px 2px;">소분류가 없습니다</li>`;
            return;
        }

        $childList.innerHTML = "";
        list.forEach(g => {
            const li = document.createElement("li");
            li.className = "cat-item";
            li.textContent = g.genreNm;
            li.dataset.genreId = g.genreId;

            li.addEventListener("click", () => {
                clearActive($childList);
                li.classList.add("active");

                state.mall = "국내도서";
                state.genreId = parseInt(g.genreId, 10);
                state.page = 1;

                setCurrentGenreText();
                load();
            });

            $childList.appendChild(li);
        });
    }

    // ====== 렌더 ======
    function renderGrid(items) {
        if (!items || items.length === 0) {
            $grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#777; padding:30px;">
                검색 결과가 없습니다.
            </div>`;
            return;
        }

        $grid.innerHTML = items.map(it => {
            const img = it.naverImage || it.aladinImageBig || "";
            const title = esc(it.bookTitle);
            const authors = esc(it.authors);
            const publisher = esc(it.publisher);
            const desc = esc(it.description || "");

            return `
                 <article class="card" data-isbn="${esc(it.isbn13)}">
                    <div class="thumb">
                      ${img ? `<img src="${esc(img)}" alt="${title}"/>` : ``}
                    </div>

                    <div class="info">
                      <div class="title">${title}</div>
                      <div class="sub">${authors}<br/>${publisher}</div>
                    </div>
                  </article>
            `;
        }).join("");

        $grid.querySelectorAll(".card").forEach(card => {
            card.addEventListener("click", () => {
                const isbn = card.getAttribute("data-isbn");
                location.href = `/book/detail?isbn13=${encodeURIComponent(isbn)}`;
            });
        });
    }

    function renderPager(page, totalPages) {
        $pager.innerHTML = "";
        if (!totalPages || totalPages <= 1) return;

        const groupSize = 10;
        const groupStart = Math.floor((page - 1) / groupSize) * groupSize + 1;
        const groupEnd = Math.min(groupStart + groupSize - 1, totalPages);

        const prevBtn = document.createElement("button");
        prevBtn.textContent = "◀";
        prevBtn.disabled = groupStart === 1;
        prevBtn.onclick = () => {
            state.page = groupStart - 1;
            load();
        };
        $pager.appendChild(prevBtn);

        for (let p = groupStart; p <= groupEnd; p++) {
            const btn = document.createElement("button");
            btn.textContent = String(p);
            if (p === page) btn.classList.add("active");
            btn.onclick = () => {
                state.page = p;
                load();
            };
            $pager.appendChild(btn);
        }

        const nextBtn = document.createElement("button");
        nextBtn.textContent = "▶";
        nextBtn.disabled = groupEnd === totalPages;
        nextBtn.onclick = () => {
            state.page = groupEnd + 1;
            load();
        };
        $pager.appendChild(nextBtn);
    }

    // ====== 로드 ======
    async function load() {
        console.log("QS=", buildQuery(), "parentGenreId=", state.parentGenreId);
        $loading.style.display = "block";
        $grid.innerHTML = "";
        $pager.innerHTML = "";

        try {
            const qs = buildQuery();
            const res = await fetch(`${API_URL}?${qs}`, { headers: { "Accept": "application/json" } });
            if (!res.ok) throw new Error("HTTP " + res.status);

            const data = await res.json();

            $total.textContent = data.total ?? 0;
            $pageInfo.textContent = `page ${data.page ?? 1} / ${data.totalPages ?? 1}`;

            renderGrid(data.items || []);
            renderPager(data.page || 1, data.totalPages || 1);

        } catch (e) {
            console.error(e);
            $grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#b00; padding:30px;">
                데이터를 불러오지 못했습니다. 콘솔/로그를 확인하세요.
            </div>`;
        } finally {
            $loading.style.display = "none";
        }
    }

    // ====== 이벤트 ======
    $btn.addEventListener("click", () => {
        state.page = 1;
        state.keyword = ($keyword.value || "").trim() || null;
        state.field = $field.value;
        state.sort = $sort.value;
        state.ebookYn = $ebookYn.value;
        state.size = parseInt($size.value, 10) || 20;
        load();
    });

    $keyword.addEventListener("keydown", (e) => {
        if (e.key === "Enter") $btn.click();
    });

    $size.addEventListener("change", () => {
        state.page = 1;
        state.size = parseInt($size.value, 10) || 20;
        load();
    });

    // 전체 버튼: 전체 목록 (너는 국내 기본으로 해둠)
    $btnAll.addEventListener("click", () => {
        state.mall = "ALL";
        state.parentGenreId = null;
        state.genreId = null;
        state.page = 1;

        clearActive($parentList);
        clearActive($childList);

        $childList.innerHTML = `<li style="font-size:12px; color:#777; padding:6px 2px;">대분류를 선택하세요</li>`;
        setCurrentGenreText();
        load();
    });


    // ====== 최초 로드 ======
    (async () => {
        try {
            await loadParentGenres();
        } catch (e) {
            console.error(e);
        }
        load();
    })();
</script>

</body>
</html>
