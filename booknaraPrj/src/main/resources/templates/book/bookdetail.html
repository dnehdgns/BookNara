<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title th:text="${view.bookDetailDTO.bookTitle}">ë„ì„œ ìƒì„¸</title>
    <link rel="stylesheet" th:href="@{/css/footer.css}">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap');

        /* =========================================
           1. ê³µí†µ ë³€ìˆ˜ ë° ë ˆì´ì•„ì›ƒ
           ========================================= */
        :root{
            --page-max: 1440px;      /* ì „ì²´ í˜ì´ì§€ í­ */
            --content-max: 1280px;   /* ê¸°ë³¸ ì»¨í…ì¸  í­ */
            --inner-max: 1120px;     /* ë‚´ë¶€ ì»¨í…ì¸  í­(ë„ì„œì†Œê°œ/ë¦¬ë·°/ìƒë‹¨ì˜ì—­ ê³µí†µ) */
            --gap: 24px;
            --radius: 10px;

            --bg: #fff;
            --text: #111;
            --muted: #666;
            --light-bg: #f9f9f9;

            --accent: #DCA244;
            --line: #e5e5e5;
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.03);

            /* âœ… ì˜¤ë¥¸ìª½(KPI/í† ê¸€/ë²„íŠ¼ ë¬¶ìŒ)ë§Œ ì•„ë˜ë¡œ ë‚´ë¦¬ëŠ” ì˜¤í”„ì…‹ */
            --purchase-offset: 170px; /* 80~180 ì¶”ì²œ. ìŠ¤ìƒ·ì²˜ëŸ¼ ë§ì¶”ë ¤ë©´ ì—¬ê¸° ìˆ«ìë§Œ ì¡°ì ˆ */
        }

        body { margin:0; font-family: Arial, sans-serif; background: #fff; }
        .wrap { max-width: var(--page-max); margin: 0 auto; padding: 24px 16px; }

        .wrap-inner{
            width: min(var(--content-max), 100%);
            margin: 0 auto;
            display: block;
        }

        .center {
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        /* âœ… ë„ì„œì†Œê°œ/ë¦¬ë·°/ìƒë‹¨ì˜ì—­ ëª¨ë‘ì— ì ìš©í•  "ë‚´ë¶€ ì»¨í…ì¸ " í­ */
        .section-inner{
            width: min(var(--inner-max), 100%);
            margin: 0 auto;
        }

        /* =========================================
           2. Crumbbar
           ========================================= */
        .crumbbar {
            margin: 0 0 30px;
            background:#fff;
            border: 1px solid var(--accent);
            border-radius: var(--radius);
            padding: 12px 16px;
            display:flex;
            justify-content: space-between;
            align-items:center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .crumb-left { display:flex; align-items:center; gap: 8px; flex-wrap: wrap; min-width: 0; }

        .crumb-home, .crumb-sep, .crumb-link, .crumb-current {
            font-weight: 900;
            font-size: 14px;
            color: var(--accent);
        }

        .crumb-home {
            display:inline-flex; align-items:center; gap:6px;
            text-decoration: none; cursor:pointer;
        }

        .crumb-link {
            border: none; background: transparent; padding: 0; margin: 0;
            cursor:pointer;
            text-decoration: none;
        }
        .crumb-link:hover { text-decoration: underline; }
        .crumb-current { cursor: default; text-decoration: none; }

        /* =========================================
           3. ìƒë‹¨ ìƒì„¸ ì˜ì—­(í‘œì§€+ìš°ì¸¡ ì •ë³´)
           ========================================= */

        /* âœ… ìƒë‹¨ë„ ë„ì„œì†Œê°œ/ë¦¬ë·°ì²˜ëŸ¼ "ë‚´ë¶€ë§Œ" ì¤„ì´ê³  êµ¬ë¶„ì„ ì€ ìœ ì§€ */
        .detail-section{
            border-bottom: 1px solid var(--line);
            padding-bottom: 40px;
            margin-bottom: 40px;
        }

        .detail-container {
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 60px;
            align-items: start;
        }

        /* í‘œì§€ ì´ë¯¸ì§€ */
        .cover-area { position: relative; }
        .cover{
            width: 100%;
            aspect-ratio: 1 / 1.45;
            border-radius: var(--radius);
            border: 1px solid var(--line);
            overflow:hidden;
            background: var(--light-bg);
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow: var(--shadow-soft);
        }

        /* âœ… ì´ë¯¸ì§€ í˜¸ë²„ íš¨ê³¼ ì œê±° */
        .cover img{
            width:100%;
            height:100%;
            object-fit:cover;
            display:block;
            transition: none;
            transform: none;
        }

        .badge-ebook-ribbon{
            position: absolute; right: 20px; top: -8px; width: 55px; height: 85px;
            border-radius: 4px 4px 12px 12px;
            display:flex; align-items:center; justify-content:center;
            background:#63BCD9; color:#fff;
            font-family: 'Gamja Flower', cursive;
            font-weight: 900; font-size: 50px;
            letter-spacing: 1px;
            writing-mode: vertical-rl; text-orientation: upright;
            box-shadow: 0 8px 14px rgba(0,0,0,0.20);
            border:1px solid rgba(255,255,255,0.25);
            z-index: 2;
            user-select: none;
        }

        /* ìš°ì¸¡ ì •ë³´ íŒ¨ë„ */
        .info-pane{
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 0;
        }

        .header-section { border-bottom: 1px solid var(--line); padding-bottom: 24px; margin-bottom: 28px; }
        .title{ font-size: 32px; font-weight: 800; line-height: 1.3; margin: 0 0 16px 0; letter-spacing: -0.5px; word-break: keep-all; }
        .meta-row { display: flex; flex-wrap: wrap; align-items: center; gap: 14px; color: var(--muted); font-size: 15px; }
        .meta-divider { width: 1px; height: 12px; background: #ddd; display: inline-block; }

        /* âœ… ì˜¤ë¥¸ìª½ KPI/í† ê¸€/ë²„íŠ¼ ë¬¶ìŒë§Œ ì•„ë˜ë¡œ ë‚´ë¦¬ê¸° */
        .purchase-box{
            margin-top: var(--purchase-offset);
        }

        /* KPI (Status Bar) */
        .status-bar {
            background: var(--light-bg);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 24px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 20px;
        }
        .status-item { text-align: center; flex: 1; }
        .status-item:not(:last-child) { border-right: 1px solid #ddd; }
        .status-label { font-size: 14px; color: var(--muted); margin-bottom: 8px; font-weight: 600; }
        .status-value { font-size: 22px; font-weight: 800; color: var(--text); }
        .status-value .total { font-size: 16px; color: #999; font-weight: 500; }

        /* í¬ë§· í† ê¸€ */
        .format-group { display: flex; gap: 14px; margin-bottom: 14px; }
        .format-item {
            flex: 1;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            background: #fff;
            color: var(--muted);
            text-align: center;
            text-decoration: none;
            font-weight: 700;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            position: relative;
        }
        .format-item.active { border: 2px solid var(--accent); color: var(--accent); background: #fff; z-index: 1; pointer-events: none; box-shadow: 0 4px 12px rgba(220, 162, 68, 0.1); }
        .format-item:not(.active):not(.disabled):hover { background: #fafafa; border-color: #ccc; color: var(--text); }
        .format-item.disabled { background: #f9f9f9; color: #ccc; border-color: #eee; cursor: default; pointer-events: none; }
        .check-icon { font-size: 1.1em; }

        /* ë²„íŠ¼ ì˜ì—­ */
        .action-area { margin-top: 0; display: flex; flex-direction: column; gap: 14px; }
        .main-buttons { display: grid; grid-template-columns: 1fr 2fr; gap: 14px; height: 56px; }
        #rentActions { display: contents; }

        .btn {
            width: 100%;
            height: 100%;
            border: 1px solid var(--accent);
            background: #fff;
            color: var(--text);
            border-radius: 8px;
            font-size: 17px;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .btn:hover { filter: brightness(0.98); }
        .btn-primary, .btn-addcart, .btn-rsv, .btn-extend { background: var(--accent); color: #fff; box-shadow: 0 4px 10px rgba(220, 162, 68, 0.2); }
        .btn-primary:hover, .btn-addcart:hover, .btn-rsv:hover { background: #c89035; transform: translateY(-1px); }
        .btn:disabled { background: #f0f0f0; border-color: #ddd; color: #aaa; cursor: not-allowed; box-shadow: none; }

        /* =========================
   Share / Bookmark buttons
   ========================= */
        .sub-buttons{
            display:flex;
            justify-content:flex-end;
            gap:10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        /* ê¸°ì¡´ btn-textë¥¼ "pill button"ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ */
        .btn-text{
            background:#fff;
            border: 1px solid var(--line);
            color: var(--muted);
            font-size: 14px;
            font-weight: 800;
            display:inline-flex;
            align-items:center;
            gap:8px;
            cursor:pointer;
            padding: 10px 12px;
            border-radius: 999px;
            transition: transform .12s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease, color .18s ease;
            user-select: none;
        }

        .btn-text:hover{
            background: #fafafa;
            border-color: #d8d8d8;
            color: var(--text);
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(0,0,0,0.06);
        }

        .btn-text:active{
            transform: translateY(0);
            box-shadow: none;
        }

        .btn-text .btn-ico{
            font-size: 16px;
            line-height: 1;
        }

        .btn-text .btn-label{
            line-height: 1;
        }

        /* ê³µìœ  ë²„íŠ¼: ì‚´ì§ í¬ì¸íŠ¸ */
        .btn-share{
            border-color: rgba(220,162,68,.35);
        }
        .btn-share:hover{
            border-color: rgba(220,162,68,.55);
        }

        /* ë¶ë§ˆí¬ ë²„íŠ¼: ê¸°ë³¸ì€ ì€ì€ */
        .btn-bookmark{
            border-color: #e7e7e7;
        }

        /* âœ… ë¶ë§ˆí¬ í™œì„± ìƒíƒœ(ë¶ë§ˆí¬ë¨) */
        .btn-bookmark.active{
            background: rgba(220,162,68,.14);
            border-color: rgba(220,162,68,.55);
            color: var(--accent);
            box-shadow: 0 10px 20px rgba(220,162,68,.16);
        }

        .btn-bookmark.active:hover{
            background: rgba(220,162,68,.18);
            border-color: rgba(220,162,68,.70);
        }

        /* =========================================
           4. ì»¨í…ì¸  ì„¹ì…˜(ë„ì„œì†Œê°œ/ë¦¬ë·°)
           ========================================= */
        .content-section { margin-top: 0; padding-top: 0; }
        .sec-inner{
            width: min(var(--inner-max), 100%);
            margin: 0 auto;
            padding: 40px 0;
            border-bottom: 1px solid var(--line);
        }
        .content-section:last-of-type .sec-inner{ border-bottom: none; }

        .sec-head {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .desc-text { font-size: 16px; line-height: 1.8; color: #333; white-space: pre-line; text-align: justify; }

        .review-grid { display: grid; gap: 16px; }
        .review-card { background: var(--light-bg); padding: 24px; border-radius: var(--radius); border: 1px solid transparent; }
        .review-meta { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; color: var(--muted); }
        .review-rate { color: var(--accent); font-weight: 800; }
        .review-body { font-size: 15px; color: #444; line-height: 1.6; }

        @media (max-width: 1024px) {
            :root{ --inner-max: 100%; }
            .detail-container { grid-template-columns: 1fr; gap: 26px; }
            .cover { max-width: 480px; margin: 0 auto; }
            .info-pane { text-align: center; }
            .meta-row { justify-content: center; }
            .sub-buttons { justify-content: center; }
            .main-buttons { grid-template-columns: 1fr; height: auto; }
            .main-buttons .btn{ height: 56px; }

            /* ëª¨ë°”ì¼ì—ì„œëŠ” ì•„ë˜ë¡œ ë‚´ë¦¬ì§€ ì•ŠìŒ */
            .purchase-box{ margin-top: 0; }
        }

        /* =========================
   My Review Box
   ========================= */
        .my-review-card{
            border: 1px solid var(--line);
            border-radius: var(--radius);
            background: #fff;
            box-shadow: var(--shadow-soft);
            padding: 16px;
        }
        .my-review-top{
            display:flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--line);
            margin-bottom: 12px;
        }
        .my-review-title{
            font-weight: 900;
            font-size: 16px;
        }
        .my-review-msg{
            font-size: 13px;
            color: var(--muted);
        }
        .my-review-form{
            display:flex;
            flex-direction: column;
            gap: 10px;
        }
        .my-review-row{
            display:flex;
            align-items:center;
            gap: 10px;
        }
        .my-review-label{
            font-weight: 800;
            font-size: 14px;
            color: var(--muted);
            width: 44px;
        }
        .my-review-select{
            border: 1px solid var(--line);
            border-radius: 8px;
            padding: 8px 10px;
        }
        .my-review-input, .my-review-textarea{
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 12px;
            font-size: 14px;
        }
        .my-review-textarea{ resize: vertical; }
        .btn-review{
            background: var(--accent);
            color: #fff;
        }

    </style>
</head>

<body>
<div th:replace="fragments/header :: header"></div>

<div class="wrap">
    <div class="wrap-inner">

        <main class="center">

            <div class="crumbbar">
                <div class="crumb-left">
                    <a class="crumb-home" th:href="@{/book/search}" aria-label="ê²€ìƒ‰">
                        <span aria-hidden="true">ğŸ </span><span>í™ˆ</span>
                    </a>

                    <span th:if="${view.genrePath != null and view.genrePath.crumbs != null and !view.genrePath.crumbs.isEmpty()}"
                          th:each="c, st : ${view.genrePath.crumbs}">
                        <span class="crumb-sep">&rsaquo;</span>
                        <a th:href="@{/book/search(mall=${view.genrePath.mall}, parentGenreId=${c.genreId})}"
                           th:text="${#strings.replace(c.genreNm, '_', '')}"
                           th:classappend="${st.last} ? 'crumb-current' : 'crumb-link'">ì¥ë¥´</a>
                    </span>
                </div>
            </div>

            <!-- âœ… ìƒë‹¨ ìƒì„¸ ì˜ì—­ -->
            <div class="detail-section">
                <div class="section-inner">
                    <div class="detail-container">
                        <div class="cover-area">
                            <div class="cover">
                                <div class="badge-ebook-ribbon"
                                     th:if="${view.bookDetailDTO.ebookYn == 'Y'}"
                                     title="ì „ìì±…">E</div>

                                <img th:src="${#strings.isEmpty(view.bookDetailDTO.naverImage) ? view.bookDetailDTO.aladinImageBig : view.bookDetailDTO.naverImage}"
                                     alt="ë„ì„œ í‘œì§€"/>
                            </div>
                        </div>

                        <div class="info-pane">

                            <div class="header-section">
                                <h1 class="title" th:text="${view.bookDetailDTO.bookTitle}">ë„ì„œ ì œëª©</h1>
                                <div class="meta-row">
                                    <span th:text="${#strings.replace(view.bookDetailDTO.authors, '^', ', ')}">ì €ì</span>
                                    <span class="meta-divider"></span>
                                    <span th:text="${#strings.trim(#strings.replace(view.bookDetailDTO.publisher, '_', ''))}">ì¶œíŒì‚¬</span>
                                    <span class="meta-divider"></span>
                                    <span th:text="${view.bookDetailDTO.pubdate}">ì¶œê°„ì¼</span>
                                </div>
                            </div>

                            <!-- âœ… KPI/í† ê¸€/ë²„íŠ¼ ë©ì–´ë¦¬ë§Œ ì•„ë˜ë¡œ ë‚´ë¦¬ê¸° -->
                            <div class="purchase-box">

                                <div class="status-bar" id="kpiBox">
                                    <div class="status-item">
                                        <div class="status-label">ëŒ€ì—¬í˜„í™©</div>
                                        <div class="status-value">
                                            <span id="lendingCnt">0</span>
                                            <span class="total">/ <span id="ownedCnt" th:text="${view.inventory.totalCount}">0</span>ê¶Œ</span>
                                        </div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">ì˜ˆì•½ëŒ€ê¸°</div>
                                        <div class="status-value">
                                            <span id="rsvActiveCnt">0</span>
                                            <span class="total">/ <span id="rsvLimit">10</span>ëª…</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="format-group">
                                    <a class="format-item"
                                       th:classappend="${view.bookDetailDTO.ebookYn == 'N'} ? 'active' : (${view.pairYn == 'N'} ? 'disabled' : '')"
                                       th:href="@{ ${ (view.bookDetailDTO.ebookYn == 'Y' and view.pairYn == 'Y') ? ('/book/detail/' + view.pairIsbn13) : '#' } }"
                                       th:title="${view.bookDetailDTO.ebookYn == 'N'} ? 'í˜„ì¬ ì¢…ì´ì±… ë³´ê³  ìˆìŒ' : 'ì¢…ì´ì±… í˜ì´ì§€ë¡œ ì´ë™'">
                                        <span th:if="${view.bookDetailDTO.ebookYn == 'N'}" class="check-icon">âœ”</span>
                                        ì¢…ì´ì±…
                                    </a>

                                    <a class="format-item"
                                       th:classappend="${view.bookDetailDTO.ebookYn == 'Y'} ? 'active' : (${view.pairYn == 'N'} ? 'disabled' : '')"
                                       th:href="@{ ${ (view.bookDetailDTO.ebookYn == 'N' and view.pairYn == 'Y') ? ('/book/detail/' + view.pairIsbn13) : '#' } }"
                                       th:title="${view.bookDetailDTO.ebookYn == 'Y'} ? 'í˜„ì¬ ì „ìì±… ë³´ê³  ìˆìŒ' : 'ì „ìì±… í˜ì´ì§€ë¡œ ì´ë™'">
                                        <span th:if="${view.bookDetailDTO.ebookYn == 'Y'}" class="check-icon">âœ”</span>
                                        ì „ìì±…
                                    </a>
                                </div>

                                <div class="action-area">
                                    <div class="main-buttons">
                                        <button id="btnCart"
                                                class="btn"
                                                type="button"
                                                th:attr="data-isbn=${view.bookDetailDTO.isbn13}">
                                            <span id="cartText">ì¥ë°”êµ¬ë‹ˆ</span>
                                        </button>

                                        <div id="rentActions">
                                            <button class="btn" disabled>í™•ì¸ì¤‘...</button>
                                        </div>
                                    </div>

                                    <div class="rent-hint" id="rentHint"></div>

                                    <div class="sub-buttons">
                                        <button id="btnShare" class="btn-text btn-share" type="button" title="ì£¼ì†Œ ë³µì‚¬">
                                            <span class="btn-ico" aria-hidden="true">ğŸ”—</span>
                                            <span class="btn-label">ê³µìœ í•˜ê¸°</span>
                                        </button>


                                        <button id="btnBookmark"
                                                class="btn-text btn-bookmark"
                                                type="button"
                                                th:attr="data-isbn=${view.bookDetailDTO.isbn13}"
                                                aria-pressed="false">
                                            <span class="btn-ico" id="bookmarkIcon" aria-hidden="true">â˜†</span>
                                            <span class="btn-label" id="bookmarkText">ë¶ë§ˆí¬</span>
                                        </button>

                                    </div>
                                </div>

                            </div>
                            <!-- âœ… purchase-box ë -->

                        </div>
                    </div>
                </div>
            </div>

            <!-- âœ… ë„ì„œ ì†Œê°œ -->
            <div class="content-section">
                <div class="sec-inner">
                    <div class="sec-head">ë„ì„œ ì†Œê°œ</div>
                    <div class="desc-text" th:text="${view.bookDetailDTO.description}">ì„¤ëª…</div>
                </div>
            </div>

            <!-- âœ… ë¦¬ë·° -->
            <div class="content-section">
                <div class="sec-inner">
                    <div class="sec-head">
                        ë¦¬ë·°

                        <!-- ì˜¤ë¥¸ìª½: KPI + ë¦¬ë·°ì‘ì„± ë²„íŠ¼(í•­ì‹œë…¸ì¶œ) -->
                        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                            <div style="font-size: 16px; font-weight: normal; display: flex; align-items: center; gap: 8px;">
                                <span style="color:var(--accent);">â˜…</span>
                                <strong id="ratingAvg"
                                        th:text="${view.reviewSummary != null ? view.reviewSummary.ratingAvg : 0.0}">0.0</strong>
                                <span style="color:#aaa;">(<span id="reviewCnt"
                                                                 th:text="${view.reviewSummary != null ? view.reviewSummary.reviewCnt : 0}">0</span>ê°œ)</span>
                            </div>

                            <button id="btnOpenReview" class="btn-text" type="button" title="ë¦¬ë·° ì‘ì„±">
                                <span class="btn-ico" aria-hidden="true">âœ</span>
                                <span class="btn-label" id="btnOpenReviewText">ë¦¬ë·° ì‘ì„±</span>
                            </button>
                        </div>
                    </div>

                    <!-- âœ… ë‚´ ë¦¬ë·° ì‘ì„± ë°•ìŠ¤ (í´ë¦­ í›„ permission í†µê³¼ ì‹œì—ë§Œ display:block ì²˜ë¦¬) -->
                    <div id="myReviewBox" style="display:none; margin-top: 14px;">
                        <div class="my-review-card">
                            <div class="my-review-top">
                                <div class="my-review-title" id="myReviewTitleText">ë¦¬ë·° ì‘ì„±</div>
                                <div class="my-review-msg" id="reviewPermMsg"></div>
                            </div>

                            <div class="my-review-form">
                                <div class="my-review-row">
                                    <label class="my-review-label">í‰ì </label>
                                    <select id="reviewRate" class="my-review-select">
                                        <option value="5">5</option><option value="4">4</option><option value="3">3</option>
                                        <option value="2">2</option><option value="1">1</option>
                                    </select>
                                    <span style="color:var(--accent); font-weight:900;">â˜…</span>
                                </div>

                                <input id="reviewTitle" type="text" placeholder="ì œëª©(ì„ íƒ)" class="my-review-input">
                                <textarea id="reviewContent" rows="5" placeholder="ë¦¬ë·° ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”" class="my-review-textarea"></textarea>

                                <div class="my-review-actions">
                                    <button id="btnReviewSave" class="btn btn-review" type="button">ë¦¬ë·° ì €ì¥</button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="review-grid" th:if="${view.reviewPreview != null and !view.reviewPreview.isEmpty()}">
                        <div class="review-card" th:each="r : ${view.reviewPreview}">
                            <div class="review-meta">
                                <span class="review-rate">â˜… <span th:text="${r.rate}">5</span></span>
                                <span>
                                    <span th:text="${r.profileNm}">ì‘ì„±ì</span> Â·
                                    <span th:text="${#temporals.format(r.createdAt, 'yyyy.MM.dd')}">ë‚ ì§œ</span>
                                </span>
                            </div>
                            <div style="font-weight:bold; margin-bottom:6px;" th:text="${r.title}">ì œëª©</div>
                            <div class="review-body" th:text="${r.content}">ë‚´ìš©</div>
                        </div>
                    </div>

                    <div class="desc-text" style="text-align: center; color: #999; padding: 40px;"
                         th:if="${view.reviewPreview == null or view.reviewPreview.isEmpty()}">
                        ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                </div>
            </div>

        </main>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {

        const isbn13 = /*[[${view.bookDetailDTO.isbn13}]]*/ "";
        const initialBookmarkedYn = /*[[${view.bookmarkedYn}]]*/ "N";

        // -----------------------------
        // ê³µí†µ
        // -----------------------------
        function goLoginReturnHere() {
            const returnUrl = location.pathname + location.search + location.hash;
            location.href = "/users/login?redirect=" + encodeURIComponent(returnUrl);
        }

        async function fetchJson(url, options = {}, onAuth = "silent") {
            // onAuth: "silent"(ì•„ë¬´ê²ƒë„ ì•ˆ í•¨), "redirect"(ë¡œê·¸ì¸ ì´ë™)
            const res = await fetch(url, {
                headers: {"Accept": "application/json", ...(options.headers || {})},
                ...options
            });

            const ct = res.headers.get("content-type") || "";
            const authFail = (res.status === 401 || res.status === 403 || ct.includes("text/html") || res.redirected);

            if (authFail) {
                if (onAuth === "redirect") goLoginReturnHere();
                return null;
            }
            if (!res.ok) throw new Error("HTTP " + res.status);
            return await res.json();
        }

        async function postForm(url, bodyObj, onAuth = "redirect") {
            const body = new URLSearchParams(bodyObj).toString();
            const res = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "Accept": "application/json"
                },
                body
            });

            const ct = res.headers.get("content-type") || "";
            const authFail = (res.status === 401 || res.status === 403 || ct.includes("text/html") || res.redirected);

            if (authFail) {
                if (onAuth === "redirect") goLoginReturnHere();
                return null;
            }
            if (!res.ok) throw new Error("HTTP " + res.status);
            return res;
        }

        // -----------------------------
        // ë¶ë§ˆí¬
        // -----------------------------
        const btnBm = document.getElementById("btnBookmark");
        const iconEl = document.getElementById("bookmarkIcon");
        const textEl = document.getElementById("bookmarkText");

        function renderBookmark(yn) {
            const isOn = (yn === "Y");
            if (isOn) {
                iconEl.textContent = "â˜…";
                btnBm.classList.add("active");
                btnBm.setAttribute("aria-pressed", "true");
                textEl.textContent = "ë¶ë§ˆí¬ë¨";
            } else {
                iconEl.textContent = "â˜†";
                btnBm.classList.remove("active");
                btnBm.setAttribute("aria-pressed", "false");
                textEl.textContent = "ë¶ë§ˆí¬";
            }
        }

        renderBookmark(initialBookmarkedYn);

        btnBm?.addEventListener("click", async () => {
            btnBm.disabled = true;
            try {
                // âœ… í´ë¦­ ì•¡ì…˜ì€ 401ì´ë©´ ë¡œê·¸ì¸ìœ¼ë¡œ ë³´ëƒ„
                const data = await fetchJson(`/api/bookmarks/${encodeURIComponent(isbn13)}/toggle`, {
                    method: "POST"
                }, "redirect");

                if (!data) return;
                renderBookmark(data.bookmarkedYn);
            } catch (e) {
                console.error(e);
                alert("ë¶ë§ˆí¬ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                btnBm.disabled = false;
            }
        });

        // -----------------------------
        // ì¥ë°”êµ¬ë‹ˆ
        // -----------------------------
        const btnCart = document.getElementById("btnCart");
        const cartTextEl = document.getElementById("cartText");

        function renderCartState(inCart) {
            cartTextEl.textContent = inCart ? "ë‹´ê¹€ âœ“" : "ì¥ë°”êµ¬ë‹ˆ";
        }

        async function loadCartStatus() {
            try {
                // âœ… ë°±ê·¸ë¼ìš´ë“œ GETì€ 401ì´ì–´ë„ íŠ•ê¸°ì§€ ì•ŠìŒ
                const data = await fetchJson(`/book/cart/${encodeURIComponent(isbn13)}/status`, {}, "silent");
                if (!data) {
                    // ë¹„ë¡œê·¸ì¸ì´ë©´ ê·¸ëƒ¥ ê¸°ë³¸ ìƒíƒœ ìœ ì§€
                    renderCartState(false);
                    return;
                }
                renderCartState(!!data.inCart);
            } catch (e) {
                console.error(e);
            }
        }

        btnCart?.addEventListener("click", async () => {
            btnCart.disabled = true;
            try {
                // âœ… í´ë¦­ ì•¡ì…˜ì€ 401ì´ë©´ ë¡œê·¸ì¸ìœ¼ë¡œ ë³´ëƒ„
                const data = await fetchJson(`/book/cart/${encodeURIComponent(isbn13)}/toggle`, {
                    method: "POST"
                }, "redirect");

                if (!data) return;
                renderCartState(!!data.inCart);
            } catch (e) {
                console.error(e);
                alert("ì¥ë°”êµ¬ë‹ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                btnCart.disabled = false;
            }
        });

        loadCartStatus();

        // -----------------------------
        // ê³µìœ 
        // -----------------------------
        const btnShare = document.getElementById("btnShare");

        async function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
                return;
            }
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            document.execCommand("copy");
            ta.remove();
        }

        btnShare?.addEventListener("click", async () => {
            try {
                await copyToClipboard(location.href);
                alert("ë§í¬ ë³µì‚¬ ì™„ë£Œ!");
            } catch (e) {
                alert("ì£¼ì†Œì°½ì„ ë³µì‚¬í•´ì£¼ì„¸ìš”.");
            }
        });

        // -----------------------------
        // ëŒ€ì—¬/ì˜ˆì•½/ì—°ì¥
        // -----------------------------
        const $rentActions = document.getElementById("rentActions");
        const $rentHint = document.getElementById("rentHint");

        function setRentHint(msg) {
            if ($rentHint) $rentHint.textContent = msg || "";
        }

        function buildRentButtons(it) {
            if (!it) return `<button class="btn" disabled>ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨</button>`;

            if (it.myLendYn === "Y") {
                if (it.myExtendYn === "Y") {
                    setRentHint("ë°˜ë‚©ì˜ˆì •ì¼ 7ì¼ ì´ë‚´ & ì—°ì¥ 1íšŒ ë¯¸ì‚¬ìš©ì´ë©´ ì—°ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    return `<button class="btn btn-extend" data-lend-id="${it.myLendId}">ì—°ì¥í•˜ê¸°</button>
                        <button class="btn" disabled style="background:#f0f0f0; border:none; color:#aaa;">ëŒ€ì—¬ì¤‘</button>`;
                }
                setRentHint("í˜„ì¬ ì´ ë„ì„œë¥¼ ëŒ€ì—¬ ì¤‘ì…ë‹ˆë‹¤.");
                return `<button class="btn" disabled>ëŒ€ì—¬ì¤‘</button>`;
            }

            if (Number(it.availableCnt) > 0) {
                setRentHint("ëŒ€ì—¬í•˜ê¸°ë¥¼ ëˆ„ë¥´ë©´ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ í›„ ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                return `<button class="btn btn-addcart">ëŒ€ì—¬í•˜ê¸°</button>`;
            }

            if (it.myRsvYn === "Y") {
                setRentHint("ì´ë¯¸ ì˜ˆì•½í•œ ë„ì„œì…ë‹ˆë‹¤.");
                return `<button class="btn btn-rsv-cancel" data-rsv-id="${it.myRsvId}"
                    style="background:#fff; color:var(--text); border-color:#ccc;">ì˜ˆì•½ì·¨ì†Œ</button>`;
            }

            if (it.userBlockedYn === "Y" || it.userOverdueYn === "Y" || it.rsvLimitYn === "Y") {
                let reason = "ì˜ˆì•½ ë¶ˆê°€";
                if (it.userBlockedYn === "Y") reason = "ì°¨ë‹¨ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤.";
                else if (it.userOverdueYn === "Y") reason = "ì—°ì²´ ì¤‘ì…ë‹ˆë‹¤.";
                else if (it.rsvLimitYn === "Y") reason = "ì˜ˆì•½ ì¸ì› ì´ˆê³¼";
                setRentHint(reason);
                return `<button class="btn" disabled>ì˜ˆì•½ ë¶ˆê°€</button>`;
            }

            setRentHint("ëª¨ë“  ì±…ì´ ëŒ€ì—¬ì¤‘ì´ë¯€ë¡œ ì˜ˆì•½ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            return `<button class="btn btn-rsv">ì˜ˆì•½í•˜ê¸°</button>`;
        }

        function updateKpiByStatus(dto) {
            const lendingCntEl = document.getElementById("lendingCnt");
            const ownedCntEl = document.getElementById("ownedCnt");
            const rsvActiveCntEl = document.getElementById("rsvActiveCnt");
            const rsvLimitEl = document.getElementById("rsvLimit");

            if (ownedCntEl && dto?.ownedCnt != null) ownedCntEl.textContent = String(dto.ownedCnt);
            if (lendingCntEl && dto?.lendingCnt != null) lendingCntEl.textContent = String(dto.lendingCnt);
            if (rsvActiveCntEl && dto?.rsvActiveCnt != null) rsvActiveCntEl.textContent = String(dto.rsvActiveCnt);
            if (rsvLimitEl) rsvLimitEl.textContent = String(dto?.rsvLimit ?? 10);
        }

        async function loadCirculationStatus() {
            try {
                // âœ… ë°±ê·¸ë¼ìš´ë“œ GETì€ 401ì´ì–´ë„ íŠ•ê¸°ì§€ ì•ŠìŒ
                const dto = await fetchJson(`/book/circulation/status?isbn13=${encodeURIComponent(isbn13)}`, {}, "silent");

                if (!dto) {
                    // ë¹„ë¡œê·¸ì¸/ê¶Œí•œ ì—†ìœ¼ë©´ â€œë¡œê·¸ì¸ í›„ ì´ìš©â€ìœ¼ë¡œ ë°”ê¿”ì„œ í™•ì¸ì¤‘ íƒˆì¶œ
                    setRentHint("ë¡œê·¸ì¸ í›„ ëŒ€ì—¬/ì˜ˆì•½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    $rentActions.innerHTML = `<button class="btn btn-login">ë¡œê·¸ì¸ í›„ ì´ìš©</button>`;
                    return;
                }

                updateKpiByStatus(dto);
                $rentActions.innerHTML = buildRentButtons(dto);
            } catch (e) {
                console.error(e);
                setRentHint("ìƒíƒœ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                $rentActions.innerHTML = `<button class="btn" disabled>ì¡°íšŒ ì‹¤íŒ¨</button>`;
            }
        }

        $rentActions?.addEventListener("click", async (e) => {
            const b = e.target.closest("button");
            if (!b) return;

            if (b.classList.contains("btn-login")) {
                goLoginReturnHere();
                return;
            }

            try {
                if (b.classList.contains("btn-rsv")) {
                    const res = await postForm("/book/circulation/reserve", {isbn13}, "redirect");
                    if (res) await loadCirculationStatus();
                    return;
                }
                if (b.classList.contains("btn-rsv-cancel")) {
                    const rsvId = b.dataset.rsvId;
                    const res = await postForm("/book/circulation/reserve/cancel", {rsvId}, "redirect");
                    if (res) await loadCirculationStatus();
                    return;
                }
                if (b.classList.contains("btn-extend")) {
                    const lendId = b.dataset.lendId;
                    const res = await postForm("/book/circulation/extend", {lendId}, "redirect");
                    if (res) await loadCirculationStatus();
                    return;
                }
                if (b.classList.contains("btn-addcart")) {
                    const res = await postForm("/book/cart/add", {isbn13}, "redirect");
                    if (res) location.href = "/book/cart";
                    return;
                }
            } catch (e2) {
                console.error(e2);
                alert("ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });

        loadCirculationStatus();

        // -----------------------------
        // ë¦¬ë·° KPI (ì¡°íšŒë§Œ)
        // -----------------------------
        const ratingAvgEl = document.getElementById("ratingAvg");
        const reviewCntEl = document.getElementById("reviewCnt");

        async function loadReviewStatus() {
            try {
                const dto = await fetchJson(`/book/reviewstatus/${encodeURIComponent(isbn13)}`, {}, "silent");
                if (!dto) return;
                if (ratingAvgEl) ratingAvgEl.textContent = Number(dto.ratingAvg ?? 0).toFixed(1);
                if (reviewCntEl) reviewCntEl.textContent = String(dto.reviewCnt ?? 0);
            } catch (e) {
                console.error(e);
            }
        }

        loadReviewStatus();


        // =============================
// ë¦¬ë·° ì‘ì„±/ì €ì¥
// =============================
        const btnOpenReview = document.getElementById("btnOpenReview");
        const myReviewBox = document.getElementById("myReviewBox");
        const reviewPermMsg = document.getElementById("reviewPermMsg");
        const btnReviewSave = document.getElementById("btnReviewSave");

        const reviewRateEl = document.getElementById("reviewRate");
        const reviewTitleEl = document.getElementById("reviewTitle");
        const reviewContentEl = document.getElementById("reviewContent");

// âœ… permission í™•ì¸ í›„ ë°•ìŠ¤ ì—´ê¸°
        btnOpenReview?.addEventListener("click", async () => {
            try {
                const perm = await fetchJson(
                    `/book/review/permission?isbn13=${encodeURIComponent(isbn13)}`,
                    {},
                    "redirect"
                );
                if (!perm) return;

                // âœ… DTO ê¸°ì¤€ìœ¼ë¡œ íŒì •
                const allowed = (perm.allowedYn === "Y");
                const msg = (perm.message ?? "");

                myReviewBox.style.display = "block";
                reviewPermMsg.textContent = msg;

                // âœ… ê°€ëŠ¥/ë¶ˆê°€ëŠ¥ì— ë”°ë¼ ë²„íŠ¼ ì œì–´
                btnReviewSave.disabled = !allowed;

                // (ì„ íƒ) ê¸°ì¡´ ë¦¬ë·° ìˆìœ¼ë©´ ìˆ˜ì •ëª¨ë“œ í‘œì‹œ
                const hasReview = (perm.hasReviewYn === "Y");
                const titleEl = document.getElementById("myReviewTitleText");
                if (titleEl) titleEl.textContent = hasReview ? "ë¦¬ë·° ìˆ˜ì •" : "ë¦¬ë·° ì‘ì„±";
                const btnLabel = document.getElementById("btnOpenReviewText");
                if (btnLabel) btnLabel.textContent = hasReview ? "ë¦¬ë·° ìˆ˜ì •" : "ë¦¬ë·° ì‘ì„±";

                if (allowed) reviewContentEl?.focus();
            } catch (e) {
                console.error(e);
                alert("ë¦¬ë·° ì‘ì„± ê¶Œí•œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });


// âœ… JSONìœ¼ë¡œ /book/review/save í˜¸ì¶œ
        btnReviewSave?.addEventListener("click", async () => {
            const rate = Number(reviewRateEl?.value ?? 5);
            const title = (reviewTitleEl?.value ?? "").trim();
            const content = (reviewContentEl?.value ?? "").trim();

            if (!content) {
                alert("ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                reviewContentEl?.focus();
                return;
            }

            btnReviewSave.disabled = true;
            try {
                const data = await fetchJson(
                    "/book/review/save",
                    {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({isbn13, rate, title, content})
                    },
                    "redirect"
                );

                if (!data?.ok) {
                    alert("ë¦¬ë·° ì €ì¥ ì‹¤íŒ¨");
                    return;
                }

                alert("ë¦¬ë·°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                // KPI ì¬ì¡°íšŒ
                await loadReviewStatus();
                // í•„ìš”í•˜ë©´ ìƒˆë¡œê³ ì¹¨(ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°ê¹Œì§€ ê°±ì‹ í•˜ë ¤ë©´)
                // location.reload();

            } catch (e) {
                console.error(e);
                alert("ë¦¬ë·° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                btnReviewSave.disabled = false;
            }

        });
    });
</script>


<div th:replace="fragments/footer :: footer"></div>
</body>
</html>
