<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title th:text="${view.bookDetailDTO.bookTitle}">ë„ì„œ ìƒì„¸</title>
<!--     <link rel="stylesheet" th:href="@{/css/main.css}">-->
    <link rel="stylesheet" th:href="@{/css/footer.css}">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap');

        :root{
            --page-max: 1920px;
            --layout-max: 1440px;
            --content-max: 1280px;

            --radius: 12px;
            --gap: 18px;

            --bg: #fff;
            --text: #111;
            --muted: #666;

            --accent: #DCA244;
            --line: #e8e8e8;

            --shadow: 0 10px 22px rgba(0,0,0,0.08);
            --shadow-soft: 0 8px 16px rgba(0,0,0,0.06);
        }

        *{ box-sizing:border-box; }
        body{
            margin:0;
            font-family: Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .page{ max-width: var(--page-max); margin: 0 auto; background: var(--bg); }
        .page-inner{ width: min(var(--layout-max), 100%); margin: 0 auto; padding: 24px 16px; }
        .wrap{ width: min(var(--content-max), 100%); margin: 0 auto; }

        /* breadcrumb */
        .crumb-home{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            width: 28px;
            height: 28px;
            background:#fff;
            color: var(--accent);
            text-decoration:none;
            font-weight: 900;
            line-height: 1;
            user-select:none;
        }
        .crumb-home:hover{ background:#fff7e6; box-shadow: 0 6px 14px rgba(0,0,0,0.06); }

        .crumbbar{
            background:#fff;
            border:1px solid var(--accent);
            border-radius: var(--radius);
            padding: 12px 14px;
            margin-bottom: 14px;
            display:flex;
            align-items:center;
            gap: 8px;
            flex-wrap:wrap;
            font-size: 13px;
            color: var(--muted);
            font-weight: 800;
        }
        .crumbbar a{ color: var(--accent); text-decoration:none; font-weight: 900; }
        .crumbbar a:hover{ text-decoration: underline; }
        .crumb-sep{ color:#bbb; font-weight: 900; }

        .card{
            background:#fff;
            border:1px solid var(--accent);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow:hidden;
        }
        .card-inner{ padding: 18px; }

        .detail-grid{
            display:grid;
            grid-template-columns: minmax(280px, 32%) 1fr;
            gap: 22px;
            align-items: start;
        }

        .cover{
            width: 400px;
            aspect-ratio: 3/4;
            border-radius: var(--radius);
            border:1px solid var(--line);
            overflow:hidden;
            background:#fafafa;
            display:flex;
            align-items:center;
            justify-content:center;
            position: relative;
            box-shadow: var(--shadow-soft);
        }
        .cover img{ width:100%; height:100%; object-fit:cover; display:block; }

        /* âš ï¸ ìš”ì²­: badge-ebook CSSëŠ” ë°”ê¾¸ì§€ ë§ê¸° */
        .badge-ebook-ribbon{
            position: absolute;
            right: 16px;
            top: -8px;
            width:  50px;
            height: 80px;
            border-radius: 4px 4px 12px 12px;
            display:flex;
            align-items:center;
            justify-content:center;
            background:#63BCD9;
            color:#fff;
            font-family: 'Gamja Flower', cursive;
            font-weight: 900;
            font-size: 50px;
            letter-spacing: 1px;
            writing-mode: vertical-rl;
            text-orientation: upright;
            box-shadow: 0 8px 14px rgba(0,0,0,0.20);
            border:1px solid rgba(255,255,255,0.25);
            z-index: 2;
            user-select: none;
        }

        /* âœ… ìš°ì¸¡ íŒ¨ë„: KPIëŠ” ì¤‘ê°„, pair ë²„íŠ¼ì€ ìš°ì¸¡ ìƒë‹¨, ì‘ì€ ë²„íŠ¼ë“¤ì€ ìš°ì¸¡ í•˜ë‹¨ */
        .info-pane{
            position: relative;
            min-height: 100%;
            padding-bottom: 54px; /* ìš°ì¸¡ í•˜ë‹¨ ì‘ì€ ë²„íŠ¼ ìë¦¬ í™•ë³´ */
        }

        .title-row{
            display:flex;
            align-items:flex-start;
            gap: 10px;
        }
        .title{
            font-size: 24px;
            font-weight: 900;
            line-height: 1.25;
            margin: 0;
            letter-spacing: -0.2px;
            flex: 1 1 auto;
        }

        .lend-info{
            margin-top : 20px;
        }

        /* ì „ìì±…/ì¢…ì´ì±… ë³´ê¸° ë²„íŠ¼: cardinner ìš°ì¸¡ ìƒë‹¨(ì œëª© ë¼ì¸) */
        .btn-pair{
            border: 1px solid rgba(220,162,68,0.55);
            background:#fff;
            color: var(--accent);
            border-radius: 999px;
            padding: 10px 12px;
            cursor: pointer;
            font-weight: 900;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            white-space: nowrap;
            min-height: 40px;
            text-decoration:none;
        }
        .btn-pair:hover{
            background:#fff7e6;
            box-shadow: 0 8px 16px rgba(0,0,0,0.08);
        }

        .meta{
            color: var(--muted);
            font-size: 14px;
            display:flex;
            flex-wrap:wrap;
            gap: 8px 10px;
            font-weight: 800;
            margin: 10px 0 14px;
        }

        .kpi{
            display:grid;
            grid-template-columns: repeat(2, minmax(0,1fr));
            gap: 12px;
            width: 100%;
            margin: 16px 0; /* âœ… cardinner ì¤‘ê°„ ëŠë‚Œ */
        }
        .kpi .item{
            border:1px solid var(--line);
            border-radius: var(--radius);
            padding: 12px 14px;
            background:#fff;
            min-height: 74px;
            display:flex;
            flex-direction:column;
            justify-content:center;
        }
        .kpi .label{ color: var(--muted); font-size: 12px; font-weight: 900; margin-bottom: 6px; }
        .kpi .value{
            font-size: 20px;
            font-weight: 900;
            display:flex;
            align-items:baseline;
            gap:2px;
        }
        .kpi .value .slash{ color:black; font-weight: 900; margin: 0 2px; }

        /* buttons */
        .btn{
            border: 1px solid var(--accent);
            background:#fff;
            color: var(--text);
            border-radius: 999px;
            padding: 11px 14px;
            cursor: pointer;
            font-weight: 900;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            transition: transform .06s ease, background .15s ease, box-shadow .15s ease;
            white-space: nowrap;
            min-height: 44px;
            text-decoration:none;
        }
        .btn:hover{ background:#fff7e6; box-shadow: 0 8px 16px rgba(0,0,0,0.08); }
        .btn:active{ transform: translateY(1px); }
        .btn[disabled]{ opacity:.55; cursor:not-allowed; box-shadow:none; }
        .btn-primary{ background: var(--accent); color:#fff; border-color: var(--accent); }
        .btn-primary:hover{ background: #c89035; }

        .chip{
            font-size:12px;
            padding:4px 10px;
            border-radius:999px;
            border:1px solid var(--line);
            color: var(--muted);
            background:#fff;
            font-weight: 900;
        }

        /* âœ… ì¥ë°”êµ¬ë‹ˆ + ëŒ€ì—¬í•˜ê¸°(ëŒ€ì—¬/ì˜ˆì•½/ì—°ì¥) = ê°™ì€ ë¼ì¸ */
        .main-actions{
            display:grid;
            grid-template-columns: 1fr 1.4fr;
            gap: 10px;
            align-items: stretch;
            margin-top: 10px;
        }
        .main-actions > *{ width:100%; }

        #rentActions{ display:flex; gap: 10px; width: 100%; }
        #rentActions .btn{ flex: 1 1 0; width: 100%; }

        #rentActions .btn-addcart,
        #rentActions .btn-rsv,
        #rentActions .btn-extend{
            background: var(--accent);
            color:#fff;
            border-color: var(--accent);
        }
        #rentActions .btn-addcart:hover,
        #rentActions .btn-rsv:hover,
        #rentActions .btn-extend:hover{ background:#c89035; }

        .rent-hint{
            margin-top: 10px;
            color: var(--muted);
            font-size: 12px;
            font-weight: 800;
            line-height: 1.4;
        }

        /* âœ… ìš°ì¸¡ í•˜ë‹¨ ì‘ì€ ë²„íŠ¼(ê³µìœ /ë¶ë§ˆí¬) */
        .corner-actions{
            position:absolute;
            right: 0;
            bottom: 0;
            display:flex;
            gap: 8px;
            align-items:center;
            justify-content:flex-end;
        }
        .btn-mini{
            border: 1px solid rgba(220,162,68,0.55);
            background:#fff;
            color: var(--accent);
            border-radius: 999px;
            padding: 8px 10px;
            cursor: pointer;
            font-weight: 900;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            white-space: nowrap;
            min-height: 36px;
            text-decoration:none;
            box-shadow:none;
        }
        .btn-mini:hover{ background:#fff7e6; box-shadow: 0 8px 16px rgba(0,0,0,0.08); }
        .btn-mini-primary{
            background: var(--accent);
            color:#fff;
            border-color: var(--accent);
        }
        .btn-mini-primary:hover{ background:#c89035; }
        .chip-mini{
            font-size:11px;
            padding:3px 8px;
            border-radius:999px;
            border:1px solid rgba(255,255,255,0.35);
            color:#fff;
            background: rgba(255,255,255,0.18);
            font-weight: 900;
        }

        .section-card{
            background:#fff;
            border:1px solid var(--accent);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 18px;
        }
        .section-title{ font-size: 16px; font-weight: 900; margin: 0 0 10px; }
        .desc{ color: #222; line-height: 1.75; font-size: 14px; white-space: pre-line; }

        /* ë¦¬ë·° */
        .review-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
        .review-score{ display:flex; align-items:center; gap:10px; }
        .star{ font-size: 16px; }
        .review-list{ display:flex; flex-direction:column; gap: 10px; margin-top: 10px; }
        .review-item{ border:1px solid var(--line); border-radius: var(--radius); padding: 12px; background:#fff; }
        .review-top{ display:flex; align-items:center; justify-content:space-between; gap: 10px; }
        .review-writer{ color: var(--muted); font-size: 13px; font-weight: 800; }
        .review-title{ font-weight: 900; margin: 8px 0 6px; }
        .review-content{ color:#222; line-height: 1.6; font-size: 14px; white-space: pre-line; }

        @media (max-width: 1024px){
            .page-inner{ padding: 20px 12px; }
            .card-inner{ padding: 16px; }
            .section-card{ padding: 16px; }
            .title{ font-size: 22px; }
            .main-actions{ grid-template-columns: 1fr; }
            #rentActions{ flex-direction: column; }
            .corner-actions{ position: static; margin-top: 10px; justify-content:flex-end; }
            .info-pane{ padding-bottom: 0; }
        }

        @media (max-width: 860px){
            .detail-grid{ grid-template-columns: 1fr; }
            .cover{ max-width: 380px; margin: 0 auto; }
            .kpi{ grid-template-columns: 1fr 1fr; }
            .title-row{ flex-wrap:wrap; }
            .corner-actions{ justify-content:flex-start; }
        }

        @media (max-width: 420px){
            .kpi{ grid-template-columns: 1fr; }
            .btn{ width:100%; }
            .meta{ font-size: 13px; }
            .btn-pair{ width:100%; }
            .corner-actions{ flex-wrap:wrap; }
        }
    </style>
</head>

<body>
<div th:replace="fragments/header :: header"></div>
<div class="page">
    <div class="page-inner">
        <div class="wrap">

            <div class="crumbbar">
                <a class="crumb-home" th:href="@{/book/search}" aria-label="ê²€ìƒ‰">ğŸ </a>

                <span th:if="${view.genrePath != null and view.genrePath.crumbs != null and !view.genrePath.crumbs.isEmpty()}">
          <span th:each="c, st : ${view.genrePath.crumbs}">
            <span class="crumb-sep">â€º</span>
            <a th:href="@{/book/search(mall=${view.genrePath.mall}, parentGenreId=${c.genreId})}"
               th:text="${#strings.replace(c.genreNm, '_', '')}">ì¥ë¥´</a>

          </span>
        </span>
            </div>

            <div class="card">
                <div class="card-inner">
                    <div class="detail-grid">
                        <!-- í‘œì§€ -->
                        <div class="cover">
                            <div class="badge-ebook-ribbon"
                                 th:if="${view.bookDetailDTO.ebookYn == 'Y'}"
                                 title="ì „ìì±…">E</div>

                            <img th:src="${#strings.isEmpty(view.bookDetailDTO.naverImage) ? view.bookDetailDTO.aladinImageBig : view.bookDetailDTO.naverImage}"
                                 alt="cover"/>
                        </div>

                        <!-- ì •ë³´ -->
                        <div class="info-pane">

                            <!-- ì œëª© + ì „ìì±…/ì¢…ì´ì±… ë³´ê¸°(ìš°ì¸¡ ìƒë‹¨) -->
                            <div class="title-row">
                                <h1 class="title" th:text="${view.bookDetailDTO.bookTitle}">ë„ì„œ ì œëª©</h1>

                            </div>

                            <div class="meta">
                                <span th:text="${#strings.replace(view.bookDetailDTO.authors, '^', ' Â· ')}">ì €ì</span>
                                <span>ï½œ</span>
                                <span th:text="${#strings.trim(#strings.replace(view.bookDetailDTO.publisher, '_', ''))}">ì¶œíŒì‚¬</span>
                                <span>ï½œ</span>
                                <span th:text="${view.bookDetailDTO.pubdate}">ì¶œê°„ì¼</span>
                            </div>

                            <div class="lend-info">
                            <a class="btn-pair"
                               th:if="${view.pairYn == 'Y'}"
                               th:text="${view.pairLabel}"
                               th:href="@{/book/detail/{isbn13}(isbn13=${view.pairIsbn13})}">
                                ì „ìì±… ë³´ê¸°
                            </a>


                            <!-- KPI (cardinner ì¤‘ê°„ìª½) -->
                            <div class="kpi" id="kpiBox">
                                <div class="item">
                                    <div class="label">ëŒ€ì—¬ì¤‘ / ì†Œì¥ê¶Œìˆ˜</div>
                                    <div class="value">
                                        <span id="lendingCnt">0</span><span class="slash">/</span>
                                        <span id="ownedCnt" th:text="${view.inventory.totalCount}">0</span>
                                    </div>
                                </div>

                                <div class="item">
                                    <div class="label">ì˜ˆì•½ì¤‘ / ì˜ˆì•½ê°€ëŠ¥ì¸ì›</div>
                                    <div class="value">
                                        <span id="rsvActiveCnt">0</span><span class="slash">/</span>
                                        <span id="rsvLimit">10</span>
                                    </div>
                                </div>
                            </div>

                            <!-- âœ… ì¥ë°”êµ¬ë‹ˆ + ëŒ€ì—¬í•˜ê¸°(ëŒ€ì—¬/ì˜ˆì•½/ì—°ì¥) ê°™ì€ ë¼ì¸ -->
                            <div class="main-actions">
                                <button id="btnCart"
                                        class="btn"
                                        type="button"
                                        th:attr="data-isbn=${view.bookDetailDTO.isbn13}"
                                        aria-label="cart">
                                    <span id="cartText">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</span>
                                </button>

                                <div>
                                    <div id="rentActions">
                                        <button class="btn" disabled>ìƒíƒœ í™•ì¸ì¤‘â€¦</button>
                                    </div>
                                </div>
                            </div>
                            </div>

                            <!-- âœ… ê³µìœ /ë¶ë§ˆí¬: ìš°ì¸¡ í•˜ë‹¨ êµ¬ì„(ì‘ê²Œ) -->
                            <div class="corner-actions">
                                <button id="btnShare"
                                        class="btn-mini"
                                        type="button"
                                        aria-label="share"
                                        title="ë§í¬ ë³µì‚¬">
                                    ğŸ”— <span>ê³µìœ </span>
                                </button>

                                <button id="btnBookmark"
                                        class="btn-mini btn-mini-primary"
                                        type="button"
                                        th:attr="data-isbn=${view.bookDetailDTO.isbn13}"
                                        aria-label="bookmark"
                                        title="ë¶ë§ˆí¬">
                                    <span id="bookmarkIcon" aria-hidden="true">â˜†</span>
                                    <span id="bookmarkText">ë¶ë§ˆí¬</span>
                                    <span class="chip-mini" id="bookmarkCnt" th:text="${view.bookmarkCnt}">0</span>
                                </button>
                            </div>

                            <div class="rent-hint" id="rentHint"></div>
                        </div>

                    </div>
                </div>
            </div>

            <div style="height: 14px;"></div>

            <div class="section-card">
                <div class="section-title">ë„ì„œ ì†Œê°œ</div>
                <div class="desc" th:text="${view.bookDetailDTO.description}">ì„¤ëª…</div>
            </div>

            <div style="height: 14px;"></div>

            <div class="section-card">
                <div class="review-head">
                    <div class="section-title">ë¦¬ë·°</div>

                    <div class="review-score">
                        <span class="star">â˜…</span>
                        <strong id="ratingAvg"
                                th:text="${view.reviewSummary != null ? view.reviewSummary.ratingAvg : 0.0}">0.0</strong>
                        <span class="chip">
              <span id="reviewCnt"
                    th:text="${view.reviewSummary != null ? view.reviewSummary.reviewCnt : 0}">0</span>ê°œ
            </span>
                    </div>
                </div>

                <div class="review-list" th:if="${view.reviewPreview != null and !view.reviewPreview.isEmpty()}">
                    <div class="review-item" th:each="r : ${view.reviewPreview}">
                        <div class="review-top">
                            <div class="review-writer">
                                <span th:text="${r.profileNm}">ì‘ì„±ì</span>
                                <span> Â· </span>
                                <span th:text="${#temporals.format(r.createdAt, 'yyyy-MM-dd HH:mm')}">2026-01-01</span>
                            </div>
                            <div class="chip">
                                â˜… <span th:text="${r.rate}">5</span>
                            </div>
                        </div>

                        <div class="review-title" th:text="${r.title}">ë¦¬ë·° ì œëª©</div>
                        <div class="review-content" th:text="${r.content}">ë¦¬ë·° ë‚´ìš©</div>
                    </div>
                </div>

                <div class="desc" th:if="${view.reviewPreview == null or view.reviewPreview.isEmpty()}">
                    ì•„ì§ ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
            </div>

        </div>
    </div>
</div>

<script th:inline="javascript">
    function goLoginReturnHere() {
        const returnUrl = location.pathname + location.search + location.hash;
        location.href = "/users/login?redirect=" + encodeURIComponent(returnUrl);
    }

    async function fetchJson(url, options = {}) {
        const res = await fetch(url, {
            headers: { "Accept": "application/json", ...(options.headers || {}) },
            ...options
        });

        const ct = res.headers.get("content-type") || "";
        if (res.status === 401 || res.status === 403 || ct.includes("text/html") || res.redirected) {
            goLoginReturnHere();
            return null;
        }
        if (!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
    }

    async function postForm(url, bodyObj) {
        const body = new URLSearchParams(bodyObj).toString();
        const res = await fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "Accept": "application/json"
            },
            body
        });

        const ct = res.headers.get("content-type") || "";
        if (res.status === 401 || res.status === 403 || ct.includes("text/html") || res.redirected) {
            goLoginReturnHere();
            return null;
        }

        if (!res.ok) throw new Error("HTTP " + res.status);
        return res;
    }

    // ==========================
    // ë¶ë§ˆí¬
    // ==========================
    const initialBookmarkedYn = /*[[${view.bookmarkedYn}]]*/ "N";
    const isbn13 = /*[[${view.bookDetailDTO.isbn13}]]*/ "";

    const btnBm = document.getElementById('btnBookmark');
    const iconEl = document.getElementById('bookmarkIcon');
    const textEl = document.getElementById('bookmarkText');
    const cntEl  = document.getElementById('bookmarkCnt');

    function renderBookmark(yn){
        if(yn === 'Y'){
            iconEl.textContent = 'â˜…';
            textEl.textContent = 'ë¶ë§ˆí¬ë¨';
        }else{
            iconEl.textContent = 'â˜†';
            textEl.textContent = 'ë¶ë§ˆí¬';
        }
    }
    renderBookmark(initialBookmarkedYn);

    async function toggleBookmark(){
        btnBm.disabled = true;
        try{
            const res = await fetch(`/api/bookmarks/${encodeURIComponent(isbn13)}/toggle`, {
                method: 'POST',
                headers: { 'Accept': 'application/json' }
            });

            if(res.status === 401){ goLoginReturnHere(); return; }

            const ct = res.headers.get('content-type') || '';
            if(!ct.includes('application/json')){ goLoginReturnHere(); return; }

            if(!res.ok){
                alert('ë¶ë§ˆí¬ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                return;
            }

            const data = await res.json();
            renderBookmark(data.bookmarkedYn);
            if(typeof data.bookmarkCnt !== 'undefined'){
                cntEl.textContent = data.bookmarkCnt;
            }
        }catch(e){
            console.error(e);
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }finally{
            btnBm.disabled = false;
        }
    }
    btnBm.addEventListener('click', toggleBookmark);

    // ==========================
    // ì¥ë°”êµ¬ë‹ˆ (ë‹´ê¸°ë§Œ / ì´ë™ X)
    // ==========================
    const btnCart = document.getElementById('btnCart');
    const cartIconEl = document.getElementById('cartIcon');
    const cartTextEl = document.getElementById('cartText');

    function renderCart(inCart){
        if(inCart){
            cartTextEl.textContent = 'ë‹´ê¹€';
        }else{
            cartTextEl.textContent = 'ì¥ë°”êµ¬ë‹ˆ';
            alert("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.")
        }
    }

    async function toggleCartOnly(){
        btnCart.disabled = true;
        try{
            const res = await fetch(`/book/cart/${encodeURIComponent(isbn13)}/toggle`, {
                method: 'POST',
                headers: { 'Accept': 'application/json' }
            });

            if(res.status === 401){ goLoginReturnHere(); return; }

            const ct = res.headers.get('content-type') || '';
            if(!ct.includes('application/json')){ goLoginReturnHere(); return; }

            if(!res.ok){
                alert('ì¥ë°”êµ¬ë‹ˆ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                return;
            }

            const data = await res.json();
            renderCart(!!data.inCart);

        }catch(e){
            console.error(e);
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }finally{
            btnCart.disabled = false;
        }
    }
    btnCart.addEventListener('click', toggleCartOnly);

    // ==========================
    // ê³µìœ  (í´ë¦½ë³´ë“œ ë³µì‚¬ë§Œ)
    // ==========================
    const btnShare = document.getElementById("btnShare");

    async function copyToClipboard(text){
        if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            return;
        }
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        document.execCommand("copy");
        ta.remove();
    }

    btnShare?.addEventListener("click", async () => {
        const url = location.href;
        try{
            await copyToClipboard(url);
            alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }catch(e){
            console.error(e);
            alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì£¼ì†Œë¥¼ ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”:\n" + url);
        }
    });

    // ==========================
    // ëŒ€ì—¬/ì˜ˆì•½/ì—°ì¥
    // ==========================
    const $rentActions = document.getElementById("rentActions");
    const $rentHint = document.getElementById("rentHint");

    function setRentHint(msg){
        if(!$rentHint) return;
        $rentHint.textContent = msg || "";
    }

    function buildRentButtons(it){
        if(it.myLendYn === "Y"){
            if(it.myExtendYn === "Y"){
                setRentHint("ë°˜ë‚©ì˜ˆì •ì¼ 7ì¼ ì´ë‚´ & ì—°ì¥ 1íšŒ ë¯¸ì‚¬ìš©ì´ë©´ ì—°ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return `
          <button class="btn btn-extend" data-lend-id="${it.myLendId}">ì—°ì¥í•˜ê¸°</button>
          <button class="btn" disabled>ëŒ€ì—¬ì¤‘</button>
        `;
            }
            setRentHint("í˜„ì¬ ì´ ë„ì„œë¥¼ ëŒ€ì—¬ ì¤‘ì…ë‹ˆë‹¤.");
            return `<button class="btn" disabled>ëŒ€ì—¬ì¤‘</button>`;
        }

        if(Number(it.availableCnt) > 0){
            setRentHint("ëŒ€ì—¬í•˜ê¸°ë¥¼ ëˆ„ë¥´ë©´ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ í›„ ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            return `<button class="btn btn-addcart">ëŒ€ì—¬í•˜ê¸°</button>`;
        }

        if(it.myRsvYn === "Y"){
            setRentHint("ì´ë¯¸ ì˜ˆì•½í•œ ë„ì„œì…ë‹ˆë‹¤.");
            return `<button class="btn btn-rsv-cancel" data-rsv-id="${it.myRsvId}">ì˜ˆì•½ì·¨ì†Œ</button>`;
        }

        if(it.userBlockedYn === "Y" || it.userOverdueYn === "Y" || it.rsvLimitYn === "Y"){
            let reason = "ì˜ˆì•½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.";
            if(it.userBlockedYn === "Y") reason = "ì°¨ë‹¨ëœ ì‚¬ìš©ì ìƒíƒœë¡œ ì˜ˆì•½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.";
            else if(it.userOverdueYn === "Y") reason = "ì—°ì²´ ìƒíƒœì—ì„œëŠ” ì˜ˆì•½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.";
            else if(it.rsvLimitYn === "Y") reason = "ì˜ˆì•½ ì¸ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.";
            setRentHint(reason);
            return `<button class="btn" disabled>ì˜ˆì•½ ë¶ˆê°€</button>`;
        }

        setRentHint("ì¬ê³ ê°€ ì—†ìœ¼ë©´ ì˜ˆì•½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return `<button class="btn btn-rsv">ì˜ˆì•½í•˜ê¸°</button>`;
    }

    function updateKpiByStatus(dto){
        const lendingCntEl = document.getElementById("lendingCnt");
        const ownedCntEl = document.getElementById("ownedCnt");
        const rsvActiveCntEl = document.getElementById("rsvActiveCnt");
        const rsvLimitEl = document.getElementById("rsvLimit");

        if(ownedCntEl && dto.ownedCnt != null) ownedCntEl.textContent = String(dto.ownedCnt);
        if(lendingCntEl && dto.lendingCnt != null) lendingCntEl.textContent = String(dto.lendingCnt);
        if(rsvActiveCntEl && dto.rsvActiveCnt != null) rsvActiveCntEl.textContent = String(dto.rsvActiveCnt);
        if(rsvLimitEl) rsvLimitEl.textContent = String(dto.rsvLimit ?? 10);
    }

    async function loadCirculationStatus(){
        const dto = await fetchJson(`/book/circulation/status?isbn13=${encodeURIComponent(isbn13)}`);
        if (!dto) return;
        updateKpiByStatus(dto);
        $rentActions.innerHTML = buildRentButtons(dto);
    }

    $rentActions.addEventListener("click", async (e) => {
        const b = e.target.closest("button");
        if(!b) return;

        if (b.classList.contains("btn-rsv")) {
            const res = await postForm("/book/circulation/reserve", { isbn13 });
            if (res) loadCirculationStatus();
            return;
        }

        if (b.classList.contains("btn-rsv-cancel")) {
            const rsvId = b.dataset.rsvId;
            const res = await postForm("/book/circulation/reserve/cancel", { rsvId });
            if (res) loadCirculationStatus();
            return;
        }

        if (b.classList.contains("btn-extend")) {
            const lendId = b.dataset.lendId;
            const res = await postForm("/book/circulation/extend", { lendId });
            if (res) loadCirculationStatus();
            return;
        }

        // âœ… ëŒ€ì—¬í•˜ê¸° = ì¥ë°”êµ¬ë‹ˆ ë‹´ê³  ì´ë™
        if (b.classList.contains("btn-addcart")) {
            const res = await postForm("/book/cart/add", { isbn13 });
            if (res) location.href = "/book/cart";
            return;
        }
    });

    loadCirculationStatus();

    // ==========================
    // ë¦¬ë·° ìƒíƒœ (ê¸°ì¡´)
    // ==========================
    const ratingAvgEl = document.getElementById('ratingAvg');
    const reviewCntEl = document.getElementById('reviewCnt');

    function fmtAvg(v){
        const n = Number(v);
        if (!Number.isFinite(n)) return "0.0";
        return n.toFixed(1);
    }

    async function loadReviewStatus(){
        try{
            const res = await fetch(`/book/reviewstatus/${encodeURIComponent(isbn13)}`, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            });

            const ct = res.headers.get('content-type') || '';
            if(!res.ok) return;
            if(!ct.includes('application/json')) return;

            const dto = await res.json();
            if(!dto) return;

            if(ratingAvgEl) ratingAvgEl.textContent = fmtAvg(dto.ratingAvg);
            if(reviewCntEl) reviewCntEl.textContent = String(dto.reviewCnt ?? 0);

        }catch(e){
            console.error('reviewstatus error:', e);
        }
    }
    loadReviewStatus();
</script>
<div th:replace="fragments/footer :: footer"></div>
</body>

</html>
