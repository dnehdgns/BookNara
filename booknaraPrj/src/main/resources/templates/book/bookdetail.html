<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title th:text="${view.bookDetailDTO.bookTitle}">ë„ì„œ ìƒì„¸</title>
    <link rel="stylesheet" th:href="@{/css/footer.css}">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap');

        :root{
            --page-max: 1440px;
            --content-max: 1280px;
            --inner-max: 1120px;
            --gap: 24px;
            --radius: 10px;

            --bg: #fff;
            --text: #111;
            --muted: #666;
            --light-bg: #f9f9f9;

            --accent: #DCA244;
            --line: #e5e5e5;
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.03);

            --purchase-offset: 170px;
        }

        body { margin:0; font-family: Arial, sans-serif; background: #fff; }
        .wrap { max-width: var(--page-max); margin: 0 auto; padding: 24px 16px; }

        .wrap-inner{ width: min(var(--content-max), 100%); margin: 0 auto; display: block; }
        .center { width: 100%; display: flex; flex-direction: column; }
        .section-inner{ width: min(var(--inner-max), 100%); margin: 0 auto; }

        .crumbbar {
            margin: 0 0 30px;
            background:#fff;
            border: 1px solid var(--accent);
            border-radius: var(--radius);
            padding: 12px 16px;
            display:flex;
            justify-content: space-between;
            align-items:center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .crumb-left { display:flex; align-items:center; gap: 8px; flex-wrap: wrap; min-width: 0; }

        .crumb-home, .crumb-sep, .crumb-link, .crumb-current {
            font-weight: 900;
            font-size: 14px;
            color: var(--accent);
        }

        .crumb-home { display:inline-flex; align-items:center; gap:6px; text-decoration: none; cursor:pointer; }

        .detail-section{
            border-bottom: 1px solid var(--line);
            padding-bottom: 40px;
            margin-bottom: 40px;
        }

        .detail-container {
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 60px;
            align-items: start;
        }

        .cover-area { position: relative; }
        .cover{
            width: 100%;
            aspect-ratio: 1 / 1.45;
            border-radius: var(--radius);
            border: 1px solid var(--line);
            overflow:hidden;
            background: var(--light-bg);
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow: var(--shadow-soft);
        }

        .cover img{
            width:100%;
            height:100%;
            object-fit:cover;
            display:block;
            transition: none;
            transform: none;
        }

        .badge-ebook-ribbon{
            position: absolute; right: 45px; top: 0px; width: 55px; height: 85px;
            border-radius: 4px 4px 12px 12px;
            display:flex; align-items:center; justify-content:center;
            background:#63BCD9; color:#fff;
            font-family: 'Gamja Flower', cursive;
            font-weight: 900; font-size: 50px;
            letter-spacing: 1px;
            writing-mode: vertical-rl; text-orientation: upright;
            box-shadow: 0 8px 14px rgba(0,0,0,0.20);
            border:1px solid rgba(255,255,255,0.25);
            z-index: 2;
            user-select: none;
        }

        .info-pane{
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 0;
        }

        .header-section { border-bottom: 1px solid var(--line); padding-bottom: 24px; margin-bottom: 28px; }
        .title{ font-size: 32px; font-weight: 800; line-height: 1.3; margin: 0 0 16px 0; letter-spacing: -0.5px; word-break: keep-all; }
        .meta-row { display: flex; flex-wrap: wrap; align-items: center; gap: 14px; color: var(--muted); font-size: 15px; }
        .meta-divider { width: 1px; height: 12px; background: #ddd; display: inline-block; }

        .purchase-box{ margin-top: var(--purchase-offset); }

        .status-bar {
            background: var(--light-bg);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 24px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 20px;
        }
        .status-item { text-align: center; flex: 1; }
        .status-item:not(:last-child) { border-right: 1px solid #ddd; }
        .status-label { font-size: 14px; color: var(--muted); margin-bottom: 8px; font-weight: 600; }
        .status-value { font-size: 22px; font-weight: 800; color: var(--text); }
        .status-value .total { font-size: 16px; color: #999; font-weight: 500; }

        .format-group { display: flex; gap: 14px; margin-bottom: 14px; }
        .format-item {
            flex: 1;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            background: #fff;
            color: var(--muted);
            text-align: center;
            text-decoration: none;
            font-weight: 700;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            position: relative;
        }
        .format-item.active { border: 2px solid var(--accent); color: var(--accent); background: #fff; z-index: 1; pointer-events: none; box-shadow: 0 4px 12px rgba(220, 162, 68, 0.1); }
        .format-item:not(.active):not(.disabled):hover { background: #fafafa; border-color: #ccc; color: var(--text); }
        .format-item.disabled { background: #f9f9f9; color: #ccc; border-color: #eee; cursor: default; pointer-events: none; }
        .check-icon { font-size: 1.1em; }

        .action-area { margin-top: 0; display: flex; flex-direction: column; gap: 14px; }
        .main-buttons { display: grid; grid-template-columns: 1fr 2fr; gap: 14px; height: 56px; }
        #rentActions { display: contents; }

        .btn {
            width: 100%;
            height: 100%;
            border: 1px solid var(--accent);
            background: #fff;
            color: var(--text);
            border-radius: 8px;
            font-size: 17px;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .btn:hover { filter: brightness(0.98); }
        .btn:disabled { background: #f0f0f0; border-color: #ddd; color: #aaa; cursor: not-allowed; box-shadow: none; }

        .sub-buttons{
            display:flex;
            justify-content:flex-end;
            gap:10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn-text{
            background:#fff;
            border: 1px solid var(--line);
            color: var(--muted);
            font-size: 14px;
            font-weight: 800;
            display:inline-flex;
            align-items:center;
            gap:8px;
            cursor:pointer;
            padding: 10px 12px;
            border-radius: 999px;
            transition: transform .12s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease, color .18s ease;
            user-select: none;
        }

        .btn-text:hover{
            background: #fafafa;
            border-color: #d8d8d8;
            color: var(--text);
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(0,0,0,0.06);
        }

        .btn-text:active{ transform: translateY(0); box-shadow: none; }

        .btn-text .btn-ico{ font-size: 16px; line-height: 1; }
        .btn-text .btn-label{ line-height: 1; }

        .btn-share{ border-color: rgba(220,162,68,.35); }
        .btn-share:hover{ border-color: rgba(220,162,68,.55); }

        .btn-bookmark{ border-color: #e7e7e7; }
        .btn-bookmark.active{
            background: rgba(220,162,68,.14);
            border-color: rgba(220,162,68,.55);
            color: var(--accent);
            box-shadow: 0 10px 20px rgba(220,162,68,.16);
        }
        .btn-bookmark.active:hover{
            background: rgba(220,162,68,.18);
            border-color: rgba(220,162,68,.70);
        }

        .content-section { margin-top: 0; padding-top: 0; }
        .sec-inner{
            width: min(var(--inner-max), 100%);
            margin: 0 auto;
            padding: 40px 0;
            border-bottom: 1px solid var(--line);
        }
        .content-section:last-of-type .sec-inner{ border-bottom: none; }

        .sec-head {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .desc-text { font-size: 16px; line-height: 1.8; color: #333; white-space: pre-line; text-align: justify; }

        .review-grid { display: grid; gap: 16px; }
        .review-card { background: var(--light-bg); padding: 24px; border-radius: var(--radius); border: 1px solid transparent; }
        .review-body { font-size: 15px; color: #444; line-height: 1.6; }

        @media (max-width: 1024px) {
            :root{ --inner-max: 100%; }
            .detail-container { grid-template-columns: 1fr; gap: 26px; }
            .cover { max-width: 480px; margin: 0 auto; }
            .info-pane { text-align: center; }
            .meta-row { justify-content: center; }
            .sub-buttons { justify-content: center; }
            .main-buttons { grid-template-columns: 1fr; height: auto; }
            .main-buttons .btn{ height: 56px; }
            .purchase-box{ margin-top: 0; }
        }

        .my-review-card{
            border: 1px solid var(--line);
            border-radius: var(--radius);
            background: #fff;
            box-shadow: var(--shadow-soft);
            padding: 16px;
        }
        .my-review-top{
            display:flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--line);
            margin-bottom: 12px;
        }
        .my-review-title{ font-weight: 900; font-size: 16px; }
        .my-review-msg{ font-size: 13px; color: var(--muted); }
        .my-review-form{ display:flex; flex-direction: column; gap: 10px; }
        .my-review-row{ display:flex; align-items:center; gap: 10px; }
        .my-review-label{ font-weight: 800; font-size: 14px; color: var(--muted); width: 44px; }
        .my-review-select{ border: 1px solid var(--line); border-radius: 8px; padding: 8px 10px; }
        .my-review-input, .my-review-textarea{
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 12px;
            font-size: 14px;
        }
        .my-review-textarea{ resize: vertical; }
        .btn-review{ background: var(--accent); color: #fff; }

        .review-meta{
            display:flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--muted);
        }

        .review-meta-left{
            display:flex;
            align-items:center;
            gap:10px;
            min-width: 0;
            flex-wrap: wrap;
        }

        .review-rate{
            color: var(--accent);
            font-weight: 800;
            white-space: nowrap;
        }

        .review-author{
            font-size: 13px;
            color: #777;
            white-space: nowrap;
        }

        .review-meta-right{
            display:flex;
            align-items:center;
            gap:8px;
        }

        .review-actions{ display:flex; gap:8px; align-items:center; }
        .review-act{
            border:1px solid var(--line);
            background:#fff;
            color: var(--muted);
            font-weight: 800;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 999px;
            cursor:pointer;
            white-space: nowrap;
        }
        .review-act:hover{ background:#fafafa; color: var(--text); border-color:#d8d8d8; }
        .review-act.danger{ border-color: rgba(255,0,0,.18); }
        .review-act.danger:hover{ border-color: rgba(255,0,0,.32); }

        .review-head-left{
            display:flex;
            align-items:center;
            gap:12px;
            flex-wrap:wrap;
        }

        .review-head-kpi{
            display:flex;
            align-items:center;
            gap:8px;
            font-size:16px;
            font-weight:normal;
        }

        .review-head-right{
            display:flex;
            align-items:center;
            gap:10px;
        }

        /* ì‹ ê³  ë²„íŠ¼ */
        .review-report{
            border: 1px solid var(--line);
            background: #fff;
            color: var(--muted);
            font-weight: 800;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 999px;
            cursor: pointer;
            white-space: nowrap;
        }
        .review-report:hover{
            background:#fafafa;
            color: var(--text);
            border-color:#d8d8d8;
        }
        .review-report:disabled{
            background:#f3f3f3;
            color:#aaa;
            border-color:#eee;
            cursor:not-allowed;
        }
    </style>
</head>

<body>
<div th:replace="fragments/header :: header"></div>

<div class="wrap">
    <div class="wrap-inner">
        <main class="center">

            <div class="crumbbar">
                <div class="crumb-left">
                    <a class="crumb-home" th:href="@{/book/search}" aria-label="ê²€ìƒ‰">
                        <span aria-hidden="true">ğŸ </span><span>í™ˆ</span>
                    </a>

                    <span th:if="${view.genrePath != null and view.genrePath.crumbs != null and !view.genrePath.crumbs.isEmpty()}"
                          th:each="c, st : ${view.genrePath.crumbs}">
            <span class="crumb-sep">&rsaquo;</span>
            <a th:href="@{/book/search(mall=${view.genrePath.mall}, parentGenreId=${c.genreId})}"
               th:text="${#strings.replace(c.genreNm, '_', '')}"
               th:classappend="${st.last} ? 'crumb-current' : 'crumb-link'">ì¥ë¥´</a>
          </span>
                </div>
            </div>

            <div class="detail-section">
                <div class="section-inner">
                    <div class="detail-container">
                        <div class="cover-area">
                            <div class="cover">
                                <div class="badge-ebook-ribbon"
                                     th:if="${view.bookDetailDTO.ebookYn == 'Y'}"
                                     title="ì „ìì±…">E</div>

                                <img th:src="${#strings.isEmpty(view.bookDetailDTO.naverImage) ? view.bookDetailDTO.aladinImageBig : view.bookDetailDTO.naverImage}"
                                     alt="ë„ì„œ í‘œì§€"/>
                            </div>
                        </div>

                        <div class="info-pane">
                            <div class="header-section">
                                <h1 class="title" th:text="${view.bookDetailDTO.bookTitle}">ë„ì„œ ì œëª©</h1>
                                <div class="meta-row">
                                    <span th:text="${#strings.replace(view.bookDetailDTO.authors, '^', ', ')}">ì €ì</span>
                                    <span class="meta-divider"></span>
                                    <span th:text="${#strings.trim(#strings.replace(view.bookDetailDTO.publisher, '_', ''))}">ì¶œíŒì‚¬</span>
                                    <span class="meta-divider"></span>
                                    <span th:text="${view.bookDetailDTO.pubdate}">ì¶œê°„ì¼</span>
                                </div>
                            </div>

                            <div class="purchase-box">

                                <div class="status-bar" id="kpiBox">
                                    <div class="status-item">
                                        <div class="status-label">ëŒ€ì—¬í˜„í™©</div>
                                        <div class="status-value">
                                            <span id="lendingCnt">0</span>
                                            <span class="total">/ <span id="ownedCnt" th:text="${view.inventory.totalCount}">0</span>ê¶Œ</span>
                                        </div>
                                    </div>
                                    <div class="status-item">
                                        <div class="status-label">ì˜ˆì•½ëŒ€ê¸°</div>
                                        <div class="status-value">
                                            <span id="rsvActiveCnt">0</span>
                                            <span class="total">/ <span id="rsvLimit">10</span>ëª…</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="format-group">
                                    <a class="format-item"
                                       th:classappend="${view.bookDetailDTO.ebookYn == 'N'} ? 'active' : (${view.pairYn == 'N'} ? 'disabled' : '')"
                                       th:href="@{ ${ (view.bookDetailDTO.ebookYn == 'Y' and view.pairYn == 'Y') ? ('/book/detail/' + view.pairIsbn13) : '#' } }"
                                       th:title="${view.bookDetailDTO.ebookYn == 'N'} ? 'í˜„ì¬ ì¢…ì´ì±… ë³´ê³  ìˆìŒ' : 'ì¢…ì´ì±… í˜ì´ì§€ë¡œ ì´ë™'">
                                        <span th:if="${view.bookDetailDTO.ebookYn == 'N'}" class="check-icon">âœ”</span>
                                        ì¢…ì´ì±…
                                    </a>

                                    <a class="format-item"
                                       th:classappend="${view.bookDetailDTO.ebookYn == 'Y'} ? 'active' : (${view.pairYn == 'N'} ? 'disabled' : '')"
                                       th:href="@{ ${ (view.bookDetailDTO.ebookYn == 'N' and view.pairYn == 'Y') ? ('/book/detail/' + view.pairIsbn13) : '#' } }"
                                       th:title="${view.bookDetailDTO.ebookYn == 'Y'} ? 'í˜„ì¬ ì „ìì±… ë³´ê³  ìˆìŒ' : 'ì „ìì±… í˜ì´ì§€ë¡œ ì´ë™'">
                                        <span th:if="${view.bookDetailDTO.ebookYn == 'Y'}" class="check-icon">âœ”</span>
                                        ì „ìì±…
                                    </a>
                                </div>

                                <div class="action-area">
                                    <div class="main-buttons">
                                        <button id="btnCart"
                                                class="btn"
                                                type="button"
                                                th:attr="data-isbn=${view.bookDetailDTO.isbn13}">
                                            <span id="cartText">ì¥ë°”êµ¬ë‹ˆ</span>
                                        </button>

                                        <div id="rentActions">
                                            <button class="btn" disabled>í™•ì¸ì¤‘...</button>
                                        </div>
                                    </div>

                                    <div class="rent-hint" id="rentHint"></div>

                                    <div class="sub-buttons">
                                        <button id="btnShare" class="btn-text btn-share" type="button" title="ì£¼ì†Œ ë³µì‚¬">
                                            <span class="btn-ico" aria-hidden="true">ğŸ”—</span>
                                            <span class="btn-label">ê³µìœ í•˜ê¸°</span>
                                        </button>

                                        <button id="btnBookmark"
                                                class="btn-text btn-bookmark"
                                                type="button"
                                                th:attr="data-isbn=${view.bookDetailDTO.isbn13}"
                                                aria-pressed="false">
                                            <span class="btn-ico" id="bookmarkIcon" aria-hidden="true">â˜†</span>
                                            <span class="btn-label" id="bookmarkText">ë¶ë§ˆí¬</span>
                                        </button>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="content-section">
                <div class="sec-inner">
                    <div class="sec-head">ë„ì„œ ì†Œê°œ</div>
                    <div class="desc-text" th:text="${view.bookDetailDTO.description}">ì„¤ëª…</div>
                </div>
            </div>

            <div class="content-section">
                <div class="sec-inner">
                    <div class="sec-head">
                        <div class="review-head-left">
                            <span>ë¦¬ë·°</span>

                            <div class="review-head-kpi">
                                <span style="color:var(--accent);">â˜…</span>
                                <strong id="ratingAvg"
                                        th:text="${view.reviewSummary != null ? view.reviewSummary.ratingAvg : 0.0}">0.0</strong>
                                <span style="color:#aaa;">
                  (<span id="reviewCnt"
                         th:text="${view.reviewSummary != null ? view.reviewSummary.reviewCnt : 0}">0</span>ê°œ)
                </span>
                            </div>
                        </div>

                        <div class="review-head-right">
                            <button id="btnOpenReview" class="btn-text" type="button" title="ë¦¬ë·° ì‘ì„±">
                                <span class="btn-ico" aria-hidden="true">âœ</span>
                                <span class="btn-label" id="btnOpenReviewText">ë¦¬ë·° ì‘ì„±</span>
                            </button>
                        </div>
                    </div>

                    <div id="myReviewBox" style="display:none; margin-top: 14px;">
                        <div class="my-review-card">
                            <div class="my-review-top">
                                <div class="my-review-title" id="myReviewTitleText">ë¦¬ë·° ì‘ì„±</div>
                                <div class="my-review-msg" id="reviewPermMsg"></div>
                            </div>

                            <div class="my-review-form">
                                <div class="my-review-row">
                                    <label class="my-review-label">í‰ì </label>
                                    <select id="reviewRate" class="my-review-select">
                                        <option value="5">5</option><option value="4">4</option><option value="3">3</option>
                                        <option value="2">2</option><option value="1">1</option>
                                    </select>
                                    <span style="color:var(--accent); font-weight:900;">â˜…</span>
                                </div>

                                <input id="reviewTitle" type="text" placeholder="ì œëª©(ì„ íƒ)" class="my-review-input">
                                <textarea id="reviewContent" rows="5" placeholder="ë¦¬ë·° ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”" class="my-review-textarea"></textarea>

                                <div class="my-review-actions">
                                    <button id="btnReviewSave" class="btn btn-review" type="button">ë¦¬ë·° ì €ì¥</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="reviewList" class="review-grid"></div>

                    <div id="reviewEmpty"
                         class="desc-text"
                         style="text-align: center; color: #999; padding: 40px; display:none;">
                        ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.
                    </div>

                    <div id="reviewPager"
                         style="margin-top:16px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
                    </div>
                </div>
            </div>

        </main>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {

        let lastReviewItems = [];

        const isbn13 = /*[[${view.bookDetailDTO.isbn13}]]*/ "";
        const initialBookmarkedYn = /*[[${view.bookmarkedYn}]]*/ "N";

        let reviewPage = 1;
        const reviewSize = 5;

        // -----------------------------
        // ê³µí†µ
        // -----------------------------
        function goLoginReturnHere() {
            const returnUrl = location.pathname + location.search + location.hash;
            location.href = "/users/login?redirect=" + encodeURIComponent(returnUrl);
        }

        async function fetchJson(url, options = {}, onAuth = "silent") {
            const res = await fetch(url, {
                headers: {"Accept": "application/json", ...(options.headers || {})},
                ...options
            });

            const ct = res.headers.get("content-type") || "";
            const authFail = (res.status === 401 || res.status === 403 || ct.includes("text/html") || res.redirected);

            if (authFail) {
                if (onAuth === "redirect") goLoginReturnHere();
                return null;
            }
            if (!res.ok) throw new Error("HTTP " + res.status);
            return await res.json();
        }

        async function postForm(url, bodyObj, onAuth = "redirect") {
            const body = new URLSearchParams(bodyObj).toString();
            const res = await fetch(url, {
                method: "POST",
                headers: {"Content-Type": "application/x-www-form-urlencoded", "Accept": "application/json"},
                body
            });

            const ct = res.headers.get("content-type") || "";
            const authFail = (res.status === 401 || res.status === 403 || ct.includes("text/html") || res.redirected);

            if (authFail) {
                if (onAuth === "redirect") goLoginReturnHere();
                return null;
            }
            if (!res.ok) throw new Error("HTTP " + res.status);
            return res;
        }

        async function postJson(url, bodyObj, onAuth = "redirect") {
            const res = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify(bodyObj ?? {})
            });

            const ct = res.headers.get("content-type") || "";
            const authFail = (res.status === 401 || res.status === 403 || ct.includes("text/html") || res.redirected);

            if (authFail) {
                if (onAuth === "redirect") goLoginReturnHere();
                return null;
            }

            // ì„œë²„ê°€ 400/500ì„ JSONìœ¼ë¡œ ë‚´ë ¤ì¤„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ json ë¨¼ì € ì‹œë„
            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
                // ì„œë²„ê°€ message ë‚´ë ¤ì£¼ë©´ ê·¸ê±¸ ì“°ê³ , ì•„ë‹ˆë©´ ìƒíƒœì½”ë“œë¡œ ì²˜ë¦¬
                throw new Error(data.message || ("HTTP " + res.status));
            }

            return data;
        }




        function esc(s){
            return String(s ?? "").replace(/[&<>"']/g, m => (
                {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]
            ));
        }
        function fmtDate(iso){
            if(!iso) return "";
            const d = new Date(iso);
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            const day = String(d.getDate()).padStart(2,'0');
            return `${y}.${m}.${day}`;
        }
        function isMine(r){
            const v = (r?.mineYn ?? r?.myReviewYn ?? r?.myReview ?? r?.myYn);
            const s = String(v ?? "").toUpperCase();
            return s === "Y" || s === "TRUE" || s === "1";
        }

        // -----------------------------
        // ë¶ë§ˆí¬
        // -----------------------------
        const btnBm = document.getElementById("btnBookmark");
        const iconEl = document.getElementById("bookmarkIcon");
        const textEl = document.getElementById("bookmarkText");

        function renderBookmark(yn) {
            const isOn = (yn === "Y");
            if (isOn) {
                iconEl.textContent = "â˜…";
                btnBm.classList.add("active");
                btnBm.setAttribute("aria-pressed", "true");
                textEl.textContent = "ë¶ë§ˆí¬ë¨";
            } else {
                iconEl.textContent = "â˜†";
                btnBm.classList.remove("active");
                btnBm.setAttribute("aria-pressed", "false");
                textEl.textContent = "ë¶ë§ˆí¬";
            }
        }

        renderBookmark(initialBookmarkedYn);

        btnBm?.addEventListener("click", async () => {
            btnBm.disabled = true;
            try {
                const data = await fetchJson(`/api/bookmarks/${encodeURIComponent(isbn13)}/toggle`, { method: "POST" }, "redirect");
                if (!data) return;
                renderBookmark(data.bookmarkedYn);
            } catch (e) {
                console.error(e);
                alert("ë¶ë§ˆí¬ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                btnBm.disabled = false;
            }
        });

        // -----------------------------
        // ì¥ë°”êµ¬ë‹ˆ
        // -----------------------------
        const btnCart = document.getElementById("btnCart");
        const cartTextEl = document.getElementById("cartText");

        function renderCartState(inCart) {
            cartTextEl.textContent = inCart ? "ë‹´ê¹€ âœ“" : "ì¥ë°”êµ¬ë‹ˆ";
        }

        async function loadCartStatus() {
            try {
                const data = await fetchJson(`/book/cart/${encodeURIComponent(isbn13)}/status`, {}, "silent");
                if (!data) { renderCartState(false); return; }
                renderCartState(!!data.inCart);
            } catch (e) {
                console.error(e);
            }
        }

        btnCart?.addEventListener("click", async () => {
            btnCart.disabled = true;
            try {
                const data = await fetchJson(`/book/cart/${encodeURIComponent(isbn13)}/toggle`, { method: "POST" }, "redirect");
                if (!data) return;
                renderCartState(!!data.inCart);
            } catch (e) {
                console.error(e);
                alert("ì¥ë°”êµ¬ë‹ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                btnCart.disabled = false;
            }
        });

        loadCartStatus();

        // -----------------------------
        // ê³µìœ 
        // -----------------------------
        const btnShare = document.getElementById("btnShare");

        async function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
                return;
            }
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            document.execCommand("copy");
            ta.remove();
        }

        btnShare?.addEventListener("click", async () => {
            try {
                await copyToClipboard(location.href);
                alert("ë§í¬ ë³µì‚¬ ì™„ë£Œ!");
            } catch (e) {
                alert("ì£¼ì†Œì°½ì„ ë³µì‚¬í•´ì£¼ì„¸ìš”.");
            }
        });

        // -----------------------------
        // ëŒ€ì—¬/ì˜ˆì•½/ì—°ì¥
        // -----------------------------
        const $rentActions = document.getElementById("rentActions");
        const $rentHint = document.getElementById("rentHint");

        function setRentHint(msg) {
            if ($rentHint) $rentHint.textContent = msg || "";
        }

        function buildRentButtons(it) {
            if (!it) return `<button class="btn" disabled>ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨</button>`;

            if (it.myLendYn === "Y") {
                if (it.myExtendYn === "Y") {
                    setRentHint("ë°˜ë‚©ì˜ˆì •ì¼ 7ì¼ ì´ë‚´ & ì—°ì¥ 1íšŒ ë¯¸ì‚¬ìš©ì´ë©´ ì—°ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    return `<button class="btn btn-extend" data-lend-id="${it.myLendId}">ì—°ì¥í•˜ê¸°</button>
                  <button class="btn" disabled style="background:#f0f0f0; border:none; color:#aaa;">ëŒ€ì—¬ì¤‘</button>`;
                }
                setRentHint("í˜„ì¬ ì´ ë„ì„œë¥¼ ëŒ€ì—¬ ì¤‘ì…ë‹ˆë‹¤.");
                return `<button class="btn" disabled>ëŒ€ì—¬ì¤‘</button>`;
            }

            if (Number(it.availableCnt) > 0) {
                setRentHint("ëŒ€ì—¬í•˜ê¸°ë¥¼ ëˆ„ë¥´ë©´ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ í›„ ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                return `<button class="btn btn-addcart">ëŒ€ì—¬í•˜ê¸°</button>`;
            }

            if (it.myRsvYn === "Y") {
                setRentHint("ì´ë¯¸ ì˜ˆì•½í•œ ë„ì„œì…ë‹ˆë‹¤.");
                return `<button class="btn btn-rsv-cancel" data-rsv-id="${it.myRsvId}"
                  style="background:#fff; color:var(--text); border-color:#ccc;">ì˜ˆì•½ì·¨ì†Œ</button>`;
            }

            if (it.userBlockedYn === "Y" || it.userOverdueYn === "Y" || it.rsvLimitYn === "Y") {
                let reason = "ì˜ˆì•½ ë¶ˆê°€";
                if (it.userBlockedYn === "Y") reason = "ì°¨ë‹¨ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤.";
                else if (it.userOverdueYn === "Y") reason = "ì—°ì²´ ì¤‘ì…ë‹ˆë‹¤.";
                else if (it.rsvLimitYn === "Y") reason = "ì˜ˆì•½ ì¸ì› ì´ˆê³¼";
                setRentHint(reason);
                return `<button class="btn" disabled>ì˜ˆì•½ ë¶ˆê°€</button>`;
            }

            setRentHint("ëª¨ë“  ì±…ì´ ëŒ€ì—¬ì¤‘ì´ë¯€ë¡œ ì˜ˆì•½ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            return `<button class="btn btn-rsv">ì˜ˆì•½í•˜ê¸°</button>`;
        }

        function updateKpiByStatus(dto) {
            const lendingCntEl = document.getElementById("lendingCnt");
            const ownedCntEl = document.getElementById("ownedCnt");
            const rsvActiveCntEl = document.getElementById("rsvActiveCnt");
            const rsvLimitEl = document.getElementById("rsvLimit");

            if (ownedCntEl && dto?.ownedCnt != null) ownedCntEl.textContent = String(dto.ownedCnt);
            if (lendingCntEl && dto?.lendingCnt != null) lendingCntEl.textContent = String(dto.lendingCnt);
            if (rsvActiveCntEl && dto?.rsvActiveCnt != null) rsvActiveCntEl.textContent = String(dto.rsvActiveCnt);
            if (rsvLimitEl) rsvLimitEl.textContent = String(dto?.rsvLimit ?? 10);
        }

        async function loadCirculationStatus() {
            try {
                const dto = await fetchJson(`/book/circulation/status?isbn13=${encodeURIComponent(isbn13)}`, {}, "silent");

                if (!dto) {
                    setRentHint("ë¡œê·¸ì¸ í›„ ëŒ€ì—¬/ì˜ˆì•½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    $rentActions.innerHTML = `<button class="btn btn-login">ë¡œê·¸ì¸ í›„ ì´ìš©</button>`;
                    return;
                }

                updateKpiByStatus(dto);
                $rentActions.innerHTML = buildRentButtons(dto);
            } catch (e) {
                console.error(e);
                setRentHint("ìƒíƒœ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                $rentActions.innerHTML = `<button class="btn" disabled>ì¡°íšŒ ì‹¤íŒ¨</button>`;
            }
        }

        $rentActions?.addEventListener("click", async (e) => {
            const b = e.target.closest("button");
            if (!b) return;

            if (b.classList.contains("btn-login")) {
                goLoginReturnHere();
                return;
            }

            try {
                if (b.classList.contains("btn-rsv")) {
                    const res = await postForm("/book/circulation/reserve", {isbn13}, "redirect");
                    if (res) await loadCirculationStatus();
                    return;
                }
                if (b.classList.contains("btn-rsv-cancel")) {
                    const rsvId = b.dataset.rsvId;
                    const res = await postForm("/book/circulation/reserve/cancel", {rsvId}, "redirect");
                    if (res) await loadCirculationStatus();
                    return;
                }
                if (b.classList.contains("btn-extend")) {
                    const lendId = b.dataset.lendId;
                    const res = await postForm("/book/circulation/extend", {lendId}, "redirect");
                    if (res) await loadCirculationStatus();
                    return;
                }
                if (b.classList.contains("btn-addcart")) {
                    const res = await postForm("/book/cart/add", {isbn13}, "redirect");
                    if (res) location.href = "/book/cart";
                    return;
                }
            } catch (e2) {
                console.error(e2);
                alert("ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });

        loadCirculationStatus();

        // -----------------------------
        // ë¦¬ë·° KPI + ë¦¬ìŠ¤íŠ¸
        // -----------------------------
        const ratingAvgEl = document.getElementById("ratingAvg");
        const reviewCntEl = document.getElementById("reviewCnt");

        async function loadReviewStatus() {
            try {
                const dto = await fetchJson(`/book/reviewstatus/${encodeURIComponent(isbn13)}`, {}, "silent");
                if (!dto) return;
                if (ratingAvgEl) ratingAvgEl.textContent = Number(dto.ratingAvg ?? 0).toFixed(1);
                if (reviewCntEl) reviewCntEl.textContent = String(dto.reviewCnt ?? 0);
            } catch (e) {
                console.error(e);
            }
        }

        async function loadReviewList(page = 1){
            reviewPage = Math.max(1, Number(page || 1));

            const dto = await fetchJson(
                `/book/review/list?isbn13=${encodeURIComponent(isbn13)}&page=${reviewPage}&size=${reviewSize}`,
                {},
                "silent"
            );
            if (!dto) return;

            if (dto.summary) {
                if (ratingAvgEl) ratingAvgEl.textContent = Number(dto.summary.ratingAvg ?? 0).toFixed(1);
                if (reviewCntEl) reviewCntEl.textContent = String(dto.summary.reviewCnt ?? 0);
            }

            renderReviewList(dto.items || []);
            renderReviewPager(dto.total ?? 0, dto.page ?? reviewPage, dto.size ?? reviewSize);
        }

        function renderReviewList(items){
            const listEl = document.getElementById("reviewList");
            const emptyEl = document.getElementById("reviewEmpty");
            if(!listEl || !emptyEl) return;

            lastReviewItems = items || [];

            if(!items || items.length === 0){
                listEl.innerHTML = "";
                emptyEl.style.display = "block";
                return;
            }
            emptyEl.style.display = "none";

            listEl.innerHTML = items.map(r => {
                const mine = isMine(r);

                const actions = mine ? `
          <div class="review-actions">
            <button type="button" class="review-act js-review-edit" data-feed-id="${esc(r.feedId)}">ìˆ˜ì •</button>
            <button type="button" class="review-act danger js-review-del" data-feed-id="${esc(r.feedId)}">ì‚­ì œ</button>
          </div>
        ` : ``;

                const reportBtn = (!mine) ? `
          <button type="button"
                  class="review-report js-report"
                  data-feed-id="${esc(r.feedId)}"
                  title="ë¦¬ë·° ì‹ ê³ ">ì‹ ê³ </button>
        ` : ``;

                return `
          <div class="review-card" data-feed-id="${esc(r.feedId)}">
            <div class="review-meta">
              <div class="review-meta-left">
                <span class="review-rate">â˜… ${esc(r.rate)}</span>
                <span class="review-author">
                  ${esc(r.profileNm)} Â· ${esc(fmtDate(r.createdAt))}
                </span>
                ${reportBtn}
              </div>

              ${actions ? `<div class="review-meta-right">${actions}</div>` : ``}
            </div>

            ${r.title ? `<div style="font-weight:bold; margin-bottom:6px;">${esc(r.title)}</div>` : ``}
            <div class="review-body">${esc(r.content)}</div>
          </div>
        `;
            }).join("");
        }

        function renderReviewPager(total, page, size){
            const pagerEl = document.getElementById("reviewPager");
            if(!pagerEl) return;

            const totalElements = Number(total || 0);
            const cur = Math.max(1, Number(page || 1));
            const per = Math.max(1, Number(size || 5));
            const totalPages = Math.max(1, Math.ceil(totalElements / per));

            if(totalPages <= 1){
                pagerEl.innerHTML = "";
                return;
            }

            const mkBtn = (label, target, disabled=false, active=false) => `
        <button type="button"
          data-page="${target}"
          ${disabled ? "disabled" : ""}
          style="
            border:1px solid var(--line);
            background:${active ? "var(--accent)" : "#fff"};
            color:${active ? "#fff" : "var(--text)"};
            padding:8px 12px;
            border-radius:999px;
            font-weight:800;
            cursor:${disabled ? "not-allowed" : "pointer"};
          ">
          ${label}
        </button>
      `;

            const windowSize = 5;
            const half = Math.floor(windowSize / 2);
            let start = Math.max(1, cur - half);
            let end = Math.min(totalPages, start + windowSize - 1);
            start = Math.max(1, end - windowSize + 1);

            let html = "";
            html += mkBtn("ì´ì „", cur - 1, cur <= 1);

            if(start > 1){
                html += mkBtn("1", 1, false, cur === 1);
                if(start > 2) html += `<span style="padding:8px 6px; color:#999;">â€¦</span>`;
            }

            for(let p = start; p <= end; p++){
                html += mkBtn(String(p), p, false, p === cur);
            }

            if(end < totalPages){
                if(end < totalPages - 1) html += `<span style="padding:8px 6px; color:#999;">â€¦</span>`;
                html += mkBtn(String(totalPages), totalPages, false, cur === totalPages);
            }

            html += mkBtn("ë‹¤ìŒ", cur + 1, cur >= totalPages);
            pagerEl.innerHTML = html;
        }

        document.getElementById("reviewPager")?.addEventListener("click", (e) => {
            const b = e.target.closest("button[data-page]");
            if(!b || b.disabled) return;
            const p = Number(b.dataset.page);
            if(p >= 1) {
                loadReviewList(p);
                document.getElementById("reviewList")?.scrollIntoView({behavior:"smooth", block:"start"});
            }
        });

        // ì´ˆê¸° ë¡œë“œ
        loadReviewStatus();
        loadReviewList(reviewPage);

        // =============================
        // ë¦¬ë·° ì‘ì„±/ì €ì¥/ìˆ˜ì •/ì‚­ì œ
        // =============================
        const btnOpenReview = document.getElementById("btnOpenReview");
        const myReviewBox = document.getElementById("myReviewBox");
        const reviewPermMsg = document.getElementById("reviewPermMsg");
        const btnReviewSave = document.getElementById("btnReviewSave");

        const reviewRateEl = document.getElementById("reviewRate");
        const reviewTitleEl = document.getElementById("reviewTitle");
        const reviewContentEl = document.getElementById("reviewContent");

        // ìˆ˜ì • ëª¨ë“œ í”„ë¦¬í•„ìš©(í´ë¼ ìƒíƒœ)
        let editingFeedId = null;

        function openMyReviewBox(modeText, msg){
            myReviewBox.style.display = "block";
            if (reviewPermMsg) reviewPermMsg.textContent = msg ?? "";
            const titleEl = document.getElementById("myReviewTitleText");
            if (titleEl) titleEl.textContent = modeText;
            myReviewBox.scrollIntoView({behavior:"smooth", block:"start"});
        }

        btnOpenReview?.addEventListener("click", async () => {
            try {
                const perm = await fetchJson(`/book/review/permission?isbn13=${encodeURIComponent(isbn13)}`, {}, "redirect");
                if (!perm) return;

                const allowed = (perm.allowedYn === "Y");
                const msg = (perm.message ?? "");

                btnReviewSave.disabled = !allowed;

                const hasReview = (perm.hasReviewYn === "Y");
                editingFeedId = hasReview ? (perm.myFeedId ?? null) : null;

                openMyReviewBox(hasReview ? "ë¦¬ë·° ìˆ˜ì •" : "ë¦¬ë·° ì‘ì„±", msg);

                if (hasReview && editingFeedId) {
                    const mine = lastReviewItems.find(x => String(x.feedId) === String(editingFeedId));
                    if (mine) {
                        if (reviewRateEl) reviewRateEl.value = String(mine.rate ?? 5);
                        if (reviewTitleEl) reviewTitleEl.value = mine.title ?? "";
                        if (reviewContentEl) reviewContentEl.value = mine.content ?? "";
                    }
                }

                if (allowed) reviewContentEl?.focus();
            } catch (e) {
                console.error(e);
                alert("ë¦¬ë·° ì‘ì„± ê¶Œí•œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });

        btnReviewSave?.addEventListener("click", async () => {
            const rate = Number(reviewRateEl?.value ?? 5);
            const title = (reviewTitleEl?.value ?? "").trim();
            const content = (reviewContentEl?.value ?? "").trim();

            if (!content) { alert("ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); reviewContentEl?.focus(); return; }

            btnReviewSave.disabled = true;
            try {
                const payload = { isbn13, rate, title, content };
                const data = await postJson("/book/review/save", payload, "redirect");
                if (!data) return;

                if (!data.ok) {  // ì„œë²„ê°€ {ok:true, feedId:...} í˜•íƒœë¼ê³  ê°€ì •
                    alert(data.message || "ë¦¬ë·°ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    return;
                }

                editingFeedId = data.feedId ?? editingFeedId;
                alert("ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                await loadReviewList(1);
                await loadReviewStatus();
            } catch (e) {
                console.error(e);
                alert("ë¦¬ë·° ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                btnReviewSave.disabled = false;
            }
        });


        // =============================
        // ì‹ ê³  ì²˜ë¦¬(ì¶”ê°€)
        // =============================
        function markReported(btn){
            if (!btn) return;
            btn.textContent = "ì‹ ê³ ë¨";
            btn.disabled = true;
            btn.dataset.reported = "Y";
        }

        async function checkReported(feedId){
            const data = await fetchJson(`/api/reports/exists?feedId=${encodeURIComponent(feedId)}`, {}, "redirect");
            if (!data) return null; // redirect ëê±°ë‚˜ ì¸ì¦ ì‹¤íŒ¨
            return !!data.reported;
        }

        async function createReport(feedId, reason){
            const res = await fetch("/api/reports", {
                method: "POST",
                headers: {"Content-Type":"application/json","Accept":"application/json"},
                body: JSON.stringify({ feedId, reportContent: reason.trim() })
            });

            // 401ì´ë©´ ë°”ë¡œ ë¡œê·¸ì¸
            if (res.status === 401) {
                goLoginReturnHere();
                return { res, data: { code:"UNAUTHORIZED" } };
            }

            const data = await res.json().catch(() => ({}));
            return { res, data };
        }


        // ë¦¬ìŠ¤íŠ¸ ë‚´ë¶€ ìˆ˜ì •/ì‚­ì œ/ì‹ ê³ 
        document.getElementById("reviewList")?.addEventListener("click", async (e) => {
            const delBtn = e.target.closest(".js-review-del");
            const editBtn = e.target.closest(".js-review-edit");
            const reportBtn = e.target.closest(".js-report");

            // ---- ì‹ ê³  ----
            if (reportBtn) {
                const feedId = reportBtn.dataset.feedId;
                if (!feedId) return;

                // ì´ë¯¸ UIì—ì„œ ì‹ ê³ ë¨ì´ë©´ ì¢…ë£Œ
                if (reportBtn.dataset.reported === "Y" || reportBtn.disabled) {
                    alert("ì´ë¯¸ ì‹ ê³ í•œ ë¦¬ë·°ì…ë‹ˆë‹¤.");
                    return;
                }

                // 1) ì‚¬ì „ ì²´í¬(ì´ë¯¸ ì‹ ê³ í–ˆëŠ”ì§€)
                try {
                    reportBtn.disabled = true;

                    const already = await checkReported(feedId);
                    if (already === null) return; // ë¡œê·¸ì¸ redirect ë¨
                    if (already) {
                        alert("ì´ë¯¸ ì‹ ê³ í•œ ë¦¬ë·°ì…ë‹ˆë‹¤.");
                        markReported(reportBtn);
                        return;
                    }

                    // 2) ì‚¬ìœ  ì…ë ¥
                    const reason = prompt("ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
                    if (!reason || !reason.trim()) {
                        reportBtn.disabled = false;
                        return;
                    }

                    // 3) ì‹ ê³  ë“±ë¡
                    const { res, data } = await createReport(feedId, reason.trim());

                    if (res.status === 401 || data.code === "UNAUTHORIZED") {
                        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        goLoginReturnHere();
                        return;
                    }

                    if (data.code === "ALREADY_REPORTED") {
                        alert("ì´ë¯¸ ì‹ ê³ í•œ ë¦¬ë·°ì…ë‹ˆë‹¤.");
                        markReported(reportBtn);
                        return;
                    }

                    if (data.code === "INVALID_TARGET") {
                        alert("ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì‚­ì œëœ ë¦¬ë·°ì…ë‹ˆë‹¤.");
                        reportBtn.disabled = false;
                        return;
                    }

                    if (data.code === "OK") {
                        alert("ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        markReported(reportBtn);
                        return;
                    }

                    if (data.code === "SELF_REPORT_NOT_ALLOWED") {
                        alert("ë³¸ì¸ ë¦¬ë·°ëŠ” ì‹ ê³ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        reportBtn.disabled = false;
                        return;
                    }


                    alert("ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    reportBtn.disabled = false;

                } catch (err) {
                    console.error(err);
                    alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    reportBtn.disabled = false;
                }
                return;
            }

            // ---- ìˆ˜ì • ----
            if (editBtn) {
                const feedId = editBtn.dataset.feedId;
                const item = lastReviewItems.find(x => String(x.feedId) === String(feedId));
                if (!item) return;

                editingFeedId = feedId;

                if (reviewRateEl) reviewRateEl.value = String(item.rate ?? 5);
                if (reviewTitleEl) reviewTitleEl.value = item.title ?? "";
                if (reviewContentEl) reviewContentEl.value = item.content ?? "";

                try {
                    const perm = await fetchJson(`/book/review/permission?isbn13=${encodeURIComponent(isbn13)}`, {}, "redirect");
                    if (!perm) return;
                    const allowed = (perm.allowedYn === "Y");
                    btnReviewSave.disabled = !allowed;
                    openMyReviewBox("ë¦¬ë·° ìˆ˜ì •", perm.message ?? "");
                    if (allowed) reviewContentEl?.focus();
                } catch (err) {
                    console.error(err);
                    openMyReviewBox("ë¦¬ë·° ìˆ˜ì •", "");
                }
                return;
            }

            // ---- ì‚­ì œ ----
            if (delBtn) {
                const feedId = delBtn.dataset.feedId;
                if (!feedId) return;

                if (!confirm("ë¦¬ë·°ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;

                try {
                    const data = await fetchJson(`/book/review/${encodeURIComponent(feedId)}`, { method: "DELETE" }, "redirect");
                    if (!data?.ok) {
                        alert("ì‚­ì œ ì‹¤íŒ¨");
                        return;
                    }

                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    await loadReviewList(Math.max(1, reviewPage));
                    await loadReviewStatus();

                    if (editingFeedId && String(editingFeedId) === String(feedId)) {
                        editingFeedId = null;
                        if (reviewRateEl) reviewRateEl.value = "5";
                        if (reviewTitleEl) reviewTitleEl.value = "";
                        if (reviewContentEl) reviewContentEl.value = "";
                    }
                } catch (err) {
                    console.error(err);
                    alert("ë¦¬ë·° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            }
        });

    });
</script>

<div th:replace="fragments/footer :: footer"></div>
</body>
</html>
