!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>도서 대여 시스템 - 통합 문의/신고 관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --main-color: #DCA244; --hover-color: #C8903A; }
        .bg-main { background-color: var(--main-color); }
        .text-main { color: var(--main-color); }

        .nav-item { display: flex; align-items: center; gap: 12px; padding: 16px 24px; cursor: pointer; transition: all 0.2s; color: rgba(255,255,255,0.7); font-weight: 500; }
        .nav-item:hover { background-color: rgba(255,255,255,0.1); color: white; }
        .active-tab { background-color: rgba(255, 255, 255, 0.15); border-left: 4px solid white; color: white; font-weight: 700; }

        .table-container { background: white; border-radius: 24px; border: 1px solid #E5E7EB; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); min-height: 400px; }
        .th-style { padding: 18px 24px; font-size: 12px; font-weight: 800; color: #9CA3AF; text-transform: uppercase; background: #F9FAFB; border-bottom: 1px solid #E5E7EB; transition: background 0.2s; }
        .td-style { padding: 16px 24px; border-bottom: 1px solid #F3F4F6; }

        .summary-card { padding: 20px 24px; border-radius: 20px; border: 1px solid #E5E7EB; display: flex; align-items: center; justify-content: space-between; background: white; transition: all 0.2s; cursor: pointer; border-bottom: 4px solid transparent; }
        .summary-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .active-card { border-bottom: 4px solid var(--main-color) !important; background-color: #FDFBF7 !important; }

        .badge-custom { padding: 5px 14px; border-radius: 9999px; font-size: 11px; font-weight: 800; }
        .badge-waiting { background-color: #FFEDD5; color: #EA580C; }
        .badge-done { background-color: #DCFCE7; color: #166534; }

        .btn-main { background-color: var(--main-color); color: white; padding: 10px 28px; border-radius: 12px; font-weight: bold; transition: all 0.2s; border: none; cursor: pointer; }
        .action-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: #9CA3AF; transition: all 0.2s; background: none; border: none; cursor: pointer; }
        .action-btn:hover { background-color: #F3F4F6; color: var(--main-color); }

        .pagination-btn { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 13px; font-weight: 700; color: #9CA3AF; transition: all 0.2s; cursor: pointer; border: none; background: transparent; text-decoration: none; }
        .pagination-btn:hover:not(.disabled) { background-color: #F3F4F6; color: #374151; }
        .pagination-btn.active { background-color: var(--main-color); color: white; box-shadow: 0 4px 10px rgba(220, 162, 68, 0.2); }
        .pagination-btn.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }

        .sort-link { display: inline-flex; flex-direction: column; vertical-align: middle; margin-left: 6px; line-height: 0.7; }
        .sort-link i { font-size: 10px; color: #D1D5DB; }
        .sort-link i.active { color: var(--main-color); }
    </style>
</head>
<body class="bg-gray-50 flex h-screen overflow-hidden">

<nav class="w-64 bg-main text-white flex flex-col shadow-xl z-50">
    <div class="p-8 text-2xl font-black border-b border-white/10 flex items-center gap-3">
        <i class="fas fa-book-reader"></i> <span>ADMIN</span>
    </div>
    <div class="flex-1 overflow-y-auto py-4">
        <div class="px-6 mb-2 text-[10px] font-bold text-white/40 uppercase tracking-widest">Main Menu</div>
        <ul class="space-y-1">
            <li><a href="/admin/Statistics" class="nav-item"><i class="fas fa-chart-pie w-5 text-center"></i> 대시보드</a></li>
            <li><a href="/admin/BookManageMent" class="nav-item"><i class="fas fa-book w-5 text-center"></i> 도서관리</a></li>
            <li><a href="/admin/UserManageMent" class="nav-item"><i class="fas fa-users w-5 text-center"></i> 회원관리</a></li>
        </ul>
        <div class="px-6 mt-8 mb-2 text-[10px] font-bold text-white/40 uppercase tracking-widest">Support & Service</div>
        <ul class="space-y-1">
            <li><a href="/admin/Inquiries" class="nav-item active-tab"><i class="fas fa-question-circle w-5 text-center"></i> 문의관리</a></li>
            <li><a href="/admin/Notifications" class="nav-item"><i class="fas fa-bell w-5 text-center"></i> 알림관리</a></li>
        </ul>
        <div class="px-6 mt-8 mb-2 text-[10px] font-bold text-white/40 uppercase tracking-widest">System</div>
        <ul class="space-y-1">
            <li><a href="/admin/Settings" class="nav-item"><i class="fas fa-cog w-5 text-center"></i> 시스템 설정</a></li>
        </ul>
    </div>
    <div class="p-6 bg-black/10">
        <div class="flex items-center justify-between group">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center font-bold text-sm border border-white/10">AD</div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold truncate">관리자 님</p>
                    <p class="text-[10px] text-white/50 uppercase tracking-tighter font-medium">Master Account</p>
                </div>
            </div>
            <form th:action="@{/logout}" method="post">
                <button type="submit" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-500/20 hover:text-red-300 transition-all text-white/50"><i class="fas fa-sign-out-alt text-sm"></i></button>
            </form>
        </div>
    </div>
</nav>

<main class="flex-1 overflow-y-auto p-10 bg-[#FBFBFD]" id="mainContent">
    <div class="mb-8">
        <h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">통합 문의 및 신고 관리</h2>
        <p class="text-gray-400 mt-2 font-medium">문의와 신고 내역을 통합 관리합니다. 카드를 클릭하여 상태별 필터링이 가능합니다.</p>
    </div>

    <div class="grid grid-cols-4 gap-4 mb-8">
        <div class="summary-card shadow-sm border-l-4 border-l-blue-400"
             th:with="nextType=${currentType == 'INQUIRY' ? 'ALL' : 'INQUIRY'}"
             th:onclick="|location.href='@{/admin/Inquiries(type=${nextType}, status=${currentStatus}, sortField=${sortField}, sortDir=${sortDir}, keyword=${keyword})}'|"
             th:classappend="${currentType == 'INQUIRY'} ? 'active-card' : ''">
            <div>
                <p class="text-gray-400 text-[10px] font-bold mb-1 uppercase tracking-tighter">일반 문의</p>
                <p class="text-blue-600 font-black text-2xl" th:text="${totalInquiryCount ?: 0}">0</p>
            </div>
            <div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-400"><i class="fas fa-question-circle"></i></div>
        </div>
        <div class="summary-card shadow-sm border-l-4 border-l-red-400"
             th:with="nextType=${currentType == 'REPORT' ? 'ALL' : 'REPORT'}"
             th:onclick="|location.href='@{/admin/Inquiries(type=${nextType}, status=${currentStatus}, sortField=${sortField}, sortDir=${sortDir}, keyword=${keyword})}'|"
             th:classappend="${currentType == 'REPORT'} ? 'active-card' : ''">
            <div>
                <p class="text-gray-400 text-[10px] font-bold mb-1 uppercase tracking-tighter">콘텐츠 신고</p>
                <p class="text-red-600 font-black text-2xl" th:text="${totalReportCount ?: 0}">0</p>
            </div>
            <div class="w-10 h-10 bg-red-50 rounded-xl flex items-center justify-center text-red-400"><i class="fas fa-exclamation-triangle"></i></div>
        </div>
        <div class="summary-card shadow-sm border-l-4 border-l-orange-400"
             th:with="nextStatus=${currentStatus == 'N' ? 'ALL' : 'N'}"
             th:onclick="|location.href='@{/admin/Inquiries(type=${currentType}, status=${nextStatus}, sortField=${sortField}, sortDir=${sortDir}, keyword=${keyword})}'|"
             th:classappend="${currentStatus == 'N'} ? 'active-card' : ''">
            <div>
                <p class="text-gray-400 text-[10px] font-bold mb-1 uppercase tracking-tighter">전체 대기</p>
                <p class="text-orange-600 font-black text-2xl" th:text="${totalPendingCount ?: 0}">0</p>
            </div>
            <div class="w-10 h-10 bg-orange-50 rounded-xl flex items-center justify-center text-orange-400"><i class="fas fa-clock"></i></div>
        </div>
        <div class="summary-card shadow-sm border-l-4 border-l-green-400"
             th:with="nextStatus=${currentStatus == 'Y' ? 'ALL' : 'Y'}"
             th:onclick="|location.href='@{/admin/Inquiries(type=${currentType}, status=${nextStatus}, sortField=${sortField}, sortDir=${sortDir}, keyword=${keyword})}'|"
             th:classappend="${currentStatus == 'Y'} ? 'active-card' : ''">
            <div>
                <p class="text-gray-400 text-[10px] font-bold mb-1 uppercase tracking-tighter">전체 완료</p>
                <p class="text-green-600 font-black text-2xl" th:text="${totalResolvedCount ?: 0}">0</p>
            </div>
            <div class="w-10 h-10 bg-green-50 rounded-xl flex items-center justify-center text-green-400"><i class="fas fa-check-double"></i></div>
        </div>
    </div>

    <div class="mb-6 flex justify-end">
        <form th:action="@{/admin/Inquiries}" method="get" class="relative w-full max-w-md flex gap-2">
            <input type="hidden" name="type" th:value="${currentType}">
            <input type="hidden" name="status" th:value="${currentStatus}">
            <input type="hidden" name="sortField" th:value="${sortField}">
            <input type="hidden" name="sortDir" th:value="${sortDir}">
            <div class="relative flex-1">
                <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-gray-400">
                    <i class="fas fa-search text-sm"></i>
                </span>
                <input type="text" name="keyword" th:value="${keyword}"
                       class="w-full bg-white border border-gray-200 rounded-2xl py-3 pl-11 pr-4 text-sm focus:ring-2 focus:ring-[#DCA244]/20 focus:border-main outline-none transition-all shadow-sm"
                       placeholder="작성자 아이디로 검색...">
            </div>
            <button type="submit" class="btn-main shadow-md shadow-[#DCA244]/20">검색</button>
        </form>
    </div>

    <div class="table-container mb-6">
        <table class="w-full text-left">
            <thead>
            <tr>
                <th class="th-style w-24 text-center">통합 ID</th>
                <th class="th-style">유형 / 제목</th>
                <th class="th-style w-32">작성자</th>
                <th class="th-style w-28 text-center">상태</th>
                <th class="th-style w-40 text-center cursor-pointer hover:bg-gray-100"
                    th:with="nextDir=${sortField == 'regDate' && sortDir == 'asc' ? 'desc' : 'asc'}"
                    th:onclick="|location.href='@{/admin/Inquiries(type=${currentType}, status=${currentStatus}, keyword=${keyword}, sortField='regDate', sortDir=${nextDir})}'|">
                    <div class="flex items-center justify-center gap-1">
                        등록일
                        <span class="sort-link">
                            <i class="fas fa-caret-up" th:classappend="${sortField == 'regDate' && sortDir == 'asc'} ? 'active' : ''"></i>
                            <i class="fas fa-caret-down" th:classappend="${sortField == 'regDate' && sortDir == 'desc'} ? 'active' : ''"></i>
                        </span>
                    </div>
                </th>
                <th class="th-style w-40 text-center cursor-pointer hover:bg-gray-100"
                    th:with="nextDir=${sortField == 'resolvedAt' && sortDir == 'asc' ? 'desc' : 'asc'}"
                    th:onclick="|location.href='@{/admin/Inquiries(type=${currentType}, status=${currentStatus}, keyword=${keyword}, sortField='resolvedAt', sortDir=${nextDir})}'|">
                    <div class="flex items-center justify-center gap-1">
                        완료일
                        <span class="sort-link">
                            <i class="fas fa-caret-up" th:classappend="${sortField == 'resolvedAt' && sortDir == 'asc'} ? 'active' : ''"></i>
                            <i class="fas fa-caret-down" th:classappend="${sortField == 'resolvedAt' && sortDir == 'desc'} ? 'active' : ''"></i>
                        </span>
                    </div>
                </th>
                <th class="th-style w-20 text-center">관리</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 text-sm">
            <th:block th:if="${combinedList != null and !combinedList.isEmpty()}">
                <tr th:each="item : ${combinedList}" class="hover:bg-gray-50 transition-colors">
                    <td class="td-style font-mono text-[10px] text-center text-gray-400" th:text="${item.totalId}">ID</td>
                    <td class="td-style">
                        <span th:if="${item.type == 'INQUIRY'}" class="px-2 py-0.5 rounded-md bg-blue-100 text-blue-600 text-[10px] font-bold">문의</span>
                        <span th:if="${item.type == 'REPORT'}" class="px-2 py-0.5 rounded-md bg-red-100 text-red-600 text-[10px] font-bold">신고</span>
                        <div class="font-bold text-gray-800 mt-1 truncate w-48" th:text="${item.title ?: '제목 없음'}">제목</div>
                    </td>
                    <td class="td-style font-medium text-gray-600" th:text="${item.userId ?: '익명'}">작성자</td>
                    <td class="td-style text-center">
                        <span th:if="${item.state == 'Y'}" class="badge-custom badge-done">완료</span>
                        <span th:if="${item.state == 'N'}" class="badge-custom badge-waiting">대기</span>
                    </td>

                    <td class="td-style text-gray-400 text-[11px] text-center"
                        th:text="${item.regDate != null ? #temporals.format(item.regDate, 'yyyy-MM-dd HH:mm') : '-'}">등록일</td>

                    <td class="td-style text-center font-bold text-[11px]" th:classappend="${item.resolvedAt != null ? 'text-blue-500' : 'text-gray-300'}">
                        <span th:text="${item.resolvedAt != null ? #temporals.format(item.resolvedAt, 'yyyy-MM-dd HH:mm') : '-'}">-</span>
                    </td>

                    <td class="td-style text-center">
                        <button type="button" class="action-btn mx-auto"
                                th:data-id="${item.originalId}"
                                th:data-title="${item.title ?: ''}"
                                th:data-type="${item.type ?: ''}"
                                th:data-sub-type="${item.subType ?: ''}"
                                th:data-user="${item.userId ?: '익명'}"
                                th:data-date="${item.regDate != null ? #temporals.format(item.regDate, 'yyyy-MM-dd HH:mm') : ''}"
                                th:data-content="${item.content ?: ''}"
                                th:data-state="${item.state ?: 'N'}"
                                th:data-answer="${item.answer ?: ''}"
                                th:data-files="${item != null ? item.fetchFilesJson() : '[]'}"
                                onclick="openDetailModal(this)">
                            <i th:class="${item.type == 'REPORT' ? 'fas fa-gavel' : 'fas fa-search'} + ' text-xs'"></i>
                        </button>
                    </td>
                </tr>
            </th:block>

            <tr th:if="${combinedList == null or combinedList.isEmpty()}">
                <td colspan="7" class="py-20 text-center text-gray-400">조회된 내역이 없습니다.</td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="flex items-center justify-between bg-white p-4 rounded-2xl border border-gray-100 shadow-sm"
         th:if="${totalPages != null and totalPages > 0}">
        <div class="text-xs font-bold text-gray-400 uppercase tracking-widest">
            Page <span class="text-main" th:text="${currentPage + 1}">1</span> / <span th:text="${totalPages}">1</span>
        </div>
        <div class="flex items-center gap-1">
            <a th:href="@{/admin/Inquiries(type=${currentType}, status=${currentStatus}, keyword=${keyword}, sortField=${sortField}, sortDir=${sortDir}, page=${currentPage - 1})}"
               class="pagination-btn" th:classappend="${currentPage == 0} ? 'disabled' : ''">
                <i class="fas fa-chevron-left text-[10px]"></i>
            </a>
            <th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                <a th:href="@{/admin/Inquiries(type=${currentType}, status=${currentStatus}, keyword=${keyword}, sortField=${sortField}, sortDir=${sortDir}, page=${i})}"
                   th:text="${i + 1}"
                   th:classappend="${i == currentPage} ? 'active' : ''"
                   class="pagination-btn"></a>
            </th:block>
            <a th:href="@{/admin/Inquiries(type=${currentType}, status=${currentStatus}, keyword=${keyword}, sortField=${sortField}, sortDir=${sortDir}, page=${currentPage + 1})}"
               class="pagination-btn" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled' : ''">
                <i class="fas fa-chevron-right text-[10px]"></i>
            </a>
        </div>
        <div class="text-xs font-bold text-gray-400 uppercase tracking-tighter">
            Total Items: [[${totalElements ?: 0}]]
        </div>
    </div>
</main>

<div id="detailModal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden">
        <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
            <div>
                <span id="modalTypeBadge" class="px-2 py-1 rounded-md text-[10px] font-bold">유형</span>
                <h3 id="modalTitle" class="text-xl font-black text-gray-800 mt-1">제목</h3>
            </div>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="p-8 max-h-[70vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6 text-sm text-gray-500">
                <div class="flex items-center gap-2"><i class="fas fa-user-circle"></i> <span id="modalUser">작성자</span></div>
                <div id="modalDate">날짜</div>
            </div>
            <div class="bg-gray-50 rounded-2xl p-6 mb-6 text-gray-700 whitespace-pre-wrap text-sm" id="modalContent"></div>

            <div id="fileSection" class="mb-8 hidden">
                <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2 text-sm">
                    <i class="fas fa-paperclip text-gray-400"></i> 첨부 파일 (클릭 시 다운로드)
                </h4>
                <div id="fileList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
            </div>

            <div id="actionSection" class="border-t border-dashed border-gray-200 pt-8">
                <h4 id="actionTitle" class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-sm"></h4>
                <div id="viewResult" class="hidden">
                    <div class="bg-blue-50 text-blue-800 rounded-2xl p-6 text-sm" id="modalResultText"></div>
                </div>
                <div id="editResult" class="hidden">
                    <form id="modalForm" method="POST">
                        <input type="hidden" name="id" id="hiddenId">
                        <textarea name="content" id="resultInput" rows="5" required
                                  class="w-full border border-gray-200 rounded-2xl p-4 text-sm focus:ring-2 focus:ring-[#DCA244]/20 outline-none"
                                  placeholder="처리 내용을 입력하세요..."></textarea>
                        <div class="flex justify-end mt-4">
                            <button type="submit" class="btn-main">처리 완료하기</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    async function downloadFileSafe(url, fileName) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('파일 다운로드 실패');
            const blob = await response.blob();
            const blobUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(blobUrl);
            document.body.removeChild(a);
        } catch (err) {
            alert(err.message);
        }
    }

    function openDetailModal(button) {
        const d = button.dataset;
        const badge = document.getElementById('modalTypeBadge');
        const form = document.getElementById('modalForm');

        if (d.type === 'REPORT') {
            badge.innerText = `신고: ${d.subType}`;
            badge.className = "px-2 py-1 rounded-md bg-red-100 text-red-600 text-[10px] font-bold";
            document.getElementById('actionTitle').innerHTML = '<i class="fas fa-gavel text-red-500"></i> 신고 처리 결과';
            form.action = '/admin/Reports/resolve';
        } else {
            badge.innerText = `문의: ${d.subType}`;
            badge.className = "px-2 py-1 rounded-md bg-main/10 text-main text-[10px] font-bold";
            document.getElementById('actionTitle').innerHTML = '<i class="fas fa-reply text-main"></i> 운영자 답변';
            form.action = '/admin/Inquiries/answer';
        }

        document.getElementById('modalTitle').innerText = d.title || '-';
        document.getElementById('modalUser').innerText = d.user || '익명';
        document.getElementById('modalDate').innerText = d.date || '-';
        document.getElementById('modalContent').innerText = d.content || '';
        document.getElementById('hiddenId').value = d.id;

        const fileSection = document.getElementById('fileSection');
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        if (d.files && d.files !== '[]' && d.files !== 'null' && d.files.trim() !== '') {
            try {
                const files = JSON.parse(d.files);
                if (Array.isArray(files) && files.length > 0) {
                    fileSection.classList.remove('hidden');
                    files.forEach(file => {
                        if (file && file.url) {
                            const name = file.name || '첨부파일';
                            let downloadUrl = file.url.startsWith('/') ? file.url : '/admin/' + file.url;

                            const fileItem = document.createElement('div');
                            fileItem.className = "cursor-pointer flex items-center gap-3 p-3 bg-white border border-gray-100 rounded-xl hover:border-main hover:text-main transition-all group shadow-sm";
                            fileItem.onclick = () => downloadFileSafe(downloadUrl, name);
                            fileItem.innerHTML = `
                                <div class="w-8 h-8 rounded-lg bg-gray-50 flex items-center justify-center group-hover:bg-main/10">
                                    <i class="fas fa-arrow-down text-gray-400 group-hover:text-main text-xs"></i>
                                </div>
                                <div class="flex flex-col flex-1 overflow-hidden">
                                    <span class="text-[11px] font-bold truncate">${name}</span>
                                    <span class="text-[9px] text-gray-400 uppercase font-medium">Download</span>
                                </div>
                            `;
                            fileList.appendChild(fileItem);
                        }
                    });
                } else { fileSection.classList.add('hidden'); }
            } catch (e) { fileSection.classList.add('hidden'); }
        } else { fileSection.classList.add('hidden'); }

        if (d.state === 'Y') {
            document.getElementById('viewResult').classList.remove('hidden');
            document.getElementById('editResult').classList.add('hidden');
            document.getElementById('modalResultText').innerText = d.answer || "처리가 완료되었습니다.";
        } else {
            document.getElementById('viewResult').classList.add('hidden');
            document.getElementById('editResult').classList.remove('hidden');
            document.getElementById('resultInput').value = '';
        }

        document.getElementById('detailModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('detailModal').classList.add('hidden');
    }

    window.onclick = e => {
        if (e.target.id === 'detailModal') closeModal();
    }
</script>
</body>
</html>