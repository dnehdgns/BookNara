<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <title>장바구니</title>

    <style>
        :root{
            --accent:#DCA244;
            --accent-weak: rgba(220,162,68,.18);
            --line:#e7e7e7;
            --muted:#666;
            --text:#111;
            --chip:#f6f7fb;
            --danger:#e5484d;
            --bg:#fff;

            --card:#ffffff;
            --card2:#fafafa;
        }

        body{ background:var(--bg); }

        .wrap{
            max-width:1100px;
            margin:24px auto;
            padding:0 16px;
        }
        .steps-wrap{ margin: 50px 0 50px; }
        .grid{
            display:flex;
            gap:24px;
            align-items:flex-start;
        }
        .left{ flex:1; }

        /* ===== 상단 타이틀 ===== */
        .page-head{
            display:flex;align-items:center;justify-content:space-between;
            margin:6px 0 12px;
        }

        .page-title{
            margin:0;
            font-size:22px;
            font-weight:900;
            letter-spacing:-0.02em;
            color: var(--accent);
        }


        /* ===== 단계 ===== */
        .steps{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:16px;
            padding:12px 0;
        }
        .step{
            display:flex;align-items:center;gap:10px;
            font-size:18px;font-weight:950;
            color:#9a9a9a;
        }
        .dot{
            width:12px;height:12px;border-radius:50%;
            background:#d7d7d7;
            box-shadow: inset 0 0 0 2px rgba(0,0,0,0.03);
        }
        .step.active{ color: var(--accent); }
        .step.active .dot{ background: var(--accent); }
        .sep{ font-size:18px;font-weight:900;color:#cbb58a; }

        /* ===== 섹션 타이틀 ===== */
        .section-title{
            margin:24px 0 10px;
            font-size:20px;
            font-weight:950;
            display:flex;
            align-items:flex-end;
            gap:10px;
            color: var(--accent);
        }


        /* ✅ 종이책/전자책 사이 간격 */
        .section-gap{
            margin-top:34px;
        }

        /* ===== 아이템 ===== */
        .row{
            display:flex;
            gap:14px;
            padding:14px 0;
            border-bottom:1px solid #f0f0f0;
            align-items:center;
        }
        .thumb-wrap{
            width:92px;
            flex:0 0 92px;
            border-radius:12px;
            overflow:hidden;
            border:1px solid #f0f0f0;
            background:#f3f3f3;
        }
        .thumb{
            width:92px;
            height:128px;
            object-fit:cover;
            display:block;
        }

        .title{
            font-weight:950;
            font-size:15px;
            line-height:1.3;
            color: var(--text);
        }
        .meta{
            color:var(--muted);
            font-size:13px;
            margin-top:6px;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
            max-width:420px;
        }
        .badge{
            display:inline-block;
            font-size:12px;
            padding:3px 10px;
            border-radius:999px;
            margin-top:8px;
            border:1px solid #eee;
            background:#fff;
            color:#666;
            font-weight:800;
        }
        .badge.paper{ border-color: rgba(220,162,68,.35); background: rgba(220,162,68,.10); color:#8a6a22; }
        .badge.ebook{ border-color: rgba(99,188,217,.35); background: rgba(99,188,217,.10); color:#2f6f86; }

        /* ===== 버튼 ===== */
        .btn{
            border:1px solid var(--line);
            background:#fff;
            border-radius:10px;
            padding:8px 12px;
            font-weight:900;
            font-size:13px;
            cursor:pointer;
            transition: transform .06s ease, background .15s ease, border-color .15s ease;
        }
        .btn:active{ transform: translateY(1px); }
        .btn-ghost{
            background: rgba(220,162,68,.10);
            border-color: rgba(220,162,68,.35);
            color: #8a6a22;
        }
        .btn-ghost:hover{
            background: rgba(220,162,68,.16);
            border-color: rgba(220,162,68,.45);
        }
        .btn-danger{
            background:#fff5f5;
            border-color:#ffd2d3;
            color:#b42318;
        }
        .btn-danger:hover{ background:#ffe9ea; border-color:#ffb9bc; }

        /* ===== 우측(최종) ===== */
        .right{
            width:360px;
            height:fit-content;
        }

        .side-card{
            border:1px solid #efefef;
            border-radius:18px;
            background: var(--card);
            padding:16px;
        }

        .side-title{
            margin:0;
            font-size:16px;
            font-weight:950;
            color:var(--text);
            display:flex;
            align-items:center;
            justify-content:space-between;
        }
        .side-title .chip{
            font-size:12px;
            font-weight:950;
            padding:6px 10px;
            border-radius:999px;
            border:1px solid rgba(220,162,68,.35);
            background: rgba(220,162,68,.10);
            color:#8a6a22;
            white-space:nowrap;
        }

        .side-divider{
            margin:12px 0;
            height:1px;
            background:#eee;
            border:0;
        }

        .sum-list{
            border:1px solid #eee;
            border-radius:14px;
            background: var(--card2);
            overflow:hidden;
        }
        .sum-row{
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:10px 12px;
            border-bottom:1px solid #eee;
            font-size:13.5px;
        }
        .sum-row:last-child{ border-bottom:none; }
        .sum-k{ color:#666; font-weight:850; }
        .sum-v{ color:var(--text); font-weight:950; }
        .sum-v.accent{ color: var(--accent); }

        .warn-box{
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(229,72,77,.25);
            background: rgba(229,72,77,.06);
            color: #b42318;
            font-size: 13px;
            font-weight: 800;
            line-height: 1.4;
        }

        .ship-note{
            display:flex;
            align-items:flex-start;
            gap:8px;
            margin-top:10px;
            padding:10px 12px;
            border-radius:14px;
            border:1px solid rgba(220,162,68,.28);
            background: rgba(220,162,68,.08);
            color:#6e5217;
            font-size:12.5px;
            line-height:1.45;
            font-weight:850;
        }
        .ship-note .i{
            width:20px;height:20px;
            border-radius:999px;
            display:flex;align-items:center;justify-content:center;
            font-size:12px;
            background: rgba(220,162,68,.18);
            border:1px solid rgba(220,162,68,.25);
            color:#6e5217;
            flex:0 0 20px;
            margin-top:1px;
        }

        .total-box{
            margin-top:10px;
            padding:12px;
            border-radius:16px;
            border:1px solid #eee;
            background:#fff;
        }
        .total-top{
            display:flex;
            justify-content:space-between;
            align-items:baseline;
            gap:10px;
        }
        .total-label{
            font-weight:950;
            color:#333;
            font-size:14px;
        }
        .total-amt{
            font-weight:1000;
            font-size:22px;
            letter-spacing:-0.02em;
            color: var(--accent);
            white-space:nowrap;
        }
        .total-sub{
            margin-top:6px;
            font-size:12px;
            color:#888;
            line-height:1.45;
        }

        .cta{
            margin-top:12px;
            width:100%;
            border:0;
            border-radius:16px;
            padding:14px;
            background: var(--accent);
            color:#fff;
            font-weight:1000;
            font-size:16px;
            box-shadow: 0 10px 22px rgba(220,162,68,.25);
            cursor:pointer;
        }
        .cta:hover{ filter: brightness(0.98); }
        .cta:disabled{
            background:#e7d4ad;
            cursor:not-allowed;
            box-shadow:none;
        }

        .hint{
            margin-top:10px;
            color:#777;
            font-size:12.5px;
            line-height:1.45;
        }

        .empty-note{
            color:#666;
            padding: 16px 0;
        }

        @media (max-width: 980px){
            .grid{ flex-direction:column; }
            .right{ width:100%; }
            .meta{ max-width: 100%; }
        }
    </style>
</head>

<body>
<div th:replace="fragments/header :: header"></div>

<div class="wrap">

    <div class="steps-wrap">
        <div class="steps">
            <div class="step" th:classappend="${(step == null or step == '' or step == 'CART')} ? ' active'">
                <span class="dot"></span>장바구니
            </div>
            <span class="sep">›</span>
            <div class="step" th:classappend="${step == 'PAY'} ? ' active'">
                <span class="dot"></span>결제하기
            </div>
            <span class="sep">›</span>
            <div class="step" th:classappend="${step == 'DONE'} ? ' active'">
                <span class="dot"></span>주문완료
            </div>
        </div>
    </div>

    <!-- ✅ paper/ebook 리스트를 한 번만 분리해서 재사용 -->
    <div th:with="paperItems=${items.?[ebookYn != 'Y']}, ebookItems=${items.?[ebookYn == 'Y']}">

        <div class="grid">
            <div class="left">
                <div class="page-head">
                    <h2 class="page-title">장바구니</h2>
                    <button class="btn btn-ghost" onclick="clearAll()">전체 비우기</button>
                </div>

                <div th:if="${#lists.isEmpty(items)}" class="empty-note">
                    장바구니가 비어있습니다.
                </div>

                <div th:if="${!#lists.isEmpty(items)}">

                    <!-- 종이책 -->
                    <div class="section-title">종이책</div>
                    <div th:each="it : ${paperItems}" class="row">
                        <div class="thumb-wrap">
                            <img class="thumb"
                                 th:src="${#strings.isEmpty(it.naverImage) ? it.aladinImageBig : it.naverImage}"
                                 alt="cover">
                        </div>

                        <div style="flex:1; min-width:0;">
                            <div class="title" th:text="${it.bookTitle}">제목</div>
                            <div class="meta" th:text="${it.authors}">저자</div>
                            <div class="badge paper">종이책</div>
                        </div>

                        <button class="btn btn-danger"
                                th:attr="data-id=${it.cartId}"
                                onclick="removeItem(this)">삭제</button>
                    </div>

                    <!-- 전자책 -->
                    <div class="section-title section-gap">전자책</div>
                    <div th:each="it : ${ebookItems}" class="row">
                        <div class="thumb-wrap">
                            <img class="thumb"
                                 th:src="${#strings.isEmpty(it.naverImage) ? it.aladinImageBig : it.naverImage}"
                                 alt="cover">
                        </div>

                        <div style="flex:1; min-width:0;">
                            <div class="title" th:text="${it.bookTitle}">제목</div>
                            <div class="meta" th:text="${it.authors}">저자</div>
                            <div class="badge ebook">전자책</div>
                        </div>

                        <button class="btn btn-danger"
                                th:attr="data-id=${it.cartId}"
                                onclick="removeItem(this)">삭제</button>
                    </div>
                </div>
            </div>

            <!-- ✅ 우측 요약(상단 카드 제거, 전자책 배송 문구 제거, 배송비는 고정 3000) -->
            <div class="right">
                <div class="side-card">
                    <h3 class="side-title">
                        결제 요약
                        <span class="chip">대여/결제</span>
                    </h3>

                    <hr class="side-divider"/>

                    <div class="sum-list">
                        <div class="sum-row">
                            <span class="sum-k">최대 대여 가능</span>
                            <span class="sum-v" th:text="${quota != null ? quota.maxLendCount : 5} + '권'">5권</span>
                        </div>

                        <div class="sum-row">
                            <span class="sum-k">현재 대여중</span>
                            <span class="sum-v" th:text="${quota != null ? quota.currentLendCount : 0}">0</span>
                        </div>

                        <div class="sum-row">
                            <span class="sum-k">장바구니 담은 권수</span>
                            <span class="sum-v" th:text="${quota != null ? quota.cartCount : #lists.size(items)}">0</span>
                        </div>

                        <div class="sum-row">
                            <span class="sum-k">내가 대여할 수 있는 권수</span>
                            <span class="sum-v accent" th:text="${quota != null ? quota.availableCount : 5}">5</span>
                        </div>

                        <div class="sum-row">
                            <span class="sum-k">배송비(종이책)</span>
                            <span class="sum-v" th:text="${#lists.isEmpty(paperItems) ? '0원' : '3,000원'}">3,000원</span>
                        </div>
                    </div>

                    <!-- 초과 안내 -->
                    <div class="warn-box"
                         th:if="${quota != null and quota.availableCount < quota.cartCount}">
                        대여 가능 권수를 초과했습니다.<br/>
                        현재 대여중 <span th:text="${quota.currentLendCount}">0</span>권,
                        장바구니 <span th:text="${quota.cartCount}">0</span>권 →<br/>
                        최대 <span th:text="${quota.maxLendCount}">5</span>권을 넘습니다.
                    </div>

                    <!-- 결제 안내(전자책 배송 문구 제거) -->
                    <div class="ship-note">
                        <div class="i">i</div>
                        <div>
                            종이책이 포함되면 <b>배송비 3,000원</b>이 결제페이지에서 부과됩니다.<br/>
                            ‘결제하기’ 클릭 시 결제페이지로 이동합니다.
                        </div>
                    </div>

                    <!-- 총 결제금액(배송비만) -->
                    <div class="total-box">
                        <div class="total-top">
                            <div class="total-label">총 결제금액</div>
                            <div class="total-amt" th:text="${#lists.isEmpty(paperItems) ? '0원' : '3,000원'}">3,000원</div>
                        </div>
                        <div class="total-sub">
                            * 대여료는 무료이며, 종이책 배송비만 결제됩니다.
                        </div>
                    </div>

                    <div class="hint">
                        * 종이책/전자책은 서로 다른 상품이며, 합산 최대 대여 가능 권수 내에서 이용됩니다.
                    </div>

                    <button class="cta"
                            th:disabled="${#lists.isEmpty(items) or (quota != null and quota.availableCount < quota.cartCount)}"
                            onclick="goCheckout()">
                        결제하기
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    function removeItem(btn){
        fetch('/book/cart/remove',{
            method:'POST',
            headers:{'Content-Type':'application/x-www-form-urlencoded'},
            body:'cartId=' + encodeURIComponent(btn.dataset.id)
        }).then(()=>location.reload());
    }
    function clearAll(){
        fetch('/book/cart/clear',{method:'POST'})
            .then(()=>location.reload());
    }
    function goCheckout(){
        location.href='/book/order';
    }
</script>

<div th:replace="fragments/footer :: footer"></div>
</body>
</html>
