<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <title>ì¥ë°”êµ¬ë‹ˆ</title>

    <!-- ================= Bootpay ================= -->
    <script src="https://js.bootpay.co.kr/bootpay-4.2.0.min.js"></script>


    <style>
        :root{
            --accent:#DCA244;
            --accent-weak: rgba(220,162,68,.18);
            --line:#e7e7e7;
            --muted:#666;
            --text:#111;
            --chip:#f6f7fb;
            --danger:#e5484d;
            --bg:#fff;

            --card:#ffffff;
            --card2:#fafafa;
        }

        body{ background:var(--bg); }

        .wrap{
            max-width:1100px;
            margin:24px auto;
            padding:0 16px;
        }
        .steps-wrap{ margin: 50px 0 50px; }
        .grid{
            display:flex;
            gap:24px;
            align-items:flex-start;
        }
        .left{ flex:1; }

        /* ===== ìƒë‹¨ íƒ€ì´í‹€ ===== */
        .page-head{
            display:flex;align-items:center;justify-content:space-between;
            margin:6px 0 12px;
        }

        .page-title{
            margin:0;
            font-size:22px;
            font-weight:900;
            letter-spacing:-0.02em;
            color: var(--accent);
        }

        /* ===== ë‹¨ê³„ ===== */
        .steps{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:16px;
            padding:12px 0;
        }
        .step{
            display:flex;align-items:center;gap:10px;
            font-size:18px;font-weight:950;
            color:#9a9a9a;
        }
        .dot{
            width:12px;height:12px;border-radius:50%;
            background:#d7d7d7;
            box-shadow: inset 0 0 0 2px rgba(0,0,0,0.03);
        }
        .step.active{ color: var(--accent); }
        .step.active .dot{ background: var(--accent); }
        .sep{ font-size:18px;font-weight:900;color:#cbb58a; }

        /* ===== ì„¹ì…˜ íƒ€ì´í‹€ ===== */
        .section-title{
            margin:24px 0 10px;
            font-size:20px;
            font-weight:950;
            display:flex;
            align-items:flex-end;
            gap:10px;
            color: var(--accent);
        }

        /* âœ… ì¢…ì´ì±…/ì „ìì±… ì‚¬ì´ ê°„ê²© */
        .section-gap{
            margin-top:34px;
        }

        /* ===== ì•„ì´í…œ ===== */
        .row{
            display:flex;
            gap:14px;
            padding:14px 0;
            border-bottom:1px solid #f0f0f0;
            align-items:center;
        }
        .thumb-wrap{
            width:92px;
            flex:0 0 92px;
            border-radius:12px;
            overflow:hidden;
            border:1px solid #f0f0f0;
            background:#f3f3f3;
        }
        .thumb{
            width:92px;
            height:128px;
            object-fit:cover;
            display:block;
        }

        .title{
            font-weight:950;
            font-size:15px;
            line-height:1.3;
            color: var(--text);
        }
        .meta{
            color:var(--muted);
            font-size:13px;
            margin-top:6px;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
            max-width:420px;
        }
        .badge{
            display:inline-block;
            font-size:12px;
            padding:3px 10px;
            border-radius:999px;
            margin-top:8px;
            border:1px solid #eee;
            background:#fff;
            color:#666;
            font-weight:800;
        }
        .badge.paper{ border-color: rgba(220,162,68,.35); background: rgba(220,162,68,.10); color:#8a6a22; }
        .badge.ebook{ border-color: rgba(99,188,217,.35); background: rgba(99,188,217,.10); color:#2f6f86; }

        /* ===== ë²„íŠ¼ ===== */
        .btn{
            border:1px solid var(--line);
            background:#fff;
            border-radius:10px;
            padding:8px 12px;
            font-weight:900;
            font-size:13px;
            cursor:pointer;
            transition: transform .06s ease, background .15s ease, border-color .15s ease;
        }
        .btn:active{ transform: translateY(1px); }
        .btn-ghost{
            background: rgba(220,162,68,.10);
            border-color: rgba(220,162,68,.35);
            color: #8a6a22;
        }
        .btn-ghost:hover{
            background: rgba(220,162,68,.16);
            border-color: rgba(220,162,68,.45);
        }
        .btn-danger{
            background:#fff5f5;
            border-color:#ffd2d3;
            color:#b42318;
        }
        .btn-danger:hover{ background:#ffe9ea; border-color:#ffb9bc; }

        /* ===== ìš°ì¸¡ ===== */
        .right{
            width:360px;
            height:fit-content;
        }

        .side-card{
            border:1px solid #efefef;
            border-radius:18px;
            background: var(--card);
            padding:16px;
        }

        .side-title{
            margin:0;
            font-size:16px;
            font-weight:950;
            color:var(--text);
            display:flex;
            align-items:center;
            justify-content:space-between;
        }
        .side-title .chip{
            font-size:12px;
            font-weight:950;
            padding:6px 10px;
            border-radius:999px;
            border:1px solid rgba(220,162,68,.35);
            background: rgba(220,162,68,.10);
            color:#8a6a22;
            white-space:nowrap;
        }

        .side-divider{
            margin:12px 0;
            height:1px;
            background:#eee;
            border:0;
        }

        .sum-list{
            border:1px solid #eee;
            border-radius:14px;
            background: var(--card2);
            overflow:hidden;
        }
        .sum-row{
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:10px 12px;
            border-bottom:1px solid #eee;
            font-size:13.5px;
        }
        .sum-row:last-child{ border-bottom:none; }
        .sum-k{ color:#666; font-weight:850; }
        .sum-v{ color:var(--text); font-weight:950; }
        .sum-v.accent{ color: var(--accent); }

        .warn-box{
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(229,72,77,.25);
            background: rgba(229,72,77,.06);
            color: #b42318;
            font-size: 13px;
            font-weight: 800;
            line-height: 1.4;
        }

        .ship-note{
            display:flex;
            align-items:flex-start;
            gap:8px;
            margin-top:10px;
            padding:10px 12px;
            border-radius:14px;
            border:1px solid rgba(220,162,68,.28);
            background: rgba(220,162,68,.08);
            color:#6e5217;
            font-size:12.5px;
            line-height:1.45;
            font-weight:850;
        }
        .ship-note .i{
            width:20px;height:20px;
            border-radius:999px;
            display:flex;align-items:center;justify-content:center;
            font-size:12px;
            background: rgba(220,162,68,.18);
            border:1px solid rgba(220,162,68,.25);
            color:#6e5217;
            flex:0 0 20px;
            margin-top:1px;
        }

        .total-box{
            margin-top:10px;
            padding:12px;
            border-radius:16px;
            border:1px solid #eee;
            background:#fff;
        }
        .total-top{
            display:flex;
            justify-content:space-between;
            align-items:baseline;
            gap:10px;
        }
        .total-label{
            font-weight:950;
            color:#333;
            font-size:14px;
        }
        .total-amt{
            font-weight:1000;
            font-size:22px;
            letter-spacing:-0.02em;
            color: var(--accent);
            white-space:nowrap;
        }
        .total-sub{
            margin-top:6px;
            font-size:12px;
            color:#888;
            line-height:1.45;
        }

        .cta{
            margin-top:12px;
            width:100%;
            border:0;
            border-radius:16px;
            padding:14px;
            background: var(--accent);
            color:#fff;
            font-weight:1000;
            font-size:16px;
            box-shadow: 0 10px 22px rgba(220,162,68,.25);
            cursor:pointer;
        }
        .cta:hover{ filter: brightness(0.98); }
        .cta:disabled{
            background:#e7d4ad;
            cursor:not-allowed;
            box-shadow:none;
        }

        .hint{
            margin-top:10px;
            color:#777;
            font-size:12.5px;
            line-height:1.45;
        }

        .empty-note{
            color:#666;
            padding: 16px 0;
        }

        @media (max-width: 980px){
            .grid{ flex-direction:column; }
            .right{ width:100%; }
            .meta{ max-width: 100%; }
        }

        /* ===== ë°°ì†¡ì •ë³´ ë²„íŠ¼ ì „ìš© ===== */
        .ship-actions{
            display:flex;
            align-items:center;
            gap:10px;
            margin-bottom:10px;
        }

        /* ì£¼ì†Œê²€ìƒ‰: ê°•ì¡° ë²„íŠ¼ */
        .btn-primary{
            border:1px solid rgba(220,162,68,.45);
            background: var(--accent);
            color:#fff;
            box-shadow: 0 10px 22px rgba(220,162,68,.22);
        }
        .btn-primary:hover{ filter: brightness(0.98); }
        .btn-primary:active{ transform: translateY(1px); }

        /* ê¸°ë³¸ì£¼ì†Œ ì‚¬ìš©: í…ìŠ¤íŠ¸ ë²„íŠ¼(ê²€ì€ ê¸€ì, ë°°ê²½/í…Œë‘ë¦¬ ì—†ìŒ) */
        .btn-text{
            border:0 !important;
            background:transparent !important;
            color:#111 !important;
            padding:8px 6px;         /* ë„ˆë¬´ ì‘ì§€ ì•Šê²Œ */
            border-radius:10px;
            font-weight:900;
        }
        .btn-text:hover{
            background: rgba(0,0,0,.04) !important; /* ì‚´ì§ë§Œ í˜¸ë²„ */
        }

        /* ê¸°ë³¸ì£¼ì†Œë¡œ ì €ì¥: ìš°ì¸¡ìœ¼ë¡œ ë°€ê¸° */
        .btn-save-right{
            margin-left:auto;
        }

        .save-wrap{
            display: flex;
            justify-content: flex-end; /* ğŸ‘‰ ìš°ì¸¡ ë */
            margin-top: 10px;
        }

        /* ===== ëŒ€ì—¬ ê°€ëŠ¥/ë¶ˆê°€ í‘œì‹œ ===== */
        .avail-wrap{
            display:flex;
            justify-content:flex-end;
            margin-top:8px;
        }

        .avail-badge{
            display:inline-flex;
            align-items:center;
            gap:6px;
            font-size:12px;
            font-weight:950;
            padding:6px 10px;
            border-radius:999px;
            border:1px solid #eee;
            background:#fff;
            line-height:1;
            white-space:nowrap;
        }

        .avail-badge .dot{
            width:8px;
            height:8px;
            border-radius:999px;
            background:#bbb;
        }

        /* ê°€ëŠ¥ */
        .avail-badge.ok{
            border-color: rgba(46, 160, 67, .28);
            background: rgba(46, 160, 67, .10);
            color:#1a7f37;
        }
        .avail-badge.ok .dot{ background:#1a7f37; }

        /* ë¶ˆê°€ */
        .avail-badge.no{
            border-color: rgba(229,72,77,.28);
            background: rgba(229,72,77,.10);
            color:#b42318;
        }
        .avail-badge.no .dot{ background:#b42318; }


        /*ê²°ì œë¶ˆê°€ëŠ¥*/
            .cta.is-blocked{
                background:#e7d4ad;   /* disabledì™€ ë™ì¼ í†¤ */
                box-shadow:none;
                cursor:not-allowed;
            }
    </style>

    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body>
<div th:replace="fragments/header :: header"></div>

<div class="wrap">

    <div class="steps">
        <div id="step-cart" class="step" th:classappend="${(step == null or step == '' or step == 'CART')} ? ' active'">
            <span class="dot"></span>ì¥ë°”êµ¬ë‹ˆ
        </div>
        <span class="sep">â€º</span>
        <div id="step-pay" class="step" th:classappend="${step == 'PAY'} ? ' active'">
            <span class="dot"></span>ê²°ì œí•˜ê¸°
        </div>
        <span class="sep">â€º</span>
        <div class="step" th:classappend="${step == 'DONE'} ? ' active'">
            <span class="dot"></span>ì£¼ë¬¸ì™„ë£Œ
        </div>
    </div>

    <!-- âœ… paper/ebook ë¦¬ìŠ¤íŠ¸ë¥¼ í•œ ë²ˆë§Œ ë¶„ë¦¬í•´ì„œ ì¬ì‚¬ìš© -->
    <div th:with="
  paperItems=${items.?[ebookYn != 'Y']},
  ebookItems=${items.?[ebookYn == 'Y']},
  hasUnlendable=${!#lists.isEmpty(items.?[lendableYn == false])},
  hasQuotaExceeded=${quota != null and quota.availableCount < quota.cartCount}
">



    <div class="grid">
            <div class="left">
                <div class="page-head">
                    <h2 class="page-title">ì¥ë°”êµ¬ë‹ˆ</h2>
                    <button class="btn btn-ghost" onclick="clearAll()">ì „ì²´ ë¹„ìš°ê¸°</button>
                </div>

                <div th:if="${#lists.isEmpty(items)}" class="empty-note">
                    ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.
                </div>

                <div th:if="${!#lists.isEmpty(items)}">

                    <!-- ì¢…ì´ì±… -->
                    <div class="section-title">ì¢…ì´ì±…</div>
                    <div th:each="it : ${paperItems}" class="row">
                        <div class="thumb-wrap">
                            <img class="thumb"
                                 th:src="${#strings.isEmpty(it.naverImage) ? it.aladinImageBig : it.naverImage}"
                                 alt="cover">
                        </div>

                        <div style="flex:1; min-width:0;">
                            <div class="title" th:text="${it.bookTitle}">ì œëª©</div>
                            <div class="meta" th:text="${it.authors}">ì €ì</div>
                            <div class="badge paper">ì¢…ì´ì±…</div>
                        </div>

                        <div style="display:flex; flex-direction:column; align-items:flex-end;">
                            <button class="btn btn-danger"
                                    th:attr="data-id=${it.cartId}"
                                    onclick="removeItem(this)">ì‚­ì œ</button>

                            <!-- âœ… ëŒ€ì—¬ ê°€ëŠ¥/ë¶ˆê°€ í‘œì‹œ -->
                            <div class="avail-wrap">
                            <span class="avail-badge ok" th:if="${it.lendableYn}">
                                <span class="dot"></span>ëŒ€ì—¬ê°€ëŠ¥
                            </span>
                                                    <span class="avail-badge no" th:unless="${it.lendableYn}">
                                <span class="dot"></span>ëŒ€ì—¬ë¶ˆê°€
                            </span>
                            </div>
                        </div>

                    </div>

                    <!-- ì „ìì±… -->
                    <div class="section-title section-gap">ì „ìì±…</div>
                    <div th:each="it : ${ebookItems}" class="row">
                        <div class="thumb-wrap">
                            <img class="thumb"
                                 th:src="${#strings.isEmpty(it.naverImage) ? it.aladinImageBig : it.naverImage}"
                                 alt="cover">
                        </div>

                        <div style="flex:1; min-width:0;">
                            <div class="title" th:text="${it.bookTitle}">ì œëª©</div>
                            <div class="meta" th:text="${it.authors}">ì €ì</div>
                            <div class="badge ebook">ì „ìì±…</div>
                        </div>

                        <div style="display:flex; flex-direction:column; align-items:flex-end;">
                            <button class="btn btn-danger"
                                    th:attr="data-id=${it.cartId}"
                                    onclick="removeItem(this)">ì‚­ì œ</button>

                            <!-- âœ… ëŒ€ì—¬ ê°€ëŠ¥/ë¶ˆê°€ í‘œì‹œ -->
                            <div class="avail-wrap">
                            <span class="avail-badge ok" th:if="${it.lendableYn}">
                                <span class="dot"></span>ëŒ€ì—¬ê°€ëŠ¥
                            </span>
                                <span class="avail-badge no" th:unless="${it.lendableYn}">
                                <span class="dot"></span>ëŒ€ì—¬ë¶ˆê°€
                            </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right">
                <!-- âœ… ë°°ì†¡ì •ë³´ -->
                <div class="side-card" id="shipCard"
                     th:if="${!#lists.isEmpty(paperItems)}"
                     style="margin-bottom:12px;">

                    <h3 class="side-title">
                        ë°°ì†¡ì •ë³´
                        <span class="chip" th:text="${#lists.isEmpty(paperItems) ? 'ì „ìì±…ë§Œ' : 'ì¢…ì´ì±… í¬í•¨'}">ì¢…ì´ì±… í¬í•¨</span>
                    </h3>

                    <hr class="side-divider"/>

                    <div class="sum-list" style="padding:12px;">

                        <div class="ship-actions">
                            <button class="btn btn-primary" type="button" onclick="openPostcode()">ì£¼ì†Œê²€ìƒ‰</button>
                            <button class="btn btn-text" type="button" onclick="useDefaultAddr()">ê¸°ë³¸ì£¼ì†Œ ì‚¬ìš©</button>
                        </div>


                        <div style="display:grid; gap:8px;">
                            <input class="btn" style="text-align:left;" id="zip" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
                            <input class="btn" style="text-align:left;" id="addr" placeholder="ê¸°ë³¸ì£¼ì†Œ" readonly>
                            <input class="btn" style="text-align:left;" id="detail" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥">
                        </div>
                        <div class="save-wrap">
                            <button class="btn btn-ghost btn-save-right"
                                    type="button"
                                    onclick="saveDefaultAddr()">
                                ê¸°ë³¸ì£¼ì†Œë¡œ ì €ì¥
                            </button>
                        </div>


                        <div id="addrEmptyMsg" class="warn-box" style="display:none; margin-top:10px;">
                            ì €ì¥ëœ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>

                        <div class="hint" style="margin-top:10px;">
                            * ì¢…ì´ì±…ì´ í¬í•¨ë˜ë©´ ë°°ì†¡ì§€ ì…ë ¥ í›„ ê²°ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>

                <div class="side-card">
                    <h3 class="side-title">
                        ê²°ì œ ìš”ì•½
                        <span class="chip">ëŒ€ì—¬/ê²°ì œ</span>
                    </h3>

                    <hr class="side-divider"/>

                    <div class="sum-list">
                        <div class="sum-row">
                            <span class="sum-k">ìµœëŒ€ ëŒ€ì—¬ ê°€ëŠ¥</span>
                            <span class="sum-v" th:text="${quota != null ? quota.maxLendCount : 5} + 'ê¶Œ'">5ê¶Œ</span>
                        </div>

                        <div class="sum-row">
                            <span class="sum-k">í˜„ì¬ ëŒ€ì—¬ì¤‘</span>
                            <span class="sum-v" th:text="${quota != null ? quota.currentLendCount : 0}">0</span>
                        </div>

                        <div class="sum-row">
                            <span class="sum-k">ì¥ë°”êµ¬ë‹ˆ ë‹´ì€ ê¶Œìˆ˜</span>
                            <span class="sum-v" th:text="${quota != null ? quota.cartCount : #lists.size(items)}">0</span>
                        </div>

                        <div class="sum-row">
                            <span class="sum-k">ë‚´ê°€ ëŒ€ì—¬í•  ìˆ˜ ìˆëŠ” ê¶Œìˆ˜</span>
                            <span class="sum-v accent" th:text="${quota != null ? quota.availableCount : 5}">5</span>
                        </div>

                        <div class="sum-row">
                            <span class="sum-k">ë°°ì†¡ë¹„(ì¢…ì´ì±…)</span>
                            <span class="sum-v" th:text="${#lists.isEmpty(paperItems) ? '0ì›' : '3,000ì›'}">3,000ì›</span>
                        </div>
                    </div>

                    <div class="warn-box"
                         th:if="${quota != null and quota.availableCount < quota.cartCount}">
                        ëŒ€ì—¬ ê°€ëŠ¥ ê¶Œìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.<br/>
                        í˜„ì¬ ëŒ€ì—¬ì¤‘ <span th:text="${quota.currentLendCount}">0</span>ê¶Œ,
                        ì¥ë°”êµ¬ë‹ˆ <span th:text="${quota.cartCount}">0</span>ê¶Œ â†’<br/>
                        ìµœëŒ€ <span th:text="${quota.maxLendCount}">5</span>ê¶Œì„ ë„˜ìŠµë‹ˆë‹¤.
                    </div>

                    <div class="warn-box"
                         th:if="${hasUnlendable}">
                        ëŒ€ì—¬ê°€ ë¶ˆê°€ëŠ¥í•œ ë„ì„œê°€ í¬í•¨ë˜ì–´ìˆìŠµë‹ˆë‹¤.<br/>
                        ëŒ€ì—¬ë¶ˆê°€ ë„ì„œë¥¼ ì‚­ì œí•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
                    </div>


                    <div class="ship-note">
                        <div class="i">i</div>
                        <div>
                            ì¢…ì´ì±…ì´ í¬í•¨ë˜ë©´ <b>ë°°ì†¡ë¹„ 3,000ì›</b>ì´ ê²°ì œí˜ì´ì§€ì—ì„œ ë¶€ê³¼ë©ë‹ˆë‹¤.<br/>
                            â€˜ê²°ì œí•˜ê¸°â€™ í´ë¦­ ì‹œ ê²°ì œí˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
                        </div>
                    </div>

                    <div class="total-box">
                        <div class="total-top">
                            <div class="total-label">ì´ ê²°ì œê¸ˆì•¡</div>
                            <div class="total-amt" th:text="${#lists.isEmpty(paperItems) ? '0ì›' : '3,000ì›'}">3,000ì›</div>
                        </div>
                        <div class="total-sub">
                            * ëŒ€ì—¬ë£ŒëŠ” ë¬´ë£Œì´ë©°, ì¢…ì´ì±… ë°°ì†¡ë¹„ë§Œ ê²°ì œë©ë‹ˆë‹¤.
                        </div>
                    </div>

                    <div class="hint">
                        * ì¢…ì´ì±…/ì „ìì±…ì€ ì„œë¡œ ë‹¤ë¥¸ ìƒí’ˆì´ë©°, í•©ì‚° ìµœëŒ€ ëŒ€ì—¬ ê°€ëŠ¥ ê¶Œìˆ˜ ë‚´ì—ì„œ ì´ìš©ë©ë‹ˆë‹¤.
                    </div>

                    <button id="checkoutBtn"
                            class="cta"
                            type="button"
                            data-label="ê²°ì œí•˜ê¸°"
                            onclick="goCheckout()">ê²°ì œí•˜ê¸°</button>

                </div>
            </div>

        </div>
    </div>
</div>

<script th:inline="javascript">
    /* =========================================
       1. ì‚¬ìš©ì ë° ì´ˆê¸° ë°ì´í„° ì„¤ì •
       ========================================= */
    const loginUser = {
        id: /*[[${#authentication.name}]]*/ '',
        username: /*[[${#authentication.name}]]*/ ''
    };

    // íƒ€ì„ë¦¬í”„ ë³€ìˆ˜ JSë¡œ ë°”ì¸ë”©
    const hasQuotaExceeded = /*[[${quota != null and quota.availableCount < quota.cartCount}]]*/ false;
    const hasUnlendable = /*[[${!#lists.isEmpty(items.?[lendableYn == false])}]]*/ false;
    const hasPaper = /*[[${hasPaper}]]*/ false; // ì¢…ì´ì±… í¬í•¨ ì—¬ë¶€


    /* =========================================
       2. ì¥ë°”êµ¬ë‹ˆ/ì£¼ì†Œ ê´€ë ¨ ê¸°ëŠ¥
       ========================================= */
    // ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ì‚­ì œ
    function removeItem(btn){
        fetch('/book/cart/remove',{
            method:'POST',
            headers:{'Content-Type':'application/x-www-form-urlencoded'},
            body:'cartId=' + encodeURIComponent(btn.dataset.id)
        }).then(()=>location.reload());
    }

    // ì¥ë°”êµ¬ë‹ˆ ì „ì²´ ë¹„ìš°ê¸°
    function clearAll(){
        fetch('/book/cart/clear',{method:'POST'})
            .then(()=>location.reload());
    }

    // ì£¼ì†Œ ì…ë ¥ ìƒíƒœ í™•ì¸ í—¬í¼
    function getAddrState(){
        const zip = document.getElementById('zip')?.value.trim() || '';
        const addr = document.getElementById('addr')?.value.trim() || '';
        const detail = document.getElementById('detail')?.value.trim() || '';
        return { zip, addr, detail, ok: (zip && addr && detail) };
    }

    // ê¸°ë³¸ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
    async function useDefaultAddr(){
        const msg = document.getElementById('addrEmptyMsg');
        if(msg) msg.style.display = 'none';

        const res = await fetch('/book/cart/address/default', { method:'GET' });

        if(res.status === 401){
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            location.href = '/users/login';
            return;
        }

        const json = await res.json();

        if(!json.exists || !json.data){
            if(msg) msg.style.display = 'block';
            // ê°’ ë¹„ìš°ê¸°
            ['zip', 'addr', 'detail'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            syncCheckoutButton();
            return;
        }

        document.getElementById('zip').value = json.data.zipcode || '';
        document.getElementById('addr').value = json.data.addr || '';
        document.getElementById('detail').value = json.data.detailAddr || '';
        syncCheckoutButton();
    }

    // ë‹¤ìŒ ì£¼ì†Œ API
    function openPostcode(){
        if(typeof daum === 'undefined' || !daum.Postcode){
            alert('ì£¼ì†Œ ê²€ìƒ‰ ëª¨ë“ˆ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            return;
        }
        new daum.Postcode({
            oncomplete: function (data) {
                document.getElementById('zip').value = data.zonecode || '';
                const roadAddr = data.roadAddress || data.jibunAddress || '';
                document.getElementById('addr').value = roadAddr;
                document.getElementById('detail').focus();
                syncCheckoutButton();
            }
        }).open();
    }

    // ê¸°ë³¸ì£¼ì†Œë¡œ ì €ì¥
    async function saveDefaultAddr(){
        const st = getAddrState();
        if(!st.zip || !st.addr || !st.detail){
            alert('ì£¼ì†Œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const body = new URLSearchParams({
            zipcode: st.zip,
            addr: st.addr,
            detailAddr: st.detail
        });

        const res = await fetch('/book/cart/address/save-default', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body
        });

        if(res.status === 401){
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            location.href='/users/login';
            return;
        }

        if(!res.ok){
            alert('ê¸°ë³¸ì£¼ì†Œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            return;
        }
        alert('ê¸°ë³¸ì£¼ì†Œë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }


    /* =========================================
       3. ê²°ì œ ë° ëŒ€ì—¬ ë¡œì§ (í•µì‹¬)
       ========================================= */

    // ê²°ì œ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ì²´í¬
    function isCheckoutBlocked(){
        if (hasQuotaExceeded){
            return { blocked:true, msg:'ëŒ€ì—¬ ê°€ëŠ¥ ê¶Œìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.', reason:'ëŒ€ì—¬ê¶Œìˆ˜ ì´ˆê³¼' };
        }
        if (hasUnlendable){
            return { blocked:true, msg:'ëŒ€ì—¬ê°€ ë¶ˆê°€ëŠ¥í•œ ë„ì„œê°€ í¬í•¨ë˜ì–´ìˆìŠµë‹ˆë‹¤.', reason:'ëŒ€ì—¬ë¶ˆê°€ ë„ì„œ í¬í•¨' };
        }
        if (hasPaper){
            const st = getAddrState();
            if (!st.ok){
                return { blocked:true, msg:'ì¢…ì´ì±… ë°°ì†¡ì„ ìœ„í•´ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', reason:'ë°°ì†¡ì§€ ì…ë ¥ í•„ìš”' };
            }
        }
        return { blocked:false, msg:'', reason:'' };
    }

    // ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
    function syncCheckoutButton(){
        const btn = document.getElementById('checkoutBtn');
        if(!btn) return;

        const baseDisabled = (btn.getAttribute('data-base-disabled') === 'true');
        if (baseDisabled) return;

        const guard = isCheckoutBlocked();
        btn.disabled = guard.blocked;

        const defaultLabel = btn.getAttribute('data-label') || 'ê²°ì œí•˜ê¸°';
        if (guard.blocked){
            btn.textContent = `ê²°ì œ ë¶ˆê°€ Â· ${guard.reason}`;
            btn.classList.add('is-blocked');
        } else {
            btn.textContent = defaultLabel;
            btn.classList.remove('is-blocked');
        }
    }

    // [ë©”ì¸ ì§„ì…ì ] ê²°ì œ/ëŒ€ì—¬ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
    async function goCheckout() {
        // 1. ë¡œê·¸ì¸ ì²´í¬ (ì•ˆì „ì¥ì¹˜)
        if (!loginUser.id || loginUser.id.trim() === "") {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            location.href = "/users/login";
            return;
        }

        // 2. ì¢…ì´ì±… í¬í•¨ ì‹œ -> ê²°ì œ ë¡œì§ (Bootpay)
        if (hasPaper) {
            const st = getAddrState();
            if (!st.ok) {
                alert('ì¢…ì´ì±… ë°°ì†¡ì„ ìœ„í•´ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                syncCheckoutButton();
                return;
            }
            requestPayment(); // ê²°ì œì°½ í˜¸ì¶œ
            return;
        }

        // 3. ì „ìì±…ë§Œ ìˆì„ ì‹œ -> ë¬´ë£Œ ëŒ€ì—¬ ë¡œì§
        try {
            const res = await fetch("/book/cart/checkout/free", { method: "POST" });
            const json = await res.json().catch(()=> ({}));

            if (!res.ok || !json.ok) {
                alert(json.message || "ëŒ€ì—¬ ì²˜ë¦¬ ì‹¤íŒ¨");
                return;
            }

            alert("ëŒ€ì—¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.href = "/book/cart"; // í˜¹ì€ ì£¼ë¬¸ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
        } catch (e) {
            console.error(e);
            alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }



    /* =========================================
           Step UI ë³€ê²½ í•¨ìˆ˜
           ========================================= */
    function setStep(stepName) {
        const cartStep = document.getElementById('step-cart');
        const payStep = document.getElementById('step-pay');

        // ë‘˜ ë‹¤ active ì œê±°
        cartStep.classList.remove('active');
        payStep.classList.remove('active');

        // ë‹¨ê³„ë³„ active
        if (stepName === 'CART') {
            cartStep.classList.add('active');
        } else if (stepName === 'PAY') {
            payStep.classList.add('active');
        }
    }

    // [Bootpay] ê²°ì œ ìš”ì²­ í•¨ìˆ˜
    function requestPayment() {
        const username = loginUser.username || loginUser.id;

        setStep('PAY');

        Bootpay.requestPayment({
            application_id: "696053425fd7d0429f0ad118",
            price: 3000,
            order_name: "ë„ì„œ ë°°ì†¡ë¹„",
            order_id: "ORDER_" + Date.now(),
            user: {
                id: loginUser.id,
                username: username
            }
        })
            .then(async function (response) {
                // ê²°ì œ ìŠ¹ì¸ í›„ ë¡œì§
                const receiptId = response.receipt_id || response.receipt_data?.receipt_id;

                try {
                    // 1) ê²°ì œ ì •ë³´ ì €ì¥ (ë¹„ë™ê¸° ì²˜ë¦¬ ì£¼ì˜)
                    await fetch("/payment/complete", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            userId: loginUser.id,
                            receiptId: receiptId
                        })
                    });

                    // 2) ì¹´íŠ¸ ë¹„ìš°ê¸° ë° ëŒ€ì—¬ í™•ì • ì²˜ë¦¬
                    const paidRes = await fetch("/book/cart/checkout/paid", { method: "POST" });
                    const paidJson = await paidRes.json().catch(() => ({}));

                    if (!paidRes.ok || !paidJson.ok) {
                        alert(paidJson.message || "ê²°ì œëŠ” ì„±ê³µí–ˆìœ¼ë‚˜ ëŒ€ì—¬ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
                        return;
                    }

                    alert("ê²°ì œ ë° ëŒ€ì—¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    // ì„±ê³µ ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    location.href = "/book/cart/result"; // ì£¼ë¬¸ì™„ë£Œ í˜ì´ì§€

                } catch (err) {
                    console.error("ì„œë²„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err);
                    alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    setStep('CART');
                }
            })
            .catch(function (e) {
                console.error("Bootpay error:", e);
                // ê²°ì œì°½ ë‹«ê¸°ë‚˜ ì·¨ì†Œ ì‹œì—ëŠ” ì—ëŸ¬ê°€ ì•„ë‹ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë©”ì‹œì§€ ì²˜ë¦¬ ì£¼ì˜
                if(e.event !== 'cancel') {
                    alert("ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    setStep('CART');
                }
            });
    }

    /* =========================================
       4. ì´ˆê¸°í™” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
       ========================================= */
    document.addEventListener('DOMContentLoaded', () => {
        syncCheckoutButton();
    });

    // ì£¼ì†Œ ì…ë ¥ ì‹œ ë²„íŠ¼ ìƒíƒœ ì‹¤ì‹œê°„ ë™ê¸°í™”
    document.addEventListener('input', (e)=>{
        if(e.target && (e.target.id === 'detail' || e.target.id === 'zip' || e.target.id === 'addr')) {
            syncCheckoutButton();
        }
    });

</script>

<div th:replace="fragments/footer :: footer"></div>
</body>
</html>
